<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>FIIRE Studio - AI Sample & Loop Generator</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "brand": "#E85002",
        "brand-hover": "#F16001",
        "bg": "#000000",
        "panel": "#111111",
        "surface": "#1A1A1A",
        "border": "#333333",
        "border-light": "#444444",
        "txt": "#F9F9F9",
        "txt-muted": "#A7A7A7",
        "txt-dim": "#646464",
        "dk-gray": "#333333",
      },
      fontFamily: {
        "display": ["Space Grotesk", "sans-serif"]
      },
    },
  },
}
</script>
<style>
body { font-family: 'Space Grotesk', sans-serif; background: #000; color: #F9F9F9; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #444; }
.glass-effect { backdrop-filter: blur(16px); background-color: rgba(0, 0, 0, 0.88); }
.page { display: none; }
.page.active { display: flex; }
.fill-1 { font-variation-settings: 'FILL' 1; }
.nav-link { transition: all 0.15s; }
.nav-link:hover { background: #1A1A1A; }
.nav-link.active { background: rgba(232, 80, 2, 0.1); color: #E85002; }
.toast {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  background: linear-gradient(135deg, #E85002, #F16001); color: #F9F9F9;
  padding: 10px 24px; border-radius: 12px;
  font-size: 14px; font-weight: 600; z-index: 100; opacity: 0;
  transition: opacity 0.3s; pointer-events: none;
}
.toast.show { opacity: 1; }
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 60; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.animate-fadeIn { animation: fadeIn 0.25s ease-out; }

/* Parameter chips */
.param-chip {
  padding: 5px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
  border: 1px solid #333; background: #1A1A1A; color: #A7A7A7;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.param-chip:hover { border-color: #E85002; color: #F9F9F9; }
.param-chip.active { background: rgba(232, 80, 2, 0.15); border-color: #E85002; color: #E85002; }

/* Variation cards */
.variation-card { transition: all 0.2s ease; }
.variation-card:hover { border-color: #444; }
.variation-card.accepted { border-color: rgba(16, 185, 129, 0.5); background: rgba(16, 185, 129, 0.03); }
.variation-card.rejected { opacity: 0.4; border-color: rgba(239, 68, 68, 0.3); }
.variation-card.rejected canvas { filter: grayscale(0.8); }
.variation-card.playing { border-color: #E85002; box-shadow: 0 0 0 1px #E85002, 0 0 16px rgba(232, 80, 2, 0.15); }

/* Sample cards */
.sample-card { transition: all 0.2s ease; }
.sample-card:hover { transform: translateY(-2px); border-color: #444; }
.sample-card.selected { border-color: #E85002; background: rgba(232, 80, 2, 0.04); }

/* Range sliders */
.range-slider { -webkit-appearance: none; appearance: none; height: 4px; background: #333; border-radius: 4px; outline: none; }
.range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #E85002; border-radius: 50%; cursor: pointer; border: 2px solid #000; }

/* Type badges */
.badge-loop { background: rgba(232, 80, 2, 0.12); color: #E85002; }
.badge-oneshot { background: rgba(59, 130, 246, 0.12); color: #3B82F6; }

/* Batch bar */
.batch-bar { animation: slideUp 0.2s ease-out; }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Generation loading */
@keyframes waveformPulse {
  0%, 100% { opacity: 0.3; transform: scaleY(0.4); }
  50% { opacity: 1; transform: scaleY(1); }
}
.gen-loading-bar {
  width: 3px; height: 24px; border-radius: 2px; background: #E85002;
  display: inline-block; margin: 0 2px;
  animation: waveformPulse 1.2s ease-in-out infinite;
}
.gen-loading-bar:nth-child(2) { animation-delay: 0.1s; }
.gen-loading-bar:nth-child(3) { animation-delay: 0.2s; }
.gen-loading-bar:nth-child(4) { animation-delay: 0.3s; }
.gen-loading-bar:nth-child(5) { animation-delay: 0.4s; }
.gen-loading-bar:nth-child(6) { animation-delay: 0.5s; }
.gen-loading-bar:nth-child(7) { animation-delay: 0.6s; }
.gen-loading-bar:nth-child(8) { animation-delay: 0.7s; }

/* History timeline */
.history-item { position: relative; padding-left: 32px; }
.history-item::before { content: ''; position: absolute; left: 11px; top: 32px; bottom: -16px; width: 2px; background: #333; }
.history-item:last-child::before { display: none; }
.history-dot { position: absolute; left: 4px; top: 8px; width: 16px; height: 16px; border-radius: 50%; border: 2px solid #333; background: #111; }
.history-dot.loop { border-color: #E85002; }
.history-dot.oneshot { border-color: #3B82F6; }

/* BPM input */
input[type="number"]::-webkit-inner-spin-button { opacity: 1; }

/* Sound DNA */
.dna-drop-active { border-color: #E85002 !important; background: rgba(232, 80, 2, 0.05); }
.dna-bar { height: 8px; border-radius: 4px; background: #333; overflow: hidden; }
.dna-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #E85002, #F16001); transition: width 0.6s ease; }
.dna-track-item { animation: fadeIn 0.25s ease-out; }
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(232, 80, 2, 0.2); }
  50% { box-shadow: 0 0 16px 4px rgba(232, 80, 2, 0.15); }
}
.dna-analyzing { animation: pulseGlow 2s ease-in-out infinite; }
</style>
</head>
<body class="antialiased">
<div class="flex h-screen overflow-hidden">

<!-- ==================== SIDEBAR ==================== -->
<aside class="w-64 flex-shrink-0 border-r border-border flex flex-col bg-panel z-10">
  <div class="p-6 pb-3 flex items-center cursor-pointer" onclick="navigateTo('home')">
    <img src="logo.png" alt="FIIRE" class="h-16 w-auto" />
  </div>

  <!-- Project Switcher -->
  <div class="px-4 pb-3 relative">
    <button id="project-switcher" class="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-xl bg-surface border border-border hover:border-border-light transition-colors text-left" onclick="toggleProjectDropdown()">
      <div class="w-7 h-7 rounded-lg bg-brand/15 flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-brand text-[16px]">folder</span>
      </div>
      <div class="flex-1 min-w-0">
        <p id="project-name" class="text-sm font-bold truncate">My Project</p>
        <p id="project-count" class="text-[10px] text-txt-dim">0 samples</p>
      </div>
      <span class="material-symbols-outlined text-txt-dim text-[18px] flex-shrink-0" id="project-chevron">expand_more</span>
    </button>

    <!-- Project dropdown -->
    <div id="project-dropdown" class="hidden absolute left-4 right-4 top-full mt-1 bg-panel border border-border rounded-xl shadow-2xl shadow-black/50 z-50 overflow-hidden">
      <div class="max-h-64 overflow-y-auto py-1" id="project-list">
        <!-- rendered by JS -->
      </div>
      <div class="border-t border-border p-2">
        <div id="new-project-row" class="flex items-center gap-2">
          <button class="flex-1 flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-brand hover:bg-surface transition-colors font-medium" onclick="showNewProjectInput()">
            <span class="material-symbols-outlined text-[16px]">add</span> New Project
          </button>
        </div>
        <div id="new-project-input-row" class="hidden flex items-center gap-2">
          <input id="new-project-input" class="flex-1 bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-txt placeholder:text-txt-dim" placeholder="Project name..." onkeydown="if(event.key==='Enter')confirmNewProject(); if(event.key==='Escape')cancelNewProject();" />
          <button class="p-1.5 text-emerald-400 hover:bg-surface rounded-lg" onclick="confirmNewProject()">
            <span class="material-symbols-outlined text-[16px]">check</span>
          </button>
          <button class="p-1.5 text-txt-dim hover:bg-surface rounded-lg" onclick="cancelNewProject()">
            <span class="material-symbols-outlined text-[16px]">close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <nav class="flex-1 px-4 py-2 flex flex-col gap-1">
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="home" onclick="navigateTo('home')">
      <span class="material-symbols-outlined">home</span>
      <span class="text-sm font-medium">Home</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="generate" onclick="navigateTo('generate')">
      <span class="material-symbols-outlined">music_note</span>
      <span class="text-sm font-medium">Studio</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="library" onclick="navigateTo('library')">
      <span class="material-symbols-outlined">library_music</span>
      <span class="text-sm font-medium">Library</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="sounddna" onclick="navigateTo('sounddna')">
      <span class="material-symbols-outlined">fingerprint</span>
      <span class="text-sm font-medium">Sound DNA</span>
    </a>
    <div class="mt-6 mb-3">
      <p class="px-3 text-[10px] uppercase tracking-widest text-txt-dim font-bold">Collections</p>
    </div>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="favorites" onclick="navigateTo('favorites')">
      <span class="material-symbols-outlined">favorite</span>
      <span class="text-sm font-medium">Favorites</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="history" onclick="navigateTo('history')">
      <span class="material-symbols-outlined">history</span>
      <span class="text-sm font-medium">Generation History</span>
    </a>
  </nav>
  <div class="p-4 border-t border-border space-y-2">
    <button onclick="navigateTo('generate')" class="w-full flex items-center justify-center gap-2 py-3 bg-brand hover:bg-brand-hover text-txt rounded-xl font-bold text-sm shadow-lg shadow-brand/20 transition-all">
      <span class="material-symbols-outlined text-[18px]">add</span>
      New Generation
    </button>
    <button onclick="openSettingsModal()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-txt-muted hover:text-txt hover:bg-surface transition-colors">
      <span class="material-symbols-outlined text-[18px]">settings</span>
      <span class="text-sm font-medium">Settings</span>
    </button>
  </div>
</aside>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="flex-1 flex flex-col min-w-0 overflow-hidden">

<!-- ========== PAGE: HOME ========== -->
<div id="page-home" class="page flex-col flex-1 overflow-hidden">
  <main class="flex-1 overflow-y-auto">
    <div class="max-w-3xl mx-auto px-8 py-12">

      <!-- Greeting -->
      <div class="mb-12">
        <h1 id="home-greeting" class="text-3xl sm:text-4xl font-bold mb-2">Hello!</h1>
        <p class="text-txt-muted text-lg">What are you working on today?</p>
      </div>

      <!-- Quick Actions -->
      <div class="flex gap-4 mb-12">
        <button onclick="navigateTo('generate'); setGenerateMode('loop')" class="flex-1 group bg-panel border border-border rounded-2xl p-6 text-left hover:border-brand transition-colors">
          <div class="w-10 h-10 rounded-xl bg-brand/15 flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-brand">loop</span>
          </div>
          <p class="font-bold text-txt mb-1">Generate Loop</p>
          <p class="text-sm text-txt-muted">Create AI-powered drum loops and patterns</p>
        </button>
        <button onclick="navigateTo('generate'); setGenerateMode('oneshot')" class="flex-1 group bg-panel border border-border rounded-2xl p-6 text-left hover:border-brand transition-colors">
          <div class="w-10 h-10 rounded-xl bg-brand/15 flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-brand">radio_button_checked</span>
          </div>
          <p class="font-bold text-txt mb-1">Generate One-Shot</p>
          <p class="text-sm text-txt-muted">Create single hits, stabs, and percussion</p>
        </button>
        <button onclick="navigateTo('sounddna')" class="flex-1 group bg-panel border border-border rounded-2xl p-6 text-left hover:border-brand transition-colors">
          <div class="w-10 h-10 rounded-xl bg-brand/15 flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-brand">fingerprint</span>
          </div>
          <p class="font-bold text-txt mb-1">Sound DNA</p>
          <p class="text-sm text-txt-muted">Analyze your sound and get a custom sample pack</p>
        </button>
      </div>

      <!-- Projects -->
      <div>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Your Projects</h2>
          <button onclick="startNewProject()" class="text-sm text-brand hover:text-brand-hover font-medium flex items-center gap-1 transition-colors">
            <span class="material-symbols-outlined text-[16px]">add</span> New Project
          </button>
        </div>
        <div id="home-projects" class="space-y-2">
          <!-- rendered by JS -->
        </div>
      </div>

    </div>
  </main>
</div>

<!-- ========== PAGE: STUDIO ========== -->
<div id="page-generate" class="page flex-col flex-1 overflow-hidden">

  <!-- ===== TOP: Prompt-first Generation Bar ===== -->
  <div class="bg-panel border-b border-border flex-shrink-0 px-8 py-6">
    <!-- Hero prompt row -->
    <div class="flex items-center gap-3">
      <!-- Upload reference button -->
      <button id="ref-upload-btn" class="flex-shrink-0 w-12 h-12 rounded-xl bg-bg border border-border hover:border-brand text-txt-dim hover:text-brand flex items-center justify-center transition-colors relative" onclick="document.getElementById('ref-file-input').click()" title="Upload reference audio">
        <span class="material-symbols-outlined text-xl">upload_file</span>
      </button>
      <input id="ref-file-input" type="file" accept="audio/*" class="hidden" onchange="handleRefUpload(this)"/>

      <div class="flex-1 relative">
        <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-txt-dim text-xl">bolt</span>
        <input id="gen-prompt" class="w-full bg-bg border border-border rounded-xl pl-12 pr-4 py-4 text-base text-txt placeholder:text-txt-dim focus:border-brand focus:outline-none transition-colors" placeholder="Describe your sound... e.g. &quot;dusty lo-fi drum loop, 90 BPM&quot;" type="text" onkeydown="if(event.key==='Enter') generateSamples()"/>
      </div>
      <button id="gen-btn" class="bg-brand hover:bg-brand-hover text-txt font-bold px-8 py-4 rounded-xl flex items-center gap-2 text-base transition-all shadow-lg shadow-brand/20 whitespace-nowrap flex-shrink-0" onclick="generateSamples()">
        <span class="material-symbols-outlined text-xl">bolt</span>
        <span id="gen-btn-text">Generate</span>
      </button>
    </div>

    <!-- Reference file indicator (hidden by default) -->
    <div id="ref-indicator" class="hidden flex items-center gap-2 mt-3 ml-15">
      <div class="flex items-center gap-2 bg-brand/10 border border-brand/20 rounded-lg px-3 py-1.5">
        <span class="material-symbols-outlined text-brand text-[16px]">audio_file</span>
        <span id="ref-filename" class="text-xs text-txt font-medium truncate max-w-[200px]"></span>
        <span id="ref-duration" class="text-xs text-txt-muted"></span>
        <button class="text-txt-muted hover:text-txt ml-1 flex items-center" onclick="playReference()" id="ref-play-btn" title="Preview reference">
          <span class="material-symbols-outlined text-[16px]">play_arrow</span>
        </button>
        <button class="text-txt-muted hover:text-red-400 flex items-center" onclick="removeReference()" title="Remove reference">
          <span class="material-symbols-outlined text-[14px]">close</span>
        </button>
      </div>
    </div>

    <!-- Type toggle + expandable params -->
    <div class="flex items-center gap-4">
      <!-- Mode toggle -->
      <div class="flex h-9 items-center rounded-lg bg-bg p-0.5 border border-border flex-shrink-0">
        <label class="flex cursor-pointer h-full items-center justify-center rounded-md px-3 has-[:checked]:bg-surface has-[:checked]:text-txt text-txt-dim text-xs font-medium transition-all">
          <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">loop</span> Loop</span>
          <input checked name="gen-mode" type="radio" value="loop" class="hidden" onchange="setGenerateMode('loop')"/>
        </label>
        <label class="flex cursor-pointer h-full items-center justify-center rounded-md px-3 has-[:checked]:bg-surface has-[:checked]:text-txt text-txt-dim text-xs font-medium transition-all">
          <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">radio_button_checked</span> One-Shot</span>
          <input name="gen-mode" type="radio" value="oneshot" class="hidden" onchange="setGenerateMode('oneshot')"/>
        </label>
      </div>

      <div class="w-px h-6 bg-border flex-shrink-0"></div>

      <!-- Style chips -->
      <div id="style-chips" class="flex gap-1.5 flex-wrap flex-1">
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Dusty</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Clean</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Analog</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Digital</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Lo-fi</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Punchy</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Atmospheric</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Vintage</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Crispy</button>
      </div>

      <div class="w-px h-6 bg-border flex-shrink-0"></div>

      <!-- Tune params toggle -->
      <button id="params-toggle" class="flex items-center gap-1 text-xs text-txt-muted hover:text-txt transition-colors flex-shrink-0" onclick="toggleParams()">
        <span class="material-symbols-outlined text-[16px]" id="params-chevron">tune</span>
        <span id="params-toggle-label">Parameters</span>
      </button>
    </div>

    <!-- Expandable params panel -->
    <div id="params-panel" class="hidden mt-4 pt-4 border-t border-border">
      <!-- Loop params -->
      <div id="loop-params" class="flex items-center gap-6 flex-wrap">
        <div class="flex items-center gap-2">
          <span class="text-xs text-txt-dim uppercase font-bold tracking-wide">BPM</span>
          <input type="number" id="bpm-input" min="60" max="200" value="120" class="w-16 bg-bg border border-border rounded-lg px-2.5 py-1.5 text-sm text-center text-txt" oninput="document.getElementById('bpm-slider').value=this.value"/>
          <input type="range" id="bpm-slider" min="60" max="200" value="120" class="w-24 range-slider" oninput="document.getElementById('bpm-input').value=this.value"/>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-txt-dim uppercase font-bold tracking-wide">Key</span>
          <select id="key-select" class="bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-txt">
            <option>C</option><option>Cm</option><option>C#</option><option>C#m</option>
            <option>D</option><option>Dm</option><option>D#</option><option>D#m</option>
            <option>E</option><option>Em</option>
            <option>F</option><option>Fm</option><option>F#</option><option>F#m</option>
            <option>G</option><option>Gm</option><option>G#</option><option>G#m</option>
            <option>A</option><option>Am</option><option>A#</option><option>A#m</option>
            <option>B</option><option>Bm</option>
          </select>
        </div>
        <div id="length-chips" class="flex gap-1.5">
          <button class="param-chip text-xs" onclick="setLength(2, this)">2 bars</button>
          <button class="param-chip active text-xs" onclick="setLength(4, this)">4 bars</button>
          <button class="param-chip text-xs" onclick="setLength(8, this)">8 bars</button>
          <button class="param-chip text-xs" onclick="setLength(16, this)">16 bars</button>
        </div>
      </div>
      <!-- One-shot params -->
      <div id="oneshot-params" class="hidden items-center gap-6 flex-wrap">
        <div class="flex items-center gap-2">
          <span class="text-xs text-txt-dim uppercase font-bold tracking-wide">Tuning</span>
          <select id="tuning-select" class="bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-txt">
            <option>C2</option><option>C3</option><option>C4</option><option>C5</option>
            <option>D3</option><option>D4</option><option>E3</option><option>E4</option>
            <option>F3</option><option>F4</option><option>G3</option><option>G4</option>
            <option>A3</option><option>A4</option><option>B3</option><option>B4</option>
          </select>
        </div>
        <div id="attack-chips" class="flex gap-1.5">
          <button class="param-chip active text-xs" onclick="toggleChip(this, 'attack-chips')">Snappy</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'attack-chips')">Soft</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'attack-chips')">Transient</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'attack-chips')">Punchy</button>
        </div>
        <div id="timbre-chips" class="flex gap-1.5">
          <button class="param-chip active text-xs" onclick="toggleChip(this, 'timbre-chips')">Warm</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'timbre-chips')">Bright</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'timbre-chips')">Dark</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'timbre-chips')">Metallic</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== BOTTOM: Workspace grid + Inspector ===== -->
  <div class="flex flex-1 min-h-0 overflow-hidden">
    <!-- Main workspace area -->
    <main id="gen-center" class="flex-1 bg-bg flex flex-col min-w-0 overflow-hidden">
      <!-- Workspace toolbar -->
      <div class="flex items-center justify-between px-8 py-4">
        <h3 class="text-base font-bold text-txt">Results</h3>
        <span id="gen-var-count" class="text-xs text-txt-dim"></span>
      </div>

      <!-- Loading state -->
      <div id="gen-loading" class="hidden flex flex-col items-center justify-center py-16">
        <div class="flex items-end gap-[2px] mb-4">
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
        </div>
        <p class="text-txt-muted font-medium text-sm">Generating variations...</p>
        <p class="text-txt-dim text-xs mt-1">This usually takes 5-10 seconds</p>
      </div>

      <!-- Workspace grid / stack -->
      <div class="flex-1 overflow-y-auto px-6 pb-28">
        <div id="var-grid"></div>

        <!-- Empty state -->
        <div id="gen-empty" class="flex flex-col items-center justify-center py-24">
          <span class="material-symbols-outlined text-6xl text-brand/30 mb-4">bolt</span>
          <p class="text-txt-muted font-medium text-lg">Ready when you are</p>
          <p class="text-txt-dim text-sm mt-1">Pick your vibe above and hit Generate</p>
        </div>

      </div>
    </main>

    <!-- Right panel: Sample Inspector -->
    <aside id="inspector-panel" class="w-[320px] bg-panel border-l border-border flex-col h-full overflow-y-auto flex-shrink-0" style="display:none;">
      <div class="relative">
        <button class="absolute top-3 right-3 z-10 w-7 h-7 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center text-txt transition-colors" onclick="closeInspector()">
          <span class="material-symbols-outlined text-[16px]">close</span>
        </button>
        <div class="p-3 bg-bg">
          <canvas id="inspector-waveform" class="w-full h-28 rounded-lg"></canvas>
        </div>
      </div>
      <div class="p-4 space-y-4">
        <!-- Sample info -->
        <div>
          <h3 id="inspector-title" class="text-base font-bold">Variation 1</h3>
          <div class="flex items-center gap-2 mt-1">
            <span id="inspector-type-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase badge-loop">Loop</span>
            <span id="inspector-meta" class="text-xs text-txt-muted">120 BPM / Cm / 4 bars</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-1.5">
          <button class="flex items-center gap-1 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="playSampleFromInspector()">
            <span class="material-symbols-outlined text-[16px] fill-1" id="inspector-play-icon">play_arrow</span> Play
          </button>
          <button id="inspector-loop-btn" class="flex items-center gap-1 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors text-txt-muted" onclick="toggleLoopPlayback()">
            <span class="material-symbols-outlined text-[16px]">loop</span>
          </button>
          <button class="bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="downloadSample(state.inspectedSample)">
            <span class="material-symbols-outlined text-[16px]">download</span>
          </button>
          <button class="bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="toggleSampleFavorite(state.inspectedSample)">
            <span class="material-symbols-outlined text-[16px]" id="inspector-fav-icon">favorite</span>
          </button>
          <button class="ml-auto bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="batchFromSample()">
            <span class="material-symbols-outlined text-[16px]">auto_awesome</span>
          </button>
        </div>

        <!-- Tags -->
        <div>
          <h4 class="text-[10px] font-semibold text-txt-muted uppercase tracking-wider mb-1.5">Tags</h4>
          <div id="inspector-tags" class="flex flex-wrap gap-1"></div>
        </div>

        <!-- Notes -->
        <div>
          <h4 class="text-[10px] font-semibold text-txt-muted uppercase tracking-wider mb-1.5">Notes</h4>
          <textarea id="inspector-notes" class="w-full h-14 rounded-lg bg-bg border border-border focus:border-brand focus:ring-1 focus:ring-brand p-2 text-txt text-[11px] resize-none placeholder:text-txt-dim" placeholder="Add notes..." oninput="updateSampleNotes()"></textarea>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- ========== PAGE: LIBRARY ========== -->
<div id="page-library" class="page flex-col flex-1 overflow-hidden">
  <header class="flex flex-wrap items-center justify-between gap-4 px-8 pt-6 pb-4">
    <div>
      <h2 class="text-3xl font-black tracking-tight">Sample Library</h2>
      <p class="text-txt-muted text-sm">Your accepted samples and loops.</p>
    </div>
    <div class="flex items-center gap-3">
      <button class="flex items-center gap-2 bg-surface text-txt px-4 py-2 rounded-lg text-sm font-bold border border-border hover:bg-dk-gray transition-colors" onclick="openImportModal()">
        <span class="material-symbols-outlined text-[18px]">upload</span> Import
      </button>
      <button class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-txt px-4 py-2 rounded-lg text-sm font-bold transition-all" onclick="navigateTo('generate')">
        <span class="material-symbols-outlined text-[18px]">magic_button</span> Generate New
      </button>
    </div>
  </header>
  <!-- Filters -->
  <div class="px-8 pb-4 flex flex-wrap items-center gap-3">
    <div class="relative flex-1 max-w-xs">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[20px]">search</span>
      <input id="lib-search" class="w-full bg-surface border border-border rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search library..." type="text" oninput="renderLibrary()"/>
    </div>
    <div class="flex gap-2">
      <button class="param-chip active text-[11px]" onclick="setLibType('all', this)">All</button>
      <button class="param-chip text-[11px]" onclick="setLibType('loop', this)">Loops</button>
      <button class="param-chip text-[11px]" onclick="setLibType('oneshot', this)">One-Shots</button>
    </div>
    <select id="lib-key-filter" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderLibrary()">
      <option value="all">All Keys</option>
      <option>C</option><option>Cm</option><option>D</option><option>Dm</option><option>E</option><option>Em</option>
      <option>F</option><option>Fm</option><option>G</option><option>Gm</option><option>A</option><option>Am</option><option>B</option><option>Bm</option>
    </select>
    <select id="lib-sort" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderLibrary()">
      <option value="recent">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="name">Name A-Z</option>
      <option value="bpm">BPM</option>
    </select>
    <div class="flex gap-1 ml-auto">
      <button id="lib-grid-btn" class="p-2 rounded-lg bg-surface border border-border text-brand" onclick="setLibView('grid')">
        <span class="material-symbols-outlined text-[18px]">grid_view</span>
      </button>
      <button id="lib-list-btn" class="p-2 rounded-lg text-txt-muted hover:text-txt hover:bg-surface transition-colors" onclick="setLibView('list')">
        <span class="material-symbols-outlined text-[18px]">view_list</span>
      </button>
    </div>
  </div>
  <!-- Content -->
  <div class="flex-1 overflow-auto px-8 pb-32">
    <div id="lib-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="lib-list" class="hidden bg-panel rounded-xl border border-border overflow-hidden">
      <table class="w-full text-left border-collapse">
        <thead><tr class="bg-surface">
          <th class="px-4 py-3 w-10"><input type="checkbox" class="rounded border-border" onchange="toggleSelectAll(this)"/></th>
          <th class="px-4 py-3 text-xs font-semibold">Sample</th>
          <th class="px-4 py-3 text-xs font-semibold">Type</th>
          <th class="px-4 py-3 text-xs font-semibold">Key</th>
          <th class="px-4 py-3 text-xs font-semibold">BPM</th>
          <th class="px-4 py-3 text-xs font-semibold">Duration</th>
          <th class="px-4 py-3 text-xs font-semibold text-right">Actions</th>
        </tr></thead>
        <tbody id="lib-tbody" class="divide-y divide-border"></tbody>
      </table>
    </div>
    <div id="lib-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl mt-4">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">library_music</span>
      <p class="text-txt-muted font-medium">Your library is empty</p>
      <p class="text-txt-dim text-sm">Accept generated samples to add them here.</p>
    </div>
  </div>
  <!-- Batch bar -->
  <div id="lib-batch-bar" class="hidden batch-bar fixed left-64 right-0 z-40 flex items-center justify-between px-8 py-3 bg-panel border-t border-border" style="bottom: 64px;">
    <span class="text-sm font-bold"><span id="batch-count">0</span> samples selected</span>
    <div class="flex items-center gap-3">
      <button class="flex items-center gap-2 bg-surface border border-border text-txt px-4 py-2 rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="favoriteSelected()">
        <span class="material-symbols-outlined text-[18px]">favorite</span> Favorite
      </button>
      <button class="flex items-center gap-2 text-red-400 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500/10 transition-colors" onclick="deleteSelected()">
        <span class="material-symbols-outlined text-[18px]">delete</span> Delete
      </button>
    </div>
  </div>
</div>

<!-- ========== PAGE: FAVORITES ========== -->
<div id="page-favorites" class="page flex-col flex-1 overflow-hidden">
  <header class="flex flex-wrap items-center justify-between gap-4 px-8 pt-6 pb-4">
    <div class="flex items-center gap-3">
      <span class="material-symbols-outlined text-brand text-3xl fill-1">favorite</span>
      <div>
        <h2 class="text-3xl font-black tracking-tight">Favorites</h2>
        <p class="text-txt-muted text-sm"><span id="fav-count">0</span> favorited samples</p>
      </div>
    </div>
  </header>
  <div class="px-8 pb-4 flex flex-wrap items-center gap-3">
    <div class="relative flex-1 max-w-xs">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[20px]">search</span>
      <input id="fav-search" class="w-full bg-surface border border-border rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search favorites..." type="text" oninput="renderFavorites()"/>
    </div>
    <select id="fav-sort" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderFavorites()">
      <option value="fav-recent">Recently Favorited</option>
      <option value="recent">Newest Created</option>
      <option value="name">Name A-Z</option>
      <option value="bpm">BPM</option>
    </select>
  </div>
  <div class="flex-1 overflow-auto px-8 pb-28">
    <div id="fav-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="fav-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block fill-1">favorite</span>
      <p class="text-txt-muted font-medium">No favorites yet</p>
      <p class="text-txt-dim text-sm">Click the heart icon on any sample to add it here.</p>
    </div>
  </div>
</div>

<!-- ========== PAGE: HISTORY ========== -->
<div id="page-history" class="page flex-col flex-1 overflow-hidden">
  <header class="px-8 pt-6 pb-4">
    <h2 class="text-3xl font-black tracking-tight">Generation History</h2>
    <p class="text-txt-muted text-sm">Review your previous generation sessions.</p>
  </header>
  <div class="px-8 pb-4 flex items-center gap-3">
    <div class="relative flex-1 max-w-xs">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[20px]">search</span>
      <input id="hist-search" class="w-full bg-surface border border-border rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search history..." type="text" oninput="renderHistory()"/>
    </div>
    <select id="hist-type-filter" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderHistory()">
      <option value="all">All Types</option>
      <option value="loop">Loops</option>
      <option value="oneshot">One-Shots</option>
      <option value="dna-pack">DNA Packs</option>
    </select>
  </div>
  <div class="flex-1 overflow-auto px-8 pb-28">
    <div id="hist-timeline" class="space-y-4"></div>
    <div id="hist-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">history</span>
      <p class="text-txt-muted font-medium">No generation history yet</p>
      <p class="text-txt-dim text-sm">Your generation sessions will appear here.</p>
    </div>
  </div>
</div>

<!-- ========== PAGE: SOUND DNA ========== -->
<div id="page-sounddna" class="page flex-col flex-1 overflow-hidden">
  <header class="px-8 pt-6 pb-4">
    <div class="flex items-center gap-3">
      <span class="material-symbols-outlined text-brand text-3xl">fingerprint</span>
      <div>
        <h2 class="text-3xl font-black tracking-tight">Sound DNA</h2>
        <p class="text-txt-muted text-sm">Upload your tracks to discover your sound profile and generate a personalized sample pack.</p>
      </div>
    </div>
  </header>

  <div class="flex-1 overflow-y-auto px-8 pb-28">
    <!-- STEP 1: Upload Zone -->
    <div id="dna-upload-section" class="mb-8">
      <h3 class="text-lg font-bold mb-3">1. Upload Your Tracks</h3>
      <p class="text-sm text-txt-muted mb-4">Drop 2â€“10 tracks (WAV or MP3) that represent your sound. More tracks = better profile.</p>

      <div id="dna-drop-zone" class="border-2 border-dashed border-border rounded-2xl p-12 text-center hover:border-brand transition-colors cursor-pointer relative"
           onclick="document.getElementById('dna-file-input').click()">
        <input id="dna-file-input" type="file" accept="audio/wav,audio/mp3,audio/mpeg,audio/x-wav" multiple class="hidden" onchange="handleDnaFileSelect(this)"/>
        <span class="material-symbols-outlined text-5xl text-txt-dim mb-3 block">cloud_upload</span>
        <p class="text-txt-muted font-medium text-lg">Drop tracks here or click to browse</p>
        <p class="text-txt-dim text-sm mt-1">WAV or MP3, up to 10 files</p>
      </div>

      <div id="dna-track-list" class="hidden mt-4 space-y-2"></div>
      <div id="dna-track-actions" class="hidden mt-3 flex items-center justify-between">
        <span class="text-sm text-txt-muted"><span id="dna-track-count">0</span> tracks loaded</span>
        <div class="flex gap-3">
          <button class="text-sm text-red-400 hover:text-red-300" onclick="clearDnaTracks()">Clear All</button>
          <button id="dna-analyze-btn" class="bg-brand hover:bg-brand-hover text-txt font-bold px-6 py-2.5 rounded-xl flex items-center gap-2 text-sm transition-all shadow-lg shadow-brand/20"
                  onclick="analyzeDnaTracks()">
            <span class="material-symbols-outlined text-[18px]">analytics</span> Analyze My Sound
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 2: Analysis Progress -->
    <div id="dna-analysis-section" class="hidden mb-8">
      <h3 class="text-lg font-bold mb-3">2. Analyzing Your Sound</h3>
      <div id="dna-progress-container" class="bg-panel border border-border rounded-2xl p-6 dna-analyzing">
        <div id="dna-progress-tracks" class="space-y-3"></div>
        <div class="mt-4">
          <div class="flex justify-between text-xs text-txt-muted mb-1">
            <span id="dna-progress-label">Analyzing...</span>
            <span id="dna-progress-pct">0%</span>
          </div>
          <div class="w-full h-2 bg-bg rounded-full overflow-hidden">
            <div id="dna-progress-bar" class="h-full bg-brand rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 3: Sound Profile Display -->
    <div id="dna-profile-section" class="hidden mb-8">
      <h3 class="text-lg font-bold mb-3">3. Your Sound Profile</h3>
      <div class="bg-panel border border-border rounded-2xl p-6">
        <div class="flex items-center gap-4 mb-6">
          <div class="w-20 h-20 rounded-2xl bg-brand/15 flex items-center justify-center flex-shrink-0">
            <span class="material-symbols-outlined text-brand text-4xl">fingerprint</span>
          </div>
          <div>
            <h4 id="dna-profile-title" class="text-xl font-bold"></h4>
            <p id="dna-profile-subtitle" class="text-sm text-txt-muted"></p>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-6 mb-6">
          <div id="dna-characteristics" class="space-y-3"></div>
          <div>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <span class="text-xs text-txt-dim uppercase font-bold w-20">BPM Range</span>
                <span id="dna-bpm" class="text-sm font-bold text-brand"></span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-txt-dim uppercase font-bold w-20">Key</span>
                <span id="dna-key" class="text-sm font-bold text-brand"></span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-txt-dim uppercase font-bold w-20">Energy</span>
                <span id="dna-energy" class="text-sm font-bold text-brand"></span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-txt-dim uppercase font-bold w-20">Texture</span>
                <span id="dna-texture" class="text-sm font-bold text-brand"></span>
              </div>
            </div>
            <div class="mt-4">
              <span class="text-[10px] text-txt-dim uppercase font-bold tracking-wider">Descriptors</span>
              <div id="dna-tags" class="flex flex-wrap gap-1.5 mt-2"></div>
            </div>
          </div>
        </div>

        <div class="border-t border-border pt-4 flex items-center justify-between">
          <div>
            <p class="text-sm font-bold">Generate your personalized sample pack</p>
            <p class="text-xs text-txt-muted">16 samples across drums, bass, melodic, and textures</p>
          </div>
          <button id="dna-generate-btn" class="bg-brand hover:bg-brand-hover text-txt font-bold px-8 py-3 rounded-xl flex items-center gap-2 text-base transition-all shadow-lg shadow-brand/20"
                  onclick="generateDnaPack()">
            <span class="material-symbols-outlined text-xl">auto_awesome</span> Generate My Pack
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 4: Generated Pack Results -->
    <div id="dna-results-section" class="hidden mb-8">
      <h3 class="text-lg font-bold mb-3">4. Your Sound DNA Pack</h3>

      <div id="dna-gen-loading" class="hidden flex flex-col items-center justify-center py-16">
        <div class="flex items-end gap-[2px] mb-4">
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
        </div>
        <p class="text-txt-muted font-medium text-sm">Generating your personalized pack...</p>
        <p id="dna-gen-progress" class="text-txt-dim text-xs mt-1">0 of 16 samples</p>
      </div>

      <div id="dna-results-grid" class="space-y-6"></div>

      <div id="dna-results-actions" class="hidden mt-6 flex items-center gap-3">
        <button class="bg-emerald-500/15 text-emerald-400 font-bold px-6 py-2.5 rounded-xl text-sm hover:bg-emerald-500/25 transition-colors flex items-center gap-2"
                onclick="acceptAllDnaSamples()">
          <span class="material-symbols-outlined text-[18px]">check_circle</span> Accept All to Library
        </button>
        <button class="bg-surface border border-border text-txt font-bold px-6 py-2.5 rounded-xl text-sm hover:bg-dk-gray transition-colors flex items-center gap-2"
                onclick="navigateTo('library')">
          <span class="material-symbols-outlined text-[18px]">library_music</span> Go to Library
        </button>
      </div>
    </div>
  </div>
</div>

</div>

<!-- ==================== PLAYER BAR ==================== -->
<footer id="player-bar" class="fixed bottom-0 left-0 right-0 z-50 glass-effect border-t border-border px-6 py-3" style="display:none;">
  <div class="flex items-center gap-6">
    <div class="flex items-center gap-3 w-48 flex-shrink-0">
      <div class="w-10 h-10 rounded-lg bg-surface overflow-hidden flex-shrink-0">
        <canvas id="player-mini-waveform" width="40" height="40"></canvas>
      </div>
      <div class="min-w-0">
        <p id="player-title" class="font-bold text-xs truncate">Sample</p>
        <p id="player-meta" class="text-[10px] text-txt-muted truncate">120 BPM / Cm</p>
      </div>
    </div>
    <div class="flex-1 flex items-center gap-3">
      <button id="btn-play" class="w-10 h-10 rounded-full bg-brand text-txt flex items-center justify-center hover:bg-brand-hover transition-all flex-shrink-0" onclick="togglePlayPause()">
        <span class="material-symbols-outlined text-[24px] fill-1">play_arrow</span>
      </button>
      <button id="btn-loop" class="text-txt-muted hover:text-txt transition-colors flex-shrink-0" onclick="toggleLoopPlayback()">
        <span class="material-symbols-outlined text-[20px]">loop</span>
      </button>
      <span id="player-current-time" class="text-[10px] font-mono text-txt-dim w-8 text-right flex-shrink-0">0:00</span>
      <div class="flex-1 h-10 relative cursor-pointer" onclick="seekSample(event)">
        <canvas id="player-waveform" class="w-full h-full"></canvas>
      </div>
      <span id="player-total-time" class="text-[10px] font-mono text-txt-dim w-8 flex-shrink-0">0:00</span>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <button id="player-fav-btn" class="text-txt-muted hover:text-brand transition-colors" onclick="togglePlayerFav()">
        <span class="material-symbols-outlined text-[20px]">favorite</span>
      </button>
      <button class="text-txt-muted hover:text-txt transition-colors" onclick="downloadSample(state.currentSample)">
        <span class="material-symbols-outlined text-[20px]">download</span>
      </button>
      <div class="flex items-center gap-2">
        <button onclick="toggleMute()" class="text-txt-muted hover:text-txt"><span id="volume-icon" class="material-symbols-outlined text-[20px]">volume_up</span></button>
        <input id="volume-slider" type="range" min="0" max="100" value="66" class="w-16 range-slider" oninput="setVolume(this.value)"/>
      </div>
    </div>
  </div>
</footer>

</div>

<div id="toast" class="toast"></div>

<!-- Reject feedback modal -->
<div id="reject-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border rounded-2xl p-6 w-full max-w-sm animate-fadeIn">
    <h3 class="text-lg font-bold mb-3">Why reject this sample?</h3>
    <div class="space-y-2 mb-4">
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('too_muddy')">Too muddy</button>
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('wrong_feel')">Wrong feel</button>
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('too_busy')">Too busy</button>
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('low_quality')">Low quality</button>
    </div>
    <button class="text-txt-dim text-sm hover:text-txt" onclick="submitReject('skip')">Skip feedback</button>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirm-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border rounded-2xl p-6 w-full max-w-sm animate-fadeIn">
    <h3 id="confirm-title" class="text-lg font-bold mb-2"></h3>
    <p id="confirm-msg" class="text-sm text-txt-muted mb-5"></p>
    <div class="flex gap-3">
      <button class="flex-1 py-2 bg-surface border border-border rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="closeModal()">Cancel</button>
      <button id="confirm-action" class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-bold text-txt transition-colors">Confirm</button>
    </div>
  </div>
</div>

<!-- Import from Project modal -->
<div id="import-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border rounded-2xl w-full max-w-lg animate-fadeIn flex flex-col max-h-[80vh]">
    <div class="p-6 pb-4 border-b border-border">
      <h3 class="text-lg font-bold mb-3">Import from Project</h3>
      <select id="import-project-select" class="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderImportList()">
        <option value="">Select a project...</option>
      </select>
    </div>
    <div class="flex-1 overflow-y-auto p-4" id="import-sample-list">
      <p class="text-sm text-txt-dim text-center py-8">Select a project to see its samples</p>
    </div>
    <div class="p-4 border-t border-border flex items-center justify-between">
      <span class="text-sm text-txt-muted"><span id="import-selected-count">0</span> selected</span>
      <div class="flex gap-3">
        <button class="px-4 py-2 bg-surface border border-border rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="closeModal()">Cancel</button>
        <button id="import-btn" class="px-4 py-2 bg-brand hover:bg-brand-hover rounded-lg text-sm font-bold text-txt transition-colors" onclick="importSelectedSamples()">Import Selected</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div id="settings-modal" class="modal-overlay" onclick="if(event.target===this)closeSettingsModal()">
  <div class="bg-panel border border-border rounded-2xl w-full max-w-md animate-fadeIn">
    <div class="p-6 pb-4 border-b border-border flex items-center justify-between">
      <h3 class="text-lg font-bold">Settings</h3>
      <button class="w-7 h-7 rounded-full bg-surface hover:bg-dk-gray flex items-center justify-center text-txt-muted hover:text-txt transition-colors" onclick="closeSettingsModal()">
        <span class="material-symbols-outlined text-[16px]">close</span>
      </button>
    </div>
    <div class="p-6 space-y-5">
      <!-- API Key Section -->
      <div>
        <label class="block text-sm font-bold mb-2">ElevenLabs API Key</label>
        <p class="text-xs text-txt-muted mb-3">Required for AI-generated samples. Get a key at <a href="https://elevenlabs.io/developers" target="_blank" class="text-brand hover:underline">elevenlabs.io/developers</a></p>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <input id="settings-api-key" type="password" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-sm text-txt placeholder:text-txt-dim pr-10 font-mono" placeholder="xi_..." />
            <button class="absolute right-2 top-1/2 -translate-y-1/2 text-txt-dim hover:text-txt p-1" onclick="toggleApiKeyVisibility()">
              <span class="material-symbols-outlined text-[18px]" id="api-key-eye">visibility_off</span>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="api-test-btn" class="flex items-center gap-2 bg-surface border border-border text-txt px-4 py-2 rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="testApiKey()">
            <span class="material-symbols-outlined text-[16px]">bolt</span>
            <span id="api-test-label">Test Connection</span>
          </button>
          <button class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-txt px-4 py-2 rounded-lg text-sm font-bold transition-colors" onclick="saveApiKey()">
            <span class="material-symbols-outlined text-[16px]">save</span> Save
          </button>
          <div id="api-status" class="flex items-center gap-1.5 ml-auto"></div>
        </div>
      </div>
      <!-- Divider -->
      <div class="border-t border-border"></div>
      <!-- Clear Data -->
      <div>
        <label class="block text-sm font-bold mb-1">Data</label>
        <p class="text-xs text-txt-muted mb-3">Clear all local data including samples, projects, and audio.</p>
        <button class="flex items-center gap-2 text-red-400 border border-red-500/30 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500/10 transition-colors" onclick="clearAllDataConfirm()">
          <span class="material-symbols-outlined text-[16px]">delete_forever</span> Clear All Data
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== API CONFIG ====================
let ELEVENLABS_API_KEY = localStorage.getItem('fiire_api_key') || '';

// ==================== STATE ====================
const state = {
  currentPage: 'dashboard',
  generateMode: 'loop',
  isPlaying: false,
  currentSample: null,
  inspectedSample: null,
  currentTime: 0,
  totalTime: 0,
  volume: 66,
  isMuted: false,
  loopPlayback: false,
  progressInterval: null,
  generating: false,
  selectedSamples: new Set(),
  libraryView: 'grid',
  libraryType: 'all',
  rejectingSampleId: null,
  confirmCallback: null,
  selectedBars: 4,
};

let samples = {};
let sessions = {};
let decisions = [];
let currentVariations = [];
let varIdCounter = 0;

// Sound DNA state
let dnaFiles = [];
let dnaProfile = null;
let dnaCategoryResults = [];
let projects = {};
let currentProjectId = null;

// ==================== PERSISTENCE ====================
function saveData() {
  try {
    localStorage.setItem('fiire_samples', JSON.stringify(samples));
    localStorage.setItem('fiire_sessions', JSON.stringify(sessions));
    localStorage.setItem('fiire_decisions', JSON.stringify(decisions));
    localStorage.setItem('fiire_counters', JSON.stringify({ varIdCounter }));
    localStorage.setItem('fiire_projects', JSON.stringify(projects));
    localStorage.setItem('fiire_current_project', currentProjectId);
  } catch(e) {}
}
function loadData() {
  try {
    const s = localStorage.getItem('fiire_samples'); if (s) samples = JSON.parse(s);
    const ss = localStorage.getItem('fiire_sessions'); if (ss) sessions = JSON.parse(ss);
    const d = localStorage.getItem('fiire_decisions'); if (d) decisions = JSON.parse(d);
    const c = localStorage.getItem('fiire_counters'); if (c) { const p = JSON.parse(c); varIdCounter = p.varIdCounter || 0; }
    const pr = localStorage.getItem('fiire_projects'); if (pr) projects = JSON.parse(pr);
    const cp = localStorage.getItem('fiire_current_project'); if (cp) currentProjectId = cp;
  } catch(e) {}
}

function migrateToProjects() {
  if (Object.keys(projects).length > 0) return; // already migrated
  const id = 'proj_default';
  projects[id] = { id, name: 'My Project', createdAt: Date.now(), updatedAt: Date.now() };
  currentProjectId = id;
  // Stamp all existing samples and sessions
  Object.values(samples).forEach(s => { if (!s.projectId) s.projectId = id; });
  Object.values(sessions).forEach(s => { if (!s.projectId) s.projectId = id; });
  saveData();
}

function getProjectSampleCount(projectId) {
  return Object.values(samples).filter(s => s.projectId === projectId).length;
}

// ==================== INDEXEDDB AUDIO STORAGE ====================
let audioDB = null;
const AUDIO_DB_NAME = 'fiire_audio';
const AUDIO_STORE = 'buffers';

function openAudioDB() {
  if (audioDB) return Promise.resolve(audioDB);
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(AUDIO_DB_NAME, 1);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(AUDIO_STORE)) {
        db.createObjectStore(AUDIO_STORE);
      }
    };
    req.onsuccess = (e) => { audioDB = e.target.result; resolve(audioDB); };
    req.onerror = () => reject(req.error);
  });
}

function saveAudioBlob(sampleId, arrayBuffer) {
  return openAudioDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(AUDIO_STORE, 'readwrite');
      tx.objectStore(AUDIO_STORE).put(arrayBuffer, sampleId);
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  }).catch(() => {}); // fail silently
}

function loadAudioBlob(sampleId) {
  return openAudioDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(AUDIO_STORE, 'readonly');
      const req = tx.objectStore(AUDIO_STORE).get(sampleId);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    });
  }).catch(() => null);
}

function deleteAudioBlob(sampleId) {
  return openAudioDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(AUDIO_STORE, 'readwrite');
      tx.objectStore(AUDIO_STORE).delete(sampleId);
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  }).catch(() => {});
}

function deleteAudioBlobsForProject(projectId) {
  const ids = Object.values(samples).filter(s => s.projectId === projectId).map(s => s.id);
  return Promise.all(ids.map(id => deleteAudioBlob(id)));
}

// ==================== UTILITIES ====================
function uid(prefix) { return prefix + '_' + (++varIdCounter) + '_' + Date.now().toString(36); }
function formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return m+':'+(sec<10?'0':'')+sec; }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); state.rejectingSampleId = null; }

// ==================== AUDIO ENGINE ====================
let audioCtx = null;
let masterGain = null;
let currentSource = null;
let audioBuffers = {}; // sampleId -> AudioBuffer
let playbackStartTime = 0;
let playbackOffset = 0;

function initAudioContext() {
  if (audioCtx) return audioCtx;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = state.volume / 100;
  masterGain.connect(audioCtx.destination);
  return audioCtx;
}

function ensureAudioContext() {
  initAudioContext();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function generateSyntheticAudio(sample) {
  ensureAudioContext();
  const dur = sample.duration || 2;
  const sr = audioCtx.sampleRate;
  const len = Math.ceil(dur * sr);
  const buf = audioCtx.createBuffer(2, len, sr);
  const bpm = sample.bpm || 120;

  for (let ch = 0; ch < 2; ch++) {
    const d = buf.getChannelData(ch);
    if (sample.type === 'loop') {
      const beatLen = Math.floor(60 / bpm * sr);
      for (let i = 0; i < len; i++) {
        const posInBeat = i % beatLen;
        const beatFrac = posInBeat / beatLen;
        let val = 0;
        // Kick on downbeats
        if (beatFrac < 0.06) {
          const env = 1 - beatFrac / 0.06;
          const freq = 55 + 180 * env * env;
          val += Math.sin(2 * Math.PI * freq * i / sr) * env * env * 0.7;
        }
        // Snare on beats 2 and 4
        const halfBeat = i % (beatLen * 2);
        const halfFrac = halfBeat / (beatLen * 2);
        if (halfFrac > 0.49 && halfFrac < 0.54) {
          const t = (halfFrac - 0.49) / 0.05;
          const env = Math.max(0, 1 - t * 1.5);
          val += (Math.random() * 2 - 1) * env * 0.35;
          val += Math.sin(2 * Math.PI * 200 * i / sr) * env * 0.2;
        }
        // Hi-hat on 8ths
        const eighthLen = Math.floor(beatLen / 2);
        const eighthPos = i % eighthLen;
        const eighthFrac = eighthPos / eighthLen;
        if (eighthFrac < 0.015) {
          const env = 1 - eighthFrac / 0.015;
          val += (Math.random() * 2 - 1) * env * 0.12;
        }
        d[i] = val;
      }
    } else {
      // One-shot: percussive hit
      for (let i = 0; i < len; i++) {
        const t = i / sr;
        const env = Math.exp(-t * 20);
        const pitch = 180 + 600 * Math.exp(-t * 40);
        d[i] = Math.sin(2 * Math.PI * pitch * t) * env * 0.55
             + (Math.random() * 2 - 1) * env * 0.35;
      }
    }
    // Slight stereo variation on right channel
    if (ch === 1) {
      for (let i = 0; i < len; i++) d[i] *= 0.95 + Math.random() * 0.1;
    }
  }
  return buf;
}

function cacheAndPersistBuffer(sampleId, buf) {
  audioBuffers[sampleId] = buf;
  updateSampleWaveform(sampleId, buf);
  // Persist to IndexedDB as WAV
  const wav = audioBufferToWav(buf);
  saveAudioBlob(sampleId, wav);
  return buf;
}

function getAudioBuffer(sampleId) {
  if (audioBuffers[sampleId]) return Promise.resolve(audioBuffers[sampleId]);
  const s = samples[sampleId];
  if (!s) return Promise.resolve(null);
  ensureAudioContext();

  // Try IndexedDB first
  return loadAudioBlob(sampleId).then(stored => {
    if (stored) {
      return audioCtx.decodeAudioData(stored).then(buf => {
        audioBuffers[sampleId] = buf;
        updateSampleWaveform(sampleId, buf);
        return buf;
      });
    }
    // If sample has a real audio URL, fetch and decode
    if (s.audioUrl) {
      return fetch(s.audioUrl)
        .then(r => r.arrayBuffer())
        .then(ab => audioCtx.decodeAudioData(ab))
        .then(buf => cacheAndPersistBuffer(sampleId, buf))
        .catch(() => cacheAndPersistBuffer(sampleId, generateSyntheticAudio(s)));
    }
    // Generate synthetic placeholder
    return cacheAndPersistBuffer(sampleId, generateSyntheticAudio(s));
  }).catch(() => {
    // IndexedDB failed, fall back to generation
    return cacheAndPersistBuffer(sampleId, generateSyntheticAudio(s));
  });
}

function stopCurrentSource() {
  if (currentSource) {
    try { currentSource.onended = null; currentSource.stop(); } catch(e) {}
    try { currentSource.disconnect(); } catch(e) {}
    currentSource = null;
  }
}

function playAudioBuffer(sampleId, offset) {
  offset = offset || 0;
  ensureAudioContext();
  stopCurrentSource();
  return getAudioBuffer(sampleId).then(buf => {
    if (!buf) return;
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.loop = state.loopPlayback;
    src.connect(masterGain);
    playbackStartTime = audioCtx.currentTime;
    playbackOffset = offset;
    state.totalTime = buf.duration;
    src.start(0, offset);
    src.onended = () => {
      if (currentSource === src && !state.loopPlayback) {
        state.isPlaying = false;
        state.currentTime = state.totalTime;
        updatePlayButton();
        stopProgress();
        document.getElementById('player-current-time').textContent = formatTime(state.totalTime);
        drawPlayerWaveform(1);
      }
    };
    currentSource = src;
  });
}

function extractPeaks(audioBuffer, barCount) {
  barCount = barCount || 100;
  const chan = audioBuffer.getChannelData(0);
  const len = chan.length;
  const chunkSize = Math.floor(len / barCount);
  const peaks = [];
  let maxPeak = 0;
  for (let i = 0; i < barCount; i++) {
    const start = i * chunkSize;
    const end = Math.min(start + chunkSize, len);
    let peak = 0;
    for (let j = start; j < end; j++) {
      const abs = Math.abs(chan[j]);
      if (abs > peak) peak = abs;
    }
    peaks.push(peak);
    if (peak > maxPeak) maxPeak = peak;
  }
  if (maxPeak > 0) {
    for (let i = 0; i < peaks.length; i++) peaks[i] = peaks[i] / maxPeak;
  }
  return peaks;
}

function updateSampleWaveform(sampleId, audioBuffer) {
  const s = samples[sampleId];
  if (!s) return;
  s.waveformData = extractPeaks(audioBuffer, 80 + Math.floor(Math.random() * 40));
  // Re-render any visible waveform canvases for this sample
  document.querySelectorAll(`canvas[data-id="${sampleId}"]`).forEach(canvas => {
    if (canvas.classList.contains('var-waveform') || canvas.classList.contains('lib-waveform')) {
      drawWaveform(canvas, s.waveformData, s.status === 'rejected' ? '#444' : '#E85002');
    } else if (canvas.classList.contains('lib-waveform-row')) {
      drawMiniWaveform(canvas, s.waveformData, '#E85002');
    }
  });
}

function getPlaybackTime() {
  if (!audioCtx || !state.isPlaying) return state.currentTime;
  const t = playbackOffset + (audioCtx.currentTime - playbackStartTime);
  if (state.loopPlayback && state.totalTime > 0) return t % state.totalTime;
  return Math.min(t, state.totalTime);
}

// ==================== PROJECTS ====================
let projectDropdownOpen = false;

function toggleProjectDropdown() {
  projectDropdownOpen = !projectDropdownOpen;
  const dd = document.getElementById('project-dropdown');
  const chevron = document.getElementById('project-chevron');
  dd.classList.toggle('hidden', !projectDropdownOpen);
  chevron.textContent = projectDropdownOpen ? 'expand_less' : 'expand_more';
  if (projectDropdownOpen) renderProjectList();
}

function closeProjectDropdown() {
  projectDropdownOpen = false;
  document.getElementById('project-dropdown').classList.add('hidden');
  document.getElementById('project-chevron').textContent = 'expand_more';
  cancelNewProject();
}

function renderProjectSwitcher() {
  const proj = projects[currentProjectId];
  if (!proj) return;
  document.getElementById('project-name').textContent = proj.name;
  const count = getProjectSampleCount(currentProjectId);
  document.getElementById('project-count').textContent = count + ' sample' + (count !== 1 ? 's' : '');
}

function renderProjectList() {
  const list = document.getElementById('project-list');
  const sorted = Object.values(projects).sort((a, b) => b.updatedAt - a.updatedAt);
  list.innerHTML = sorted.map(p => {
    const count = getProjectSampleCount(p.id);
    const isActive = p.id === currentProjectId;
    return `
      <div class="flex items-center gap-2 px-3 py-2 hover:bg-surface transition-colors cursor-pointer group ${isActive ? 'bg-surface' : ''}" onclick="switchProject('${p.id}')">
        <div class="w-6 h-6 rounded-md ${isActive ? 'bg-brand/20' : 'bg-bg'} flex items-center justify-center flex-shrink-0">
          ${isActive ? '<span class="material-symbols-outlined text-brand text-[14px]">check</span>' : '<span class="material-symbols-outlined text-txt-dim text-[14px]">folder</span>'}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate ${isActive ? 'text-brand' : ''}">${p.name}</p>
          <p class="text-[10px] text-txt-dim">${count} sample${count !== 1 ? 's' : ''}</p>
        </div>
        <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
          <button class="p-1 rounded hover:bg-dk-gray text-txt-dim hover:text-txt" onclick="event.stopPropagation(); renameProjectPrompt('${p.id}')">
            <span class="material-symbols-outlined text-[14px]">edit</span>
          </button>
          ${Object.keys(projects).length > 1 ? `<button class="p-1 rounded hover:bg-dk-gray text-txt-dim hover:text-red-400" onclick="event.stopPropagation(); deleteProjectConfirm('${p.id}')">
            <span class="material-symbols-outlined text-[14px]">delete</span>
          </button>` : ''}
        </div>
      </div>`;
  }).join('');
}

function switchProject(id) {
  if (id === currentProjectId) { closeProjectDropdown(); return; }
  currentProjectId = id;
  projects[id].updatedAt = Date.now();
  currentVariations = [];
  state.currentSample = null;
  state.inspectedSample = null;
  document.getElementById('player-bar').style.display = 'none';
  closeProjectDropdown();
  saveData();
  renderProjectSwitcher();
  navigateTo(state.currentPage);
  showToast('Switched to ' + projects[id].name);
}

function createProject(name) {
  const id = uid('proj');
  projects[id] = { id, name: name || 'Untitled Project', createdAt: Date.now(), updatedAt: Date.now() };
  saveData();
  switchProject(id);
}

function showNewProjectInput() {
  document.getElementById('new-project-row').classList.add('hidden');
  document.getElementById('new-project-input-row').classList.remove('hidden');
  const input = document.getElementById('new-project-input');
  input.value = '';
  input.focus();
}

function confirmNewProject() {
  const input = document.getElementById('new-project-input');
  const name = input.value.trim();
  if (!name) return;
  createProject(name);
  cancelNewProject();
}

function cancelNewProject() {
  document.getElementById('new-project-row').classList.remove('hidden');
  document.getElementById('new-project-input-row').classList.add('hidden');
}

function renameProjectPrompt(id) {
  const p = projects[id];
  if (!p) return;
  const name = prompt('Rename project:', p.name);
  if (name && name.trim()) {
    p.name = name.trim();
    p.updatedAt = Date.now();
    saveData();
    renderProjectSwitcher();
    renderProjectList();
    showToast('Project renamed');
  }
}

function deleteProjectConfirm(id) {
  const p = projects[id];
  if (!p || Object.keys(projects).length <= 1) return;
  document.getElementById('confirm-title').textContent = 'Delete Project';
  document.getElementById('confirm-msg').textContent = `Delete "${p.name}" and all its samples? This can't be undone.`;
  document.getElementById('confirm-action').onclick = () => {
    // Delete all samples, sessions, and audio blobs for this project
    Object.keys(samples).forEach(sid => { if (samples[sid].projectId === id) { deleteAudioBlob(sid); delete audioBuffers[sid]; delete samples[sid]; } });
    Object.keys(sessions).forEach(sid => { if (sessions[sid].projectId === id) delete sessions[sid]; });
    decisions = decisions.filter(d => samples[d.sampleId]); // clean up orphaned decisions
    delete projects[id];
    if (currentProjectId === id) {
      currentProjectId = Object.keys(projects)[0];
    }
    saveData();
    closeModal();
    closeProjectDropdown();
    renderProjectSwitcher();
    navigateTo(state.currentPage);
    showToast('Project deleted');
  };
  document.getElementById('confirm-modal').classList.add('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (projectDropdownOpen && !e.target.closest('#project-switcher') && !e.target.closest('#project-dropdown')) {
    closeProjectDropdown();
  }
});

// ==================== NAVIGATION ====================
function navigateTo(page) {
  state.currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const target = document.getElementById('page-' + page);
  if (target) { target.classList.add('active', 'animate-fadeIn'); setTimeout(() => target.classList.remove('animate-fadeIn'), 300); }
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active'); link.classList.add('text-txt-muted');
    if (link.dataset.page === page) { link.classList.add('active'); link.classList.remove('text-txt-muted'); }
  });
  if (page === 'home') renderHome();
  if (page === 'generate') renderVariations();
  if (page === 'library') renderLibrary();
  if (page === 'favorites') renderFavorites();
  if (page === 'history') renderHistory();
  if (page === 'sounddna') renderSoundDna();
  renderProjectSwitcher();
}

// ==================== HOME PAGE ====================
function renderHome() {
  // Greeting based on time of day
  const hour = new Date().getHours();
  const timeGreeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
  document.getElementById('home-greeting').textContent = `${timeGreeting}!`;

  // Render project cards
  const container = document.getElementById('home-projects');
  const projList = Object.values(projects).sort((a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt));

  if (!projList.length) {
    container.innerHTML = `
      <div class="text-center py-12 border-2 border-dashed border-border rounded-2xl">
        <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">folder_open</span>
        <p class="text-txt-muted font-medium">No projects yet</p>
        <p class="text-txt-dim text-sm mt-1">Create your first project to get started.</p>
      </div>`;
    return;
  }

  container.innerHTML = projList.map(p => {
    const sampleCount = Object.values(samples).filter(s => s.projectId === p.id).length;
    const acceptedCount = Object.values(samples).filter(s => s.projectId === p.id && s.isInLibrary).length;
    const sessionCount = Object.values(sessions).filter(s => s.projectId === p.id).length;
    const isActive = p.id === currentProjectId;
    return `
      <div class="group flex items-center gap-4 bg-panel border ${isActive ? 'border-brand/40' : 'border-border'} rounded-xl p-4 cursor-pointer hover:border-brand transition-colors"
           onclick="switchProject('${p.id}'); navigateTo('generate');">
        <div class="w-10 h-10 rounded-lg ${isActive ? 'bg-brand/20' : 'bg-surface'} flex items-center justify-center flex-shrink-0">
          <span class="material-symbols-outlined ${isActive ? 'text-brand' : 'text-txt-muted'}">folder</span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-bold text-sm truncate">${p.name}</p>
          <p class="text-xs text-txt-muted">${sampleCount} samples &middot; ${acceptedCount} accepted &middot; ${sessionCount} sessions</p>
        </div>
        ${isActive ? '<span class="text-[10px] text-brand font-bold uppercase tracking-wider">Active</span>' : ''}
        <span class="material-symbols-outlined text-txt-dim text-[18px] group-hover:text-txt transition-colors">arrow_forward</span>
      </div>`;
  }).join('');
}

function startNewProject() {
  const name = prompt('Project name:');
  if (name && name.trim()) {
    createProject(name.trim());
    renderHome();
  }
}

// ==================== WAVEFORM RENDERING ====================
function placeholderWaveform(length) {
  const data = [];
  for (let i = 0; i < (length || 80); i++) data.push(0.3);
  return data;
}

function drawWaveform(canvas, data, color, progress) {
  if (!canvas || !data) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;
  ctx.clearRect(0, 0, w, h);
  const barW = Math.max(2, w / data.length - 1);
  const gap = 1;
  const mid = h / 2;
  for (let i = 0; i < data.length; i++) {
    const x = i * (barW + gap);
    const barH = data[i] * mid * 0.85;
    const pct = x / w;
    if (progress !== undefined && pct <= progress) {
      ctx.fillStyle = color || '#E85002';
    } else {
      ctx.fillStyle = progress !== undefined ? '#333' : (color || '#E85002');
    }
    ctx.fillRect(x, mid - barH, barW, barH * 2);
  }
}

function drawMiniWaveform(canvas, data, color) {
  if (!canvas || !data) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width; const h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  const barW = 2; const gap = 1;
  const mid = h / 2;
  const count = Math.floor(w / (barW + gap));
  const step = Math.max(1, Math.floor(data.length / count));
  ctx.fillStyle = color || '#E85002';
  for (let i = 0; i < count; i++) {
    const val = data[Math.min(i * step, data.length - 1)] || 0.5;
    const barH = val * mid * 0.8;
    ctx.fillRect(i * (barW + gap), mid - barH, barW, barH * 2);
  }
}

// ==================== GENERATE MODE ====================
// ==================== REFERENCE AUDIO ====================
let referenceBuffer = null;
let referenceFile = null;
let referenceSource = null;

function handleRefUpload(input) {
  const file = input.files?.[0];
  if (!file) return;
  referenceFile = file;

  ensureAudioContext();
  const reader = new FileReader();
  reader.onload = (e) => {
    audioCtx.decodeAudioData(e.target.result).then(buf => {
      referenceBuffer = buf;
      // Show indicator
      document.getElementById('ref-indicator').classList.remove('hidden');
      document.getElementById('ref-filename').textContent = file.name;
      document.getElementById('ref-duration').textContent = buf.duration.toFixed(1) + 's';
      // Highlight the upload button
      document.getElementById('ref-upload-btn').classList.add('border-brand', 'text-brand');
      document.getElementById('ref-upload-btn').classList.remove('border-border', 'text-txt-dim');
      showToast('Reference audio loaded');
    }).catch(() => {
      showToast('Could not decode audio file');
      removeReference();
    });
  };
  reader.readAsArrayBuffer(file);
  input.value = ''; // reset so same file can be re-selected
}

function playReference() {
  if (!referenceBuffer) return;
  ensureAudioContext();
  // Stop if already playing
  if (referenceSource) {
    try { referenceSource.stop(); } catch(e) {}
    referenceSource = null;
    document.querySelector('#ref-play-btn .material-symbols-outlined').textContent = 'play_arrow';
    return;
  }
  referenceSource = audioCtx.createBufferSource();
  referenceSource.buffer = referenceBuffer;
  referenceSource.connect(masterGain);
  referenceSource.onended = () => {
    referenceSource = null;
    document.querySelector('#ref-play-btn .material-symbols-outlined').textContent = 'play_arrow';
  };
  referenceSource.start(0);
  document.querySelector('#ref-play-btn .material-symbols-outlined').textContent = 'stop';
}

function removeReference() {
  if (referenceSource) { try { referenceSource.stop(); } catch(e) {} referenceSource = null; }
  referenceBuffer = null;
  referenceFile = null;
  document.getElementById('ref-indicator').classList.add('hidden');
  document.getElementById('ref-upload-btn').classList.remove('border-brand', 'text-brand');
  document.getElementById('ref-upload-btn').classList.add('border-border', 'text-txt-dim');
}

function toggleParams() {
  const panel = document.getElementById('params-panel');
  const isOpen = !panel.classList.contains('hidden');
  panel.classList.toggle('hidden', isOpen);
  document.getElementById('params-chevron').textContent = isOpen ? 'tune' : 'expand_less';
}

function setGenerateMode(mode) {
  state.generateMode = mode;
  const loopEl = document.getElementById('loop-params');
  const osEl = document.getElementById('oneshot-params');
  if (mode === 'loop') {
    loopEl.style.display = 'flex';
    osEl.style.display = 'none';
  } else {
    loopEl.style.display = 'none';
    osEl.style.display = 'flex';
  }
  document.querySelectorAll('input[name="gen-mode"]').forEach(r => { r.checked = r.value === mode; });
  updateGenBtnText();
}

function updateGenBtnText() {
  document.getElementById('gen-btn-text').textContent = 'Generate';
}

function setLength(bars, el) {
  state.selectedBars = bars;
  document.querySelectorAll('#length-chips .param-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function toggleChip(el, containerId) {
  document.querySelectorAll('#' + containerId + ' .param-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function toggleMultiChip(el) {
  el.classList.toggle('active');
}

// ==================== SAMPLE GENERATION ====================
function getGenParams() {
  const mode = state.generateMode;
  const styles = [...document.querySelectorAll('#style-chips .param-chip.active')].map(c => c.textContent.trim());
  const prompt = document.getElementById('gen-prompt').value;
  const model = 'eleven_text_to_sound_v2';
  const varCount = 4;

  if (mode === 'loop') {
    return {
      type: 'loop', bpm: parseInt(document.getElementById('bpm-input').value),
      key: document.getElementById('key-select').value,
      bars: state.selectedBars,
      styles, prompt, model, varCount
    };
  } else {
    const attack = document.querySelector('#attack-chips .param-chip.active')?.textContent.trim() || 'Snappy';
    const timbre = document.querySelector('#timbre-chips .param-chip.active')?.textContent.trim() || 'Warm';
    return {
      type: 'oneshot', tuning: document.getElementById('tuning-select').value,
      attack, timbre, styles, prompt, model, varCount
    };
  }
}

function buildSfxPrompt(params) {
  const parts = [];
  if (params.type === 'loop') {
    parts.push(`${params.bpm} BPM`);
    if (params.key) parts.push(`${params.key}`);
    if (params.styles?.length) parts.push(params.styles.join(', '));
    parts.push('drum loop');
    if (params.bars) parts.push(`${params.bars} bars`);
  } else {
    if (params.attack) parts.push(params.attack.toLowerCase());
    if (params.timbre) parts.push(params.timbre.toLowerCase());
    if (params.styles?.length) parts.push(params.styles.join(', '));
    parts.push('one-shot percussion hit');
    if (params.tuning) parts.push(`tuned to ${params.tuning}`);
  }
  if (params.prompt) parts.push(params.prompt);
  // Add reference context if uploaded
  if (referenceBuffer) {
    const refDur = referenceBuffer.duration.toFixed(1);
    parts.push(`similar style to reference track (${refDur}s)`);
  }
  return parts.join(', ');
}

function calcDuration(params) {
  if (params.type === 'loop') {
    const secsPerBeat = 60 / (params.bpm || 120);
    return Math.min(30, Math.max(0.5, params.bars * secsPerBeat * (params.bpm < 100 ? 2 : 1)));
  }
  return 1.5; // one-shot default
}

function callElevenLabsSfx(prompt, duration, isLoop, modelId) {
  return fetch('https://api.elevenlabs.io/v1/sound-generation?output_format=pcm_44100', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'xi-api-key': ELEVENLABS_API_KEY,
    },
    body: JSON.stringify({
      text: prompt,
      duration_seconds: Math.round(duration * 10) / 10,
      prompt_influence: 0.3,
      loop: isLoop,
      model_id: modelId || 'eleven_text_to_sound_v2',
    }),
  }).then(res => {
    if (!res.ok) return res.text().then(t => { throw new Error(`API ${res.status}: ${t}`); });
    return res.arrayBuffer();
  });
}

function pcmToAudioBuffer(pcmData, sampleRate) {
  ensureAudioContext();
  const int16 = new Int16Array(pcmData);
  const numSamples = int16.length;
  const buf = audioCtx.createBuffer(1, numSamples, sampleRate || 44100);
  const chan = buf.getChannelData(0);
  for (let i = 0; i < numSamples; i++) {
    chan[i] = int16[i] / 32768;
  }
  return buf;
}

function generateSamples() {
  if (state.generating) return;
  state.generating = true;
  const params = getGenParams();
  const useAPI = ELEVENLABS_API_KEY && ELEVENLABS_API_KEY.length > 0;

  document.getElementById('gen-loading').classList.remove('hidden');
  document.getElementById('gen-empty').classList.add('hidden');
  document.getElementById('var-grid').innerHTML = '';

  const sessionId = uid('ses');
  const variationIds = [];
  const duration = calcDuration(params);
  const sfxPrompt = buildSfxPrompt(params);
  const isLoop = params.type === 'loop';

  // Create sample shells
  for (let i = 0; i < params.varCount; i++) {
    const id = uid('smp');
    samples[id] = {
      id, type: params.type,
      name: params.type === 'loop' ? `Loop ${Object.keys(samples).length + 1}` : `One-Shot ${Object.keys(samples).length + 1}`,
      status: 'pending',
      duration: Math.round(duration * 100) / 100,
      bpm: params.bpm || null,
      key: params.key || null,
      bars: params.bars || null,
      tuning: params.tuning || null,
      attack: params.attack || null,
      timbre: params.timbre || null,
      style: params.styles || [],
      tags: params.styles ? [...params.styles] : [],
      notes: '',
      effects: {},
      generationSessionId: sessionId,
      variationIndex: i,
      parentSampleId: null,
      modelVersion: useAPI ? 'ElevenLabs SFX v2' : 'Synthetic',
      createdAt: Date.now() - (params.varCount - i) * 100,
      acceptedAt: null,
      favoritedAt: null,
      isFavorite: false,
      isInLibrary: false,
      rejectionFeedback: null,
      waveformData: placeholderWaveform(80),
      projectId: currentProjectId,
    };
    variationIds.push(id);
  }

  sessions[sessionId] = {
    id: sessionId, type: params.type, params,
    variationIds, acceptedCount: 0, rejectedCount: 0,
    createdAt: Date.now(),
    projectId: currentProjectId,
  };

  currentVariations = variationIds;
  saveData();

  if (!useAPI) {
    // No API key â€” fall back to synthetic audio
    state.generating = false;
    renderVariations();
    document.getElementById('gen-loading').classList.add('hidden');
      document.getElementById('gen-var-count').textContent = variationIds.length + ' variations';
    showToast('No API key â€” generated synthetic placeholders');
    ensureAudioContext();
    variationIds.forEach(vid => getAudioBuffer(vid));
    return;
  }

  // Call ElevenLabs SFX API for each variation
  let completed = 0;
  let failed = 0;

  variationIds.forEach((vid, i) => {
    // Stagger requests slightly to avoid rate limits
    setTimeout(() => {
      callElevenLabsSfx(sfxPrompt, duration, isLoop, params.model)
        .then(pcmData => {
          ensureAudioContext();
          const buf = pcmToAudioBuffer(pcmData, 44100);
          samples[vid].duration = buf.duration;
          cacheAndPersistBuffer(vid, buf);
          saveData();
        })
        .catch(err => {
          console.error(`Generation failed for ${vid}:`, err);
          failed++;
          // Fall back to synthetic for this variation
          ensureAudioContext();
          getAudioBuffer(vid);
        })
        .finally(() => {
          completed++;
          if (completed === variationIds.length) {
            state.generating = false;
            renderVariations();
            document.getElementById('gen-loading').classList.add('hidden');
                      document.getElementById('gen-var-count').textContent = variationIds.length + ' variations';
            if (failed > 0) {
              showToast(`Generated ${completed - failed} samples (${failed} fell back to synthetic)`);
            } else {
              showToast(`Generated ${completed} samples from ElevenLabs!`);
            }
          }
        });
    }, i * 500); // 500ms stagger between requests
  });
}

function renderVariations() {
  const container = document.getElementById('var-grid');
  const emptyEl = document.getElementById('gen-empty');
  const list = currentVariations.map(id => samples[id]).filter(Boolean);

  if (!list.length) {
    container.innerHTML = '';
    emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');
  document.getElementById('gen-var-count').textContent = list.length + ' variation' + (list.length !== 1 ? 's' : '');

  container.className = 'space-y-1.5';
  container.innerHTML = list.map(s => renderStackRow(s)).join('');

  requestAnimationFrame(() => {
    document.querySelectorAll('.var-waveform').forEach(canvas => {
      const id = canvas.dataset.id;
      const s = samples[id];
      if (s) drawWaveform(canvas, s.waveformData, s.status === 'rejected' ? '#444' : '#E85002');
    });
  });
}

function renderGridCard(s) {
  const id = s.id;
  const statusClass = s.status === 'accepted' ? 'accepted' : s.status === 'rejected' ? 'rejected' : '';
  const playingClass = state.currentSample === id ? 'playing' : '';
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack} / ${s.timbre}`;
  const typeBadge = s.type === 'loop' ? 'badge-loop' : 'badge-oneshot';
  return `
    <div class="variation-card ${statusClass} ${playingClass} relative bg-surface rounded-xl border border-border overflow-hidden"
         data-id="${id}">
      <div class="relative h-24 bg-bg p-2 cursor-pointer" onclick="previewSample('${id}')">
        <canvas class="var-waveform w-full h-full" data-id="${id}"></canvas>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
          <div class="w-9 h-9 bg-brand/90 rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-[22px] fill-1 text-txt">${state.currentSample === id && state.isPlaying ? 'pause' : 'play_arrow'}</span>
          </div>
        </div>
        <span class="absolute bottom-1.5 right-1.5 px-1.5 py-0.5 bg-black/75 text-[9px] font-mono text-txt rounded">${formatTime(s.duration)}</span>
        <span class="absolute top-1.5 left-1.5 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${typeBadge}">${s.type}</span>
        ${s.status === 'accepted' ? '<span class="absolute top-1.5 right-1.5 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center"><span class="material-symbols-outlined text-[12px] text-txt">check</span></span>' : ''}
      </div>
      <div class="p-2.5">
        <p class="text-[11px] font-bold truncate mb-0.5">${s.name}</p>
        <p class="text-[10px] text-txt-dim truncate mb-2">${meta}</p>
        ${s.status === 'pending' ? `
        <div class="flex items-center gap-1">
          <button class="flex-1 flex items-center justify-center gap-0.5 py-1 bg-emerald-500/15 text-emerald-400 rounded-md text-[10px] font-bold hover:bg-emerald-500/25 transition-colors" onclick="event.stopPropagation(); acceptVariation('${id}')">
            <span class="material-symbols-outlined text-[14px]">check</span> Accept
          </button>
          <button class="flex-1 flex items-center justify-center gap-0.5 py-1 bg-red-500/10 text-red-400 rounded-md text-[10px] font-bold hover:bg-red-500/20 transition-colors" onclick="event.stopPropagation(); rejectVariation('${id}')">
            <span class="material-symbols-outlined text-[14px]">close</span> Reject
          </button>
          <button class="p-1 text-txt-muted hover:text-brand rounded-md hover:bg-bg transition-colors" onclick="event.stopPropagation(); toggleSampleFavorite('${id}')">
            <span class="material-symbols-outlined text-[14px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span>
          </button>
        </div>` : s.status === 'accepted' ? `
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-emerald-400 font-bold">Accepted</span>
          <button class="p-1 text-txt-muted hover:text-brand rounded-md" onclick="event.stopPropagation(); toggleSampleFavorite('${id}')">
            <span class="material-symbols-outlined text-[14px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span>
          </button>
        </div>` : `
        <div class="text-[10px] text-red-400 font-bold">${s.rejectionFeedback && s.rejectionFeedback !== 'skip' ? 'Rejected: ' + s.rejectionFeedback.replace('_', ' ') : 'Rejected'}</div>`}
      </div>
    </div>`;
}

function renderStackRow(s) {
  const id = s.id;
  const statusClass = s.status === 'accepted' ? 'accepted' : s.status === 'rejected' ? 'rejected' : '';
  const playingClass = state.currentSample === id ? 'playing' : '';
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack} / ${s.timbre}`;
  const typeBadge = s.type === 'loop' ? 'badge-loop' : 'badge-oneshot';
  const favClass = s.isFavorite ? 'fill-1 text-brand' : '';
  return `
    <div class="variation-card ${statusClass} ${playingClass} bg-surface rounded-lg border border-border flex items-center gap-3 pr-3 group cursor-pointer"
         data-id="${id}" onclick="previewSample('${id}')">
      <div class="relative w-28 h-14 flex-shrink-0 bg-bg rounded-l-lg overflow-hidden">
        <canvas class="var-waveform w-full h-full" data-id="${id}"></canvas>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="w-7 h-7 bg-brand/90 rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-[16px] fill-1 text-txt">${state.currentSample === id && state.isPlaying ? 'pause' : 'play_arrow'}</span>
          </div>
        </div>
        <span class="absolute top-1 left-1 px-1 py-0.5 rounded text-[8px] font-bold uppercase ${typeBadge}">${s.type}</span>
      </div>
      <div class="flex-1 min-w-0 py-2">
        <p class="text-xs font-bold truncate">${s.name}</p>
        <p class="text-[10px] text-txt-dim truncate">${meta}</p>
      </div>
      <span class="text-[10px] font-mono text-txt-dim flex-shrink-0">${formatTime(s.duration)}</span>
      ${s.status === 'accepted' ? `
      <span class="text-[10px] text-emerald-400 font-bold flex-shrink-0 w-16 text-center">Accepted</span>` : s.status === 'rejected' ? `
      <span class="text-[10px] text-red-400 font-bold flex-shrink-0 w-16 text-center">Rejected</span>` : `
      <div class="flex items-center gap-1 flex-shrink-0">
        <button class="flex items-center gap-0.5 px-2 py-1 bg-emerald-500/15 text-emerald-400 rounded-md text-[10px] font-bold hover:bg-emerald-500/25 transition-colors" onclick="event.stopPropagation(); acceptVariation('${id}')">
          <span class="material-symbols-outlined text-[12px]">check</span> Accept
        </button>
        <button class="flex items-center gap-0.5 px-2 py-1 bg-red-500/10 text-red-400 rounded-md text-[10px] font-bold hover:bg-red-500/20 transition-colors" onclick="event.stopPropagation(); rejectVariation('${id}')">
          <span class="material-symbols-outlined text-[12px]">close</span> Reject
        </button>
      </div>`}
      <button class="p-1.5 text-txt-muted hover:text-brand rounded-md flex-shrink-0 transition-colors" onclick="event.stopPropagation(); toggleSampleFavorite('${id}')">
        <span class="material-symbols-outlined text-[16px] ${favClass}">favorite</span>
      </button>
      ${s.status === 'accepted' ? '<span class="material-symbols-outlined text-[14px] text-emerald-500 flex-shrink-0">check_circle</span>' : ''}
    </div>`;
}

// ==================== ACCEPT / REJECT ====================
function acceptVariation(id) {
  const s = samples[id];
  if (!s || s.status !== 'pending') return;
  s.status = 'accepted';
  s.acceptedAt = Date.now();
  s.isInLibrary = true;
  const session = sessions[s.generationSessionId];
  if (session) session.acceptedCount++;
  decisions.push({ sampleId: id, action: 'accept', timestamp: Date.now() });
  saveData();
  renderVariations();
  showToast('Sample accepted & added to library!');
}

function rejectVariation(id) {
  state.rejectingSampleId = id;
  document.getElementById('reject-modal').classList.add('open');
}

function submitReject(feedback) {
  const id = state.rejectingSampleId;
  if (!id) return;
  const s = samples[id];
  if (s) {
    s.status = 'rejected';
    s.rejectionFeedback = feedback;
    const session = sessions[s.generationSessionId];
    if (session) session.rejectedCount++;
    decisions.push({ sampleId: id, action: 'reject', feedback, timestamp: Date.now() });
  }
  closeModal();
  saveData();
  renderVariations();
  showToast('Sample rejected' + (feedback !== 'skip' ? ' â€” feedback recorded' : ''));
}

// ==================== FAVORITES ====================
function toggleSampleFavorite(id) {
  const s = samples[id];
  if (!s) return;
  s.isFavorite = !s.isFavorite;
  s.favoritedAt = s.isFavorite ? Date.now() : null;
  saveData();
  showToast(s.isFavorite ? 'Added to favorites' : 'Removed from favorites');
  if (state.currentPage === 'favorites') renderFavorites();
  if (state.currentPage === 'generate') renderVariations();
  if (state.currentPage === 'library') renderLibrary();
  updateInspectorFav();
  updatePlayerFav();
}

function updateInspectorFav() {
  const s = samples[state.inspectedSample];
  if (s) {
    const icon = document.getElementById('inspector-fav-icon');
    icon.classList.toggle('fill-1', s.isFavorite);
    icon.classList.toggle('text-brand', s.isFavorite);
  }
}

function updatePlayerFav() {
  const s = samples[state.currentSample];
  if (s) {
    const btn = document.getElementById('player-fav-btn');
    const icon = btn.querySelector('.material-symbols-outlined');
    icon.classList.toggle('fill-1', s.isFavorite);
    btn.classList.toggle('text-brand', s.isFavorite);
    btn.classList.toggle('text-txt-muted', !s.isFavorite);
  }
}

function togglePlayerFav() {
  if (state.currentSample) toggleSampleFavorite(state.currentSample);
}

// ==================== PLAYBACK ====================
function previewSample(id) {
  const s = samples[id];
  if (!s) return;

  if (state.currentSample === id) { togglePlayPause(); return; }

  state.currentSample = id;
  state.currentTime = 0;
  state.totalTime = s.duration;
  state.isPlaying = true;

  document.getElementById('player-bar').style.display = 'block';
  document.getElementById('player-title').textContent = s.name;
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack}`;
  document.getElementById('player-meta').textContent = meta;
  document.getElementById('player-total-time').textContent = formatTime(s.duration);
  document.getElementById('player-current-time').textContent = '0:00';
  updatePlayButton();
  updatePlayerFav();

  // Real audio playback
  playAudioBuffer(id, 0).then(() => {
    startProgress();
    drawMiniWaveform(document.getElementById('player-mini-waveform'), s.waveformData, '#E85002');
    drawPlayerWaveform();
  });

  // Open inspector
  openInspector(id);

  // Update variation card highlights
  document.querySelectorAll('.variation-card').forEach(card => {
    card.classList.toggle('playing', card.dataset.id === id);
  });
}

function playSampleFromInspector() {
  if (state.inspectedSample) previewSample(state.inspectedSample);
}

function togglePlayPause() {
  if (!state.currentSample) return;
  state.isPlaying = !state.isPlaying;
  updatePlayButton();
  if (state.isPlaying) {
    playAudioBuffer(state.currentSample, state.currentTime);
    startProgress();
  } else {
    state.currentTime = getPlaybackTime();
    stopCurrentSource();
    stopProgress();
  }
}

function updatePlayButton() {
  document.querySelector('#btn-play .material-symbols-outlined').textContent = state.isPlaying ? 'pause' : 'play_arrow';
  const inspIcon = document.getElementById('inspector-play-icon');
  if (inspIcon) inspIcon.textContent = state.isPlaying ? 'pause' : 'play_arrow';
}

function startProgress() {
  stopProgress();
  state.progressInterval = setInterval(() => {
    if (!state.isPlaying) return;
    const t = getPlaybackTime();
    state.currentTime = t;
    if (t < state.totalTime || state.loopPlayback) {
      const displayTime = state.loopPlayback ? t % state.totalTime : t;
      const pct = displayTime / state.totalTime;
      document.getElementById('player-current-time').textContent = formatTime(displayTime);
      drawPlayerWaveform(pct);
    } else {
      state.isPlaying = false;
      updatePlayButton();
      stopProgress();
      document.getElementById('player-current-time').textContent = formatTime(state.totalTime);
      drawPlayerWaveform(1);
    }
  }, 50);
}

function stopProgress() { if (state.progressInterval) { clearInterval(state.progressInterval); state.progressInterval = null; } }

function drawPlayerWaveform(progress) {
  const s = samples[state.currentSample];
  if (!s) return;
  drawWaveform(document.getElementById('player-waveform'), s.waveformData, '#E85002', progress || 0);
}

function seekSample(e) {
  if (!state.currentSample) return;
  const r = e.currentTarget.getBoundingClientRect();
  const p = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
  state.currentTime = p * state.totalTime;
  document.getElementById('player-current-time').textContent = formatTime(state.currentTime);
  drawPlayerWaveform(p);
  if (state.isPlaying) {
    playAudioBuffer(state.currentSample, state.currentTime);
  }
}

function toggleLoopPlayback() {
  state.loopPlayback = !state.loopPlayback;
  if (currentSource) currentSource.loop = state.loopPlayback;
  document.getElementById('btn-loop').classList.toggle('text-brand', state.loopPlayback);
  document.getElementById('btn-loop').classList.toggle('text-txt-muted', !state.loopPlayback);
  const inspBtn = document.getElementById('inspector-loop-btn');
  if (inspBtn) {
    inspBtn.classList.toggle('text-brand', state.loopPlayback);
    inspBtn.classList.toggle('text-txt-muted', !state.loopPlayback);
  }
  showToast(state.loopPlayback ? 'Loop on' : 'Loop off');
}

function setVolume(v) { state.volume = parseInt(v); state.isMuted = false; if (masterGain) masterGain.gain.value = state.volume / 100; updateVolumeIcon(); }
function toggleMute() { state.isMuted = !state.isMuted; document.getElementById('volume-slider').value = state.isMuted ? 0 : state.volume; if (masterGain) masterGain.gain.value = state.isMuted ? 0 : state.volume / 100; updateVolumeIcon(); }
function updateVolumeIcon() { const i = document.getElementById('volume-icon'); const v = state.isMuted ? 0 : state.volume; i.textContent = v === 0 ? 'volume_off' : v < 40 ? 'volume_down' : 'volume_up'; }

// ==================== INSPECTOR ====================
function openInspector(id) {
  const s = samples[id];
  if (!s) return;
  state.inspectedSample = id;
  document.getElementById('inspector-panel').style.display = 'flex';
  document.getElementById('inspector-title').textContent = s.name;
  const badge = document.getElementById('inspector-type-badge');
  badge.textContent = s.type === 'loop' ? 'Loop' : 'One-Shot';
  badge.className = 'px-2 py-0.5 rounded text-[10px] font-bold uppercase ' + (s.type === 'loop' ? 'badge-loop' : 'badge-oneshot');
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars / ${formatTime(s.duration)}` : `${s.tuning} / ${s.attack} / ${s.timbre} / ${formatTime(s.duration)}`;
  document.getElementById('inspector-meta').textContent = meta;

  // Draw waveform
  requestAnimationFrame(() => {
    drawWaveform(document.getElementById('inspector-waveform'), s.waveformData, '#E85002');
  });

  // Tags
  const tagsEl = document.getElementById('inspector-tags');
  tagsEl.innerHTML = s.tags.map(t => `<span class="px-2 py-1 bg-surface border border-border rounded text-[10px] text-txt-muted">${t}</span>`).join('') +
    `<button class="px-2 py-1 bg-bg border border-border rounded text-[10px] text-brand hover:bg-surface transition-colors" onclick="addTagPrompt()">+ Add</button>`;

  // Notes
  document.getElementById('inspector-notes').value = s.notes || '';

  // Favorite icon
  updateInspectorFav();
}

function closeInspector() {
  document.getElementById('inspector-panel').style.display = 'none';
  state.inspectedSample = null;
}


function updateSampleNotes() {
  const s = samples[state.inspectedSample];
  if (s) { s.notes = document.getElementById('inspector-notes').value; saveData(); }
}

function addTagPrompt() {
  const tag = prompt('Add a tag:');
  if (tag && tag.trim()) {
    const s = samples[state.inspectedSample];
    if (s) { s.tags.push(tag.trim()); saveData(); openInspector(state.inspectedSample); }
  }
}

function batchFromSample() {
  if (!state.inspectedSample) return;
  const s = samples[state.inspectedSample];
  if (!s) return;
  // Pre-fill params from this sample
  if (s.type === 'loop') {
    setGenerateMode('loop');
    document.getElementById('bpm-input').value = s.bpm || 120;
    document.getElementById('bpm-slider').value = s.bpm || 120;
    document.getElementById('key-select').value = s.key || 'C';
  } else {
    setGenerateMode('oneshot');
    document.getElementById('tuning-select').value = s.tuning || 'C4';
  }
  showToast('Generating more variations from this sample...');
  generateSamples();
}

// ==================== LIBRARY ====================
function getLibrarySamples() {
  let list = Object.values(samples).filter(s => s.isInLibrary && s.status === 'accepted' && s.projectId === currentProjectId);
  const search = (document.getElementById('lib-search')?.value || '').toLowerCase();
  const type = state.libraryType;
  const key = document.getElementById('lib-key-filter')?.value;
  const sort = document.getElementById('lib-sort')?.value;

  if (search) list = list.filter(s => s.name.toLowerCase().includes(search) || s.tags.some(t => t.toLowerCase().includes(search)) || (s.key || '').toLowerCase().includes(search));
  if (type !== 'all') list = list.filter(s => s.type === type);
  if (key && key !== 'all') list = list.filter(s => s.key === key);

  if (sort === 'recent') list.sort((a, b) => b.createdAt - a.createdAt);
  else if (sort === 'oldest') list.sort((a, b) => a.createdAt - b.createdAt);
  else if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));
  else if (sort === 'bpm') list.sort((a, b) => (a.bpm || 0) - (b.bpm || 0));
  return list;
}

function renderLibrary() {
  const list = getLibrarySamples();
  const gridEl = document.getElementById('lib-grid');
  const listEl = document.getElementById('lib-list');
  const emptyEl = document.getElementById('lib-empty');

  if (!list.length) {
    gridEl.classList.add('hidden'); listEl.classList.add('hidden'); emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');

  if (state.libraryView === 'grid') {
    gridEl.classList.remove('hidden'); listEl.classList.add('hidden');
    gridEl.innerHTML = list.map(s => renderSampleCard(s)).join('');
    requestAnimationFrame(() => {
      gridEl.querySelectorAll('.lib-waveform').forEach(canvas => {
        const s = samples[canvas.dataset.id];
        if (s) drawWaveform(canvas, s.waveformData, '#E85002');
      });
    });
  } else {
    gridEl.classList.add('hidden'); listEl.classList.remove('hidden');
    document.getElementById('lib-tbody').innerHTML = list.map(s => `
      <tr class="group hover:bg-surface/40 transition-colors cursor-pointer" onclick="previewSample('${s.id}')">
        <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="checkbox" class="rounded border-border" ${state.selectedSamples.has(s.id) ? 'checked' : ''} onchange="toggleSampleSelect('${s.id}')"/></td>
        <td class="px-4 py-3"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded bg-bg overflow-hidden"><canvas class="lib-waveform-row w-full h-full" data-id="${s.id}" width="40" height="40"></canvas></div><span class="font-bold text-sm">${s.name}</span></div></td>
        <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${s.type === 'loop' ? 'badge-loop' : 'badge-oneshot'}">${s.type}</span></td>
        <td class="px-4 py-3 text-sm text-txt-muted">${s.key || '-'}</td>
        <td class="px-4 py-3 text-sm text-txt-muted">${s.bpm || '-'}</td>
        <td class="px-4 py-3 text-sm text-txt-muted font-mono">${formatTime(s.duration)}</td>
        <td class="px-4 py-3 text-right"><div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
          <button class="p-1.5 hover:bg-dk-gray rounded-lg text-txt-muted hover:text-brand" onclick="event.stopPropagation(); toggleSampleFavorite('${s.id}')"><span class="material-symbols-outlined text-[18px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span></button>
          <button class="p-1.5 hover:bg-dk-gray rounded-lg text-txt-muted" onclick="event.stopPropagation(); downloadSample('${s.id}')"><span class="material-symbols-outlined text-[18px]">download</span></button>
          <button class="p-1.5 hover:bg-dk-gray rounded-lg text-txt-muted" onclick="event.stopPropagation(); deleteSampleConfirm('${s.id}')"><span class="material-symbols-outlined text-[18px]">delete</span></button>
        </div></td>
      </tr>`).join('');
    requestAnimationFrame(() => {
      document.querySelectorAll('.lib-waveform-row').forEach(c => {
        const s = samples[c.dataset.id];
        if (s) drawMiniWaveform(c, s.waveformData, '#E85002');
      });
    });
  }
  updateBatchBar();
}

function renderSampleCard(s) {
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack}`;
  return `
    <div class="sample-card group bg-panel p-3 rounded-2xl border border-border cursor-pointer ${state.selectedSamples.has(s.id) ? 'selected' : ''}"
         data-id="${s.id}" onclick="previewSample('${s.id}')">
      <div class="relative rounded-xl overflow-hidden mb-3 bg-bg h-24">
        <canvas class="lib-waveform w-full h-full" data-id="${s.id}"></canvas>
        <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="w-10 h-10 bg-brand text-txt rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-[24px] fill-1">play_arrow</span>
          </div>
        </div>
        <span class="absolute bottom-2 right-2 px-1.5 py-0.5 bg-black/75 text-[10px] font-mono text-txt rounded">${formatTime(s.duration)}</span>
        <span class="absolute top-2 left-2 px-2 py-0.5 bg-black/70 text-[10px] font-bold rounded uppercase ${s.type === 'loop' ? 'text-brand' : 'text-blue-400'}">${s.type}</span>
      </div>
      <div class="flex items-center justify-between">
        <div class="min-w-0 flex-1">
          <h4 class="font-bold text-sm truncate">${s.name}</h4>
          <p class="text-[10px] text-txt-muted">${meta}</p>
        </div>
        <button class="p-1.5 text-txt-muted hover:text-brand flex-shrink-0" onclick="event.stopPropagation(); toggleSampleFavorite('${s.id}')">
          <span class="material-symbols-outlined text-[18px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span>
        </button>
      </div>
    </div>`;
}

function setLibType(type, btn) {
  state.libraryType = type;
  btn.closest('.flex').querySelectorAll('.param-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderLibrary();
}

function setLibView(view) {
  state.libraryView = view;
  document.getElementById('lib-grid-btn').classList.toggle('text-brand', view === 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('text-txt-muted', view !== 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('bg-surface', view === 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('border', view === 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('border-border', view === 'grid');
  document.getElementById('lib-list-btn').classList.toggle('text-brand', view === 'list');
  document.getElementById('lib-list-btn').classList.toggle('text-txt-muted', view !== 'list');
  document.getElementById('lib-list-btn').classList.toggle('bg-surface', view === 'list');
  document.getElementById('lib-list-btn').classList.toggle('border', view === 'list');
  document.getElementById('lib-list-btn').classList.toggle('border-border', view === 'list');
  renderLibrary();
}

function toggleSampleSelect(id) {
  if (state.selectedSamples.has(id)) state.selectedSamples.delete(id);
  else state.selectedSamples.add(id);
  updateBatchBar();
  renderLibrary();
}

function toggleSelectAll(checkbox) {
  const list = getLibrarySamples();
  if (checkbox.checked) list.forEach(s => state.selectedSamples.add(s.id));
  else state.selectedSamples.clear();
  updateBatchBar();
  renderLibrary();
}

function updateBatchBar() {
  const bar = document.getElementById('lib-batch-bar');
  if (state.selectedSamples.size > 0) {
    bar.classList.remove('hidden');
    document.getElementById('batch-count').textContent = state.selectedSamples.size;
    bar.style.bottom = state.currentSample ? '64px' : '0px';
  } else {
    bar.classList.add('hidden');
  }
}

function audioBufferToWav(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const format = 1; // PCM
  const bitDepth = 16;
  const bytesPerSample = bitDepth / 8;
  const blockAlign = numChannels * bytesPerSample;
  const dataLength = buffer.length * blockAlign;
  const headerLength = 44;
  const totalLength = headerLength + dataLength;
  const arrayBuffer = new ArrayBuffer(totalLength);
  const view = new DataView(arrayBuffer);

  function writeString(offset, str) {
    for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
  }

  writeString(0, 'RIFF');
  view.setUint32(4, totalLength - 8, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, format, true);
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * blockAlign, true);
  view.setUint16(32, blockAlign, true);
  view.setUint16(34, bitDepth, true);
  writeString(36, 'data');
  view.setUint32(40, dataLength, true);

  const channels = [];
  for (let ch = 0; ch < numChannels; ch++) channels.push(buffer.getChannelData(ch));

  let offset = 44;
  for (let i = 0; i < buffer.length; i++) {
    for (let ch = 0; ch < numChannels; ch++) {
      const sample = Math.max(-1, Math.min(1, channels[ch][i]));
      view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
      offset += 2;
    }
  }
  return arrayBuffer;
}

function sanitizeFilename(name) {
  return name.replace(/[^a-zA-Z0-9_\-\s]/g, '').replace(/\s+/g, '_');
}

function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function downloadSample(id) {
  const s = samples[id];
  if (!s) return;
  ensureAudioContext();
  showToast('Preparing download...');
  getAudioBuffer(id).then(buf => {
    if (!buf) { showToast('No audio to download'); return; }
    const wav = audioBufferToWav(buf);
    const blob = new Blob([wav], { type: 'audio/wav' });
    triggerDownload(blob, sanitizeFilename(s.name) + '.wav');
    showToast('Downloaded ' + s.name + '.wav');
  });
}

function favoriteSelected() {
  state.selectedSamples.forEach(id => {
    const s = samples[id]; if (s && !s.isFavorite) { s.isFavorite = true; s.favoritedAt = Date.now(); }
  });
  saveData(); renderLibrary(); showToast(`${state.selectedSamples.size} samples favorited`);
}

function deleteSampleConfirm(id) {
  const s = samples[id]; if (!s) return;
  document.getElementById('confirm-title').textContent = 'Delete Sample';
  document.getElementById('confirm-msg').textContent = `Are you sure you want to delete "${s.name}"?`;
  document.getElementById('confirm-action').onclick = () => { deleteSample(id); closeModal(); };
  document.getElementById('confirm-modal').classList.add('open');
}

function deleteSample(id) {
  delete samples[id];
  delete audioBuffers[id];
  deleteAudioBlob(id);
  state.selectedSamples.delete(id);
  saveData();
  if (state.currentSample === id) { state.currentSample = null; stopCurrentSource(); document.getElementById('player-bar').style.display = 'none'; }
  if (state.inspectedSample === id) closeInspector();
  renderLibrary();
  showToast('Sample deleted');
}

function deleteSelected() {
  if (state.selectedSamples.size === 0) return;
  document.getElementById('confirm-title').textContent = 'Delete Samples';
  document.getElementById('confirm-msg').textContent = `Delete ${state.selectedSamples.size} selected samples?`;
  document.getElementById('confirm-action').onclick = () => {
    state.selectedSamples.forEach(id => { delete samples[id]; delete audioBuffers[id]; deleteAudioBlob(id); });
    state.selectedSamples.clear();
    saveData(); closeModal(); renderLibrary(); showToast('Samples deleted');
  };
  document.getElementById('confirm-modal').classList.add('open');
}

// ==================== FAVORITES PAGE ====================
function renderFavorites() {
  let list = Object.values(samples).filter(s => s.isFavorite && s.projectId === currentProjectId);
  const search = (document.getElementById('fav-search')?.value || '').toLowerCase();
  const sort = document.getElementById('fav-sort')?.value || 'fav-recent';

  if (search) list = list.filter(s => s.name.toLowerCase().includes(search) || s.tags.some(t => t.toLowerCase().includes(search)));

  if (sort === 'fav-recent') list.sort((a, b) => (b.favoritedAt || 0) - (a.favoritedAt || 0));
  else if (sort === 'recent') list.sort((a, b) => b.createdAt - a.createdAt);
  else if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));
  else if (sort === 'bpm') list.sort((a, b) => (a.bpm || 0) - (b.bpm || 0));

  document.getElementById('fav-count').textContent = list.length;

  if (!list.length) {
    document.getElementById('fav-grid').classList.add('hidden');
    document.getElementById('fav-empty').classList.remove('hidden');
    return;
  }
  document.getElementById('fav-empty').classList.add('hidden');
  document.getElementById('fav-grid').classList.remove('hidden');
  document.getElementById('fav-grid').innerHTML = list.map(s => renderSampleCard(s)).join('');
  requestAnimationFrame(() => {
    document.getElementById('fav-grid').querySelectorAll('.lib-waveform').forEach(canvas => {
      const s = samples[canvas.dataset.id];
      if (s) drawWaveform(canvas, s.waveformData, '#E85002');
    });
  });
}

// ==================== HISTORY PAGE ====================
function renderHistory() {
  const search = (document.getElementById('hist-search')?.value || '').toLowerCase();
  const typeFilter = document.getElementById('hist-type-filter')?.value || 'all';
  let list = Object.values(sessions).filter(s => s.projectId === currentProjectId);

  if (search) list = list.filter(s => JSON.stringify(s.params).toLowerCase().includes(search));
  if (typeFilter !== 'all') list = list.filter(s => s.type === typeFilter);
  list.sort((a, b) => b.createdAt - a.createdAt);

  if (!list.length) {
    document.getElementById('hist-timeline').classList.add('hidden');
    document.getElementById('hist-empty').classList.remove('hidden');
    return;
  }
  document.getElementById('hist-empty').classList.add('hidden');
  document.getElementById('hist-timeline').classList.remove('hidden');

  // Group by date
  const groups = {};
  list.forEach(s => {
    const d = new Date(s.createdAt);
    const today = new Date();
    let label;
    if (d.toDateString() === today.toDateString()) label = 'Today';
    else {
      const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
      if (d.toDateString() === yesterday.toDateString()) label = 'Yesterday';
      else label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    if (!groups[label]) groups[label] = [];
    groups[label].push(s);
  });

  document.getElementById('hist-timeline').innerHTML = Object.entries(groups).map(([label, items]) => `
    <div class="mb-6">
      <h4 class="text-xs font-bold text-txt-dim uppercase tracking-wider mb-3">${label}</h4>
      <div class="space-y-3">
        ${items.map(s => {
          const p = s.params;
          const paramStr = s.type === 'dna-pack'
            ? `Sound DNA Pack / ${p.bpm} BPM / ${p.key}${p.styles?.length ? ' / ' + p.styles.slice(0, 3).join(', ') : ''}`
            : s.type === 'loop'
            ? `${p.bpm} BPM / ${p.key} / ${p.bars} bars${p.styles?.length ? ' / ' + p.styles.join(', ') : ''}`
            : `${p.tuning} / ${p.attack} / ${p.timbre}${p.styles?.length ? ' / ' + p.styles.join(', ') : ''}`;
          const time = new Date(s.createdAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          return `
          <div class="history-item">
            <div class="history-dot ${s.type === 'dna-pack' ? 'loop' : s.type}"></div>
            <div class="bg-panel border border-border rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${s.type === 'dna-pack' ? 'badge-loop' : s.type === 'loop' ? 'badge-loop' : 'badge-oneshot'}">${s.type === 'dna-pack' ? 'DNA PACK' : s.type}</span>
                  <span class="text-sm font-bold">${s.variationIds.length} ${s.type === 'dna-pack' ? 'samples' : 'variations'}</span>
                </div>
                <span class="text-xs text-txt-dim">${time}</span>
              </div>
              <p class="text-xs text-txt-muted mb-3">${paramStr}</p>
              <div class="flex items-center gap-4 text-xs">
                <span class="text-emerald-400">Accepted: ${s.acceptedCount}</span>
                <span class="text-red-400">Rejected: ${s.rejectedCount}</span>
                <span class="text-txt-dim">Pending: ${s.variationIds.length - s.acceptedCount - s.rejectedCount}</span>
              </div>
              <div class="flex gap-2 mt-3">
                <button class="text-xs text-brand hover:underline" onclick="viewSessionVariations('${s.id}')">View Variations</button>
                <button class="text-xs text-txt-muted hover:text-txt" onclick="regenerateSession('${s.id}')">Re-generate</button>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`).join('');
}

function viewSessionVariations(sessionId) {
  const session = sessions[sessionId];
  if (!session) return;
  currentVariations = session.variationIds;
  navigateTo('generate');
  // Restore params
  const p = session.params;
  setGenerateMode(session.type);
  if (session.type === 'loop') {
    document.getElementById('bpm-input').value = p.bpm || 120;
    document.getElementById('bpm-slider').value = p.bpm || 120;
    document.getElementById('key-select').value = p.key || 'C';
  }
  document.getElementById('gen-empty').classList.add('hidden');
  document.getElementById('gen-var-count').textContent = currentVariations.length + ' variations';
  renderVariations();
}

function regenerateSession(sessionId) {
  const session = sessions[sessionId];
  if (!session) return;
  navigateTo('generate');
  const p = session.params;
  setGenerateMode(session.type);
  if (session.type === 'loop') {
    document.getElementById('bpm-input').value = p.bpm || 120;
    document.getElementById('bpm-slider').value = p.bpm || 120;
    document.getElementById('key-select').value = p.key || 'C';
  }
  generateSamples();
}

// ==================== IMPORT FROM PROJECT ====================
let importSelectedIds = new Set();

function openImportModal() {
  importSelectedIds.clear();
  const select = document.getElementById('import-project-select');
  select.innerHTML = '<option value="">Select a project...</option>';
  Object.values(projects).filter(p => p.id !== currentProjectId).forEach(p => {
    const count = Object.values(samples).filter(s => s.projectId === p.id && s.isInLibrary).length;
    select.innerHTML += `<option value="${p.id}">${p.name} (${count} samples)</option>`;
  });
  document.getElementById('import-sample-list').innerHTML = '<p class="text-sm text-txt-dim text-center py-8">Select a project to see its samples</p>';
  document.getElementById('import-selected-count').textContent = '0';
  document.getElementById('import-modal').classList.add('open');
}

function renderImportList() {
  const projectId = document.getElementById('import-project-select').value;
  const listEl = document.getElementById('import-sample-list');
  importSelectedIds.clear();
  document.getElementById('import-selected-count').textContent = '0';

  if (!projectId) {
    listEl.innerHTML = '<p class="text-sm text-txt-dim text-center py-8">Select a project to see its samples</p>';
    return;
  }

  const projectSamples = Object.values(samples).filter(s => s.projectId === projectId && s.isInLibrary);
  if (!projectSamples.length) {
    listEl.innerHTML = '<p class="text-sm text-txt-dim text-center py-8">No samples in this project</p>';
    return;
  }

  listEl.innerHTML = projectSamples.map(s => {
    const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack}`;
    const typeBadge = s.type === 'loop' ? 'badge-loop' : 'badge-oneshot';
    return `
      <label class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-surface transition-colors cursor-pointer border border-transparent has-[:checked]:border-brand/30 has-[:checked]:bg-brand/5">
        <input type="checkbox" class="rounded border-border text-brand" value="${s.id}" onchange="toggleImportSelect(this)"/>
        <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${typeBadge}">${s.type}</span>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">${s.name}</p>
          <p class="text-[10px] text-txt-dim">${meta}</p>
        </div>
        <span class="text-[10px] font-mono text-txt-dim">${formatTime(s.duration)}</span>
      </label>`;
  }).join('');
}

function toggleImportSelect(checkbox) {
  if (checkbox.checked) importSelectedIds.add(checkbox.value);
  else importSelectedIds.delete(checkbox.value);
  document.getElementById('import-selected-count').textContent = importSelectedIds.size;
}

function importSelectedSamples() {
  if (!importSelectedIds.size) { showToast('No samples selected'); return; }
  let count = 0;
  importSelectedIds.forEach(originalId => {
    const original = samples[originalId];
    if (!original) return;
    const newId = uid('smp');
    samples[newId] = {
      ...JSON.parse(JSON.stringify(original)),
      id: newId,
      projectId: currentProjectId,
      createdAt: Date.now(),
      waveformData: [...original.waveformData],
    };
    count++;
  });
  importSelectedIds.clear();
  saveData();
  closeModal();
  renderLibrary();
  renderProjectSwitcher();
  showToast(`${count} sample${count !== 1 ? 's' : ''} imported!`);
}

// ==================== SETTINGS ====================
function openSettingsModal() {
  const input = document.getElementById('settings-api-key');
  input.value = ELEVENLABS_API_KEY;
  input.type = 'password';
  document.getElementById('api-key-eye').textContent = 'visibility_off';
  document.getElementById('api-status').innerHTML = ELEVENLABS_API_KEY
    ? '<span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span><span class="text-xs text-emerald-400 font-medium">Key saved</span>'
    : '<span class="w-2 h-2 rounded-full bg-txt-dim flex-shrink-0"></span><span class="text-xs text-txt-dim font-medium">No key set</span>';
  document.getElementById('settings-modal').classList.add('open');
}

function closeSettingsModal() {
  document.getElementById('settings-modal').classList.remove('open');
}

function toggleApiKeyVisibility() {
  const input = document.getElementById('settings-api-key');
  const eye = document.getElementById('api-key-eye');
  if (input.type === 'password') {
    input.type = 'text';
    eye.textContent = 'visibility';
  } else {
    input.type = 'password';
    eye.textContent = 'visibility_off';
  }
}

function saveApiKey() {
  const key = document.getElementById('settings-api-key').value.trim();
  ELEVENLABS_API_KEY = key;
  localStorage.setItem('fiire_api_key', key);
  document.getElementById('api-status').innerHTML = key
    ? '<span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span><span class="text-xs text-emerald-400 font-medium">Key saved</span>'
    : '<span class="w-2 h-2 rounded-full bg-txt-dim flex-shrink-0"></span><span class="text-xs text-txt-dim font-medium">Key removed</span>';
  showToast(key ? 'API key saved' : 'API key removed');
}

function testApiKey() {
  const key = document.getElementById('settings-api-key').value.trim();
  if (!key) {
    document.getElementById('api-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0"></span><span class="text-xs text-red-400 font-medium">Enter a key first</span>';
    return;
  }

  const btn = document.getElementById('api-test-btn');
  const label = document.getElementById('api-test-label');
  btn.disabled = true;
  label.textContent = 'Testing...';

  // Test with a minimal SFX generation request
  fetch('https://api.elevenlabs.io/v1/sound-generation?output_format=mp3_22050_32', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'xi-api-key': key },
    body: JSON.stringify({
      text: 'short click',
      duration_seconds: 0.5,
      prompt_influence: 0.3,
      model_id: 'eleven_text_to_sound_v2',
    }),
  }).then(res => {
    if (res.ok) {
      document.getElementById('api-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span><span class="text-xs text-emerald-400 font-medium">Connected!</span>';
      showToast('API key is valid!');
    } else {
      return res.text().then(t => {
        let msg = 'Invalid key';
        try { const j = JSON.parse(t); msg = j.detail?.message || j.detail || msg; } catch(e) {}
        document.getElementById('api-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0"></span><span class="text-xs text-red-400 font-medium">${msg}</span>`;
        showToast('API key test failed');
      });
    }
  }).catch(err => {
    document.getElementById('api-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0"></span><span class="text-xs text-red-400 font-medium">Network error</span>';
    showToast('Connection failed');
  }).finally(() => {
    btn.disabled = false;
    label.textContent = 'Test Connection';
  });
}

function clearAllDataConfirm() {
  closeSettingsModal();
  document.getElementById('confirm-title').textContent = 'Clear All Data';
  document.getElementById('confirm-msg').textContent = 'This will delete all samples, projects, and cached audio. This cannot be undone.';
  document.getElementById('confirm-action').onclick = () => {
    localStorage.removeItem('fiire_samples');
    localStorage.removeItem('fiire_sessions');
    localStorage.removeItem('fiire_decisions');
    localStorage.removeItem('fiire_counters');
    localStorage.removeItem('fiire_projects');
    localStorage.removeItem('fiire_current_project');
    // Clear DNA profiles
    Object.keys(localStorage).filter(k => k.startsWith('fiire_dna_')).forEach(k => localStorage.removeItem(k));
    // Clear IndexedDB
    try { indexedDB.deleteDatabase(AUDIO_DB_NAME); } catch(e) {}
    closeModal();
    showToast('All data cleared â€” reloading...');
    setTimeout(() => location.reload(), 1000);
  };
  document.getElementById('confirm-modal').classList.add('open');
}

// ==================== KEYBOARD SHORTCUTS ====================
function getNavigableSamples() {
  return Object.values(samples)
    .filter(s => s.projectId === currentProjectId)
    .sort((a, b) => b.createdAt - a.createdAt);
}

function navigateSample(direction) {
  const list = getNavigableSamples();
  if (!list.length) return;
  if (!state.currentSample) { previewSample(list[0].id); return; }
  const idx = list.findIndex(s => s.id === state.currentSample);
  const next = idx + direction;
  if (next >= 0 && next < list.length) previewSample(list[next].id);
}

document.addEventListener('keydown', e => {
  if (e.code === 'Escape') { closeModal(); return; }
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.code === 'Space' && state.currentSample) { e.preventDefault(); togglePlayPause(); }
});

// ==================== SEED DATA ====================
function seedDemoData() {
  if (Object.keys(samples).length > 0) return; // already has data

  const sessionId = uid('ses');
  const sessionId2 = uid('ses');
  const sessionId3 = uid('ses');

  const demoSamples = [
    { name: 'Dusty Kick 001', type: 'loop', status: 'accepted', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 002', type: 'loop', status: 'accepted', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 003', type: 'loop', status: 'rejected', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId, feedback: 'too_muddy' },
    { name: 'Dusty Kick 004', type: 'loop', status: 'pending', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 005', type: 'loop', status: 'pending', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 006', type: 'loop', status: 'pending', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Crispy Hat Loop', type: 'loop', status: 'accepted', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2 },
    { name: 'Crispy Hat Var 2', type: 'loop', status: 'accepted', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2 },
    { name: 'Crispy Hat Var 3', type: 'loop', status: 'rejected', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2, feedback: 'too_busy' },
    { name: 'Crispy Hat Var 4', type: 'loop', status: 'pending', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2 },
    { name: 'Warm Snare Hit', type: 'oneshot', status: 'accepted', tuning: 'C4', attack: 'Snappy', timbre: 'Warm', style: ['Analog', 'Punchy'], duration: 0.45, session: sessionId3 },
    { name: 'Warm Snare Var 2', type: 'oneshot', status: 'accepted', tuning: 'C4', attack: 'Snappy', timbre: 'Warm', style: ['Analog', 'Punchy'], duration: 0.52, session: sessionId3 },
    { name: 'Warm Snare Var 3', type: 'oneshot', status: 'pending', tuning: 'C4', attack: 'Punchy', timbre: 'Warm', style: ['Analog', 'Punchy'], duration: 0.38, session: sessionId3 },
    { name: 'Warm Snare Var 4', type: 'oneshot', status: 'pending', tuning: 'C4', attack: 'Soft', timbre: 'Dark', style: ['Analog'], duration: 0.61, session: sessionId3 },
    { name: 'Analog Clap 001', type: 'oneshot', status: 'accepted', tuning: 'D4', attack: 'Transient', timbre: 'Bright', style: ['Analog', 'Crispy'], duration: 0.33, session: sessionId3, fav: true },
    { name: 'Sub Bass Loop', type: 'loop', status: 'accepted', bpm: 140, key: 'F', bars: 8, style: ['Clean', 'Digital'], duration: 6.86, session: sessionId2, fav: true },
  ];

  const sessionMap = {};
  demoSamples.forEach((d, i) => {
    const id = uid('smp');
    const ts = Date.now() - (demoSamples.length - i) * 60000;
    samples[id] = {
      id, type: d.type, name: d.name, status: d.status,
      duration: d.duration,
      bpm: d.bpm || null, key: d.key || null, bars: d.bars || null,
      tuning: d.tuning || null, attack: d.attack || null, timbre: d.timbre || null,
      style: d.style || [], tags: d.style ? [...d.style] : [], notes: '',
      effects: {},
      generationSessionId: d.session,
      variationIndex: i, parentSampleId: null,
      modelVersion: 'ElevenLabs SFX v2',
      createdAt: ts,
      acceptedAt: d.status === 'accepted' ? ts + 1000 : null,
      favoritedAt: d.fav ? ts + 2000 : null,
      isFavorite: !!d.fav,
      isInLibrary: d.status === 'accepted',
      rejectionFeedback: d.feedback || null,
      waveformData: placeholderWaveform(80),
      projectId: 'proj_default',
    };
    if (!sessionMap[d.session]) sessionMap[d.session] = [];
    sessionMap[d.session].push(id);
    if (d.status === 'accepted' || d.status === 'rejected') {
      decisions.push({ sampleId: id, action: d.status === 'accepted' ? 'accept' : 'reject', feedback: d.feedback, timestamp: ts });
    }
  });

  // Create sessions
  sessions[sessionId] = {
    id: sessionId, type: 'loop',
    params: { type: 'loop', bpm: 90, key: 'Cm', bars: 4, styles: ['Dusty', 'Lo-fi'], varCount: 6, model: 'ElevenLabs SFX v2' },
    variationIds: sessionMap[sessionId] || [], acceptedCount: 2, rejectedCount: 1,
    createdAt: Date.now() - 900000, projectId: 'proj_default',
  };
  sessions[sessionId2] = {
    id: sessionId2, type: 'loop',
    params: { type: 'loop', bpm: 120, key: 'C', bars: 2, styles: ['Crispy', 'Digital'], varCount: 4, model: 'ElevenLabs SFX v2' },
    variationIds: sessionMap[sessionId2] || [], acceptedCount: 3, rejectedCount: 1,
    createdAt: Date.now() - 600000, projectId: 'proj_default',
  };
  sessions[sessionId3] = {
    id: sessionId3, type: 'oneshot',
    params: { type: 'oneshot', tuning: 'C4', attack: 'Snappy', timbre: 'Warm', styles: ['Analog', 'Punchy'], varCount: 5, model: 'ElevenLabs SFX v2' },
    variationIds: sessionMap[sessionId3] || [], acceptedCount: 3, rejectedCount: 0,
    createdAt: Date.now() - 300000, projectId: 'proj_default',
  };

  saveData();
}

// ==================== SOUND DNA ====================

const DNA_PACK_CATEGORIES = [
  { name: 'Drums', icon: 'percussion', count: 4, type: 'loop',
    templates: ['full drum loop with kick snare and hi-hats','kick and percussion pattern','hi-hat and cymbal pattern','snare and clap pattern with ghost notes'] },
  { name: 'Bass', icon: 'graphic_eq', count: 4, type: 'loop',
    templates: ['bass line with rhythmic movement','sub bass pattern','bass stab pattern','bass groove with slides'] },
  { name: 'Melodic', icon: 'piano', count: 4, type: 'loop',
    templates: ['melodic phrase with chord progression','arpeggio pattern','lead melody line','chord pad with movement'] },
  { name: 'Textures', icon: 'waves', count: 4, type: 'oneshot',
    templates: ['atmospheric texture and ambience','impact and riser effect','foley texture and noise','transitional sweep effect'] },
];

const KEY_PROFILES = {
  major: [6.35,2.23,3.48,2.33,4.38,4.09,2.52,5.19,2.39,3.66,2.29,2.88],
  minor: [6.33,2.68,3.52,5.38,2.60,3.53,2.54,4.75,3.98,2.69,3.34,3.17],
};
const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

// --- File Upload & Decode ---
function handleDnaFileSelect(input) {
  const files = Array.from(input.files || []).filter(f =>
    f.type.startsWith('audio/') || f.name.match(/\.(wav|mp3)$/i)
  ).slice(0, 10);
  if (!files.length) { showToast('No audio files selected'); return; }
  ensureAudioContext();

  files.forEach(file => {
    if (dnaFiles.length >= 10) return;
    if (dnaFiles.find(d => d.name === file.name)) return;
    const entry = { file, name: file.name, buffer: null, analysis: null, status: 'loading' };
    dnaFiles.push(entry);

    const reader = new FileReader();
    reader.onload = e => {
      audioCtx.decodeAudioData(e.target.result.slice(0)).then(buf => {
        entry.buffer = buf;
        entry.status = 'ready';
        renderDnaTrackList();
      }).catch(() => {
        entry.status = 'error';
        renderDnaTrackList();
        showToast('Could not decode ' + file.name);
      });
    };
    reader.readAsArrayBuffer(file);
  });

  if (input.value !== undefined) input.value = '';
  renderDnaTrackList();
}

function initDnaDropZone() {
  const zone = document.getElementById('dna-drop-zone');
  if (!zone || zone._dnaInit) return;
  zone._dnaInit = true;
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dna-drop-active'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dna-drop-active'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('dna-drop-active');
    if (e.dataTransfer.files.length) handleDnaFileSelect({ files: e.dataTransfer.files });
  });
}

function renderDnaTrackList() {
  const list = document.getElementById('dna-track-list');
  const actions = document.getElementById('dna-track-actions');
  if (!dnaFiles.length) { list.classList.add('hidden'); actions.classList.add('hidden'); return; }

  list.classList.remove('hidden');
  actions.classList.remove('hidden');
  document.getElementById('dna-track-count').textContent = dnaFiles.filter(d => d.status === 'ready' || d.status === 'analyzed').length;

  list.innerHTML = dnaFiles.map((d, i) => {
    const icon = d.status === 'loading' ? 'hourglass_top' : d.status === 'error' ? 'error' : d.status === 'analyzed' ? 'check_circle' : 'audio_file';
    const iconColor = d.status === 'error' ? 'text-red-400' : d.status === 'analyzed' ? 'text-emerald-400' : 'text-txt-dim';
    const dur = d.buffer ? (d.buffer.duration / 60).toFixed(1) + ' min' : '';
    return `<div class="dna-track-item flex items-center gap-3 bg-surface border border-border rounded-xl px-4 py-2.5">
      <span class="material-symbols-outlined ${iconColor} text-[20px]">${icon}</span>
      <span class="flex-1 text-sm font-medium truncate">${d.name}</span>
      <span class="text-xs text-txt-dim">${dur}</span>
      <button class="text-txt-dim hover:text-red-400 transition-colors" onclick="removeDnaTrack(${i})">
        <span class="material-symbols-outlined text-[16px]">close</span>
      </button>
    </div>`;
  }).join('');
}

function removeDnaTrack(idx) {
  dnaFiles.splice(idx, 1);
  renderDnaTrackList();
}

function clearDnaTracks() {
  dnaFiles = [];
  dnaProfile = null;
  dnaCategoryResults = [];
  document.getElementById('dna-profile-section').classList.add('hidden');
  document.getElementById('dna-analysis-section').classList.add('hidden');
  document.getElementById('dna-results-section').classList.add('hidden');
  renderDnaTrackList();
}

// --- Audio Analysis ---
function detectBPM(audioBuffer) {
  const data = audioBuffer.getChannelData(0);
  const sr = audioBuffer.sampleRate;
  const winSize = 1024, hopSize = 512;
  const numFrames = Math.floor((data.length - winSize) / hopSize);
  if (numFrames < 2) return { bpm: 120, confidence: 0 };

  const energies = [];
  for (let i = 0; i < numFrames; i++) {
    const start = i * hopSize;
    let sum = 0;
    for (let j = start; j < start + winSize; j++) sum += data[j] * data[j];
    energies.push(sum / winSize);
  }

  const onsets = [];
  for (let i = 1; i < energies.length; i++) onsets.push(Math.max(0, energies[i] - energies[i - 1]));

  const mean = onsets.reduce((a, b) => a + b, 0) / onsets.length;
  const threshold = mean * 1.5;
  const peaks = [];
  for (let i = 1; i < onsets.length - 1; i++) {
    if (onsets[i] > threshold && onsets[i] > onsets[i - 1] && onsets[i] > onsets[i + 1]) {
      peaks.push(i * hopSize / sr);
    }
  }
  if (peaks.length < 2) return { bpm: 120, confidence: 0 };

  const iois = [];
  for (let i = 1; i < peaks.length; i++) iois.push(peaks[i] - peaks[i - 1]);

  const bpmCounts = {};
  iois.forEach(ioi => {
    let bpm = Math.round(60 / ioi);
    while (bpm > 200) bpm = Math.round(bpm / 2);
    while (bpm < 60) bpm = bpm * 2;
    bpm = Math.round(bpm);
    bpmCounts[bpm] = (bpmCounts[bpm] || 0) + 1;
  });

  let bestBpm = 120, bestCount = 0;
  Object.entries(bpmCounts).forEach(([b, c]) => {
    const bInt = parseInt(b);
    const cluster = c + (bpmCounts[bInt - 1] || 0) + (bpmCounts[bInt + 1] || 0);
    if (cluster > bestCount) { bestCount = cluster; bestBpm = bInt; }
  });

  return { bpm: bestBpm, confidence: Math.min(1, bestCount / iois.length) };
}

function detectKey(audioBuffer) {
  const data = audioBuffer.getChannelData(0);
  const sr = audioBuffer.sampleRate;
  const fftSize = 4096;
  const numFrames = 8;
  const spacing = Math.max(1, Math.floor((data.length - fftSize) / numFrames));
  const chroma = new Float32Array(12);

  const minBin = Math.ceil(65 * fftSize / sr);
  const maxBin = Math.min(Math.floor(2000 * fftSize / sr), fftSize / 2);

  for (let f = 0; f < numFrames; f++) {
    const offset = f * spacing;
    if (offset + fftSize > data.length) break;
    for (let bin = minBin; bin <= maxBin; bin++) {
      let re = 0, im = 0;
      for (let n = 0; n < fftSize; n++) {
        const w = 0.5 * (1 - Math.cos(2 * Math.PI * n / (fftSize - 1)));
        const angle = -2 * Math.PI * bin * n / fftSize;
        re += data[offset + n] * w * Math.cos(angle);
        im += data[offset + n] * w * Math.sin(angle);
      }
      const mag = Math.sqrt(re * re + im * im);
      const freq = bin * sr / fftSize;
      const midi = 12 * Math.log2(freq / 440) + 69;
      const pc = ((Math.round(midi) % 12) + 12) % 12;
      chroma[pc] += mag;
    }
  }

  const maxVal = Math.max(...chroma);
  if (maxVal > 0) for (let i = 0; i < 12; i++) chroma[i] /= maxVal;

  let bestKey = 'C', bestCorr = -Infinity;
  for (let root = 0; root < 12; root++) {
    for (const mode of ['major', 'minor']) {
      const profile = KEY_PROFILES[mode];
      let corr = 0;
      for (let i = 0; i < 12; i++) corr += chroma[(root + i) % 12] * profile[i];
      if (corr > bestCorr) {
        bestCorr = corr;
        bestKey = NOTE_NAMES[root] + (mode === 'minor' ? 'm' : '');
      }
    }
  }
  return { key: bestKey, chroma: Array.from(chroma), confidence: bestCorr };
}

function analyzeEnergy(audioBuffer) {
  const data = audioBuffer.getChannelData(0);
  let sumSq = 0, peak = 0;
  for (let i = 0; i < data.length; i++) {
    const abs = Math.abs(data[i]);
    sumSq += data[i] * data[i];
    if (abs > peak) peak = abs;
  }
  const rms = Math.sqrt(sumSq / data.length);
  const rmsDb = 20 * Math.log10(rms + 1e-10);
  const peakDb = 20 * Math.log10(peak + 1e-10);
  const energyNorm = Math.max(0, Math.min(1, (rmsDb + 40) / 40));
  return {
    rms, rmsDb, peak, peakDb,
    energyNorm,
    dynamicRange: peakDb - rmsDb,
    label: energyNorm > 0.7 ? 'High' : energyNorm > 0.4 ? 'Medium' : 'Low'
  };
}

async function analyzeSpectrumFast(audioBuffer) {
  const bandDefs = [
    { name: 'sub', freq: 40, type: 'lowpass' },
    { name: 'bass', freq: 150, type: 'bandpass' },
    { name: 'lowMid', freq: 500, type: 'bandpass' },
    { name: 'mid', freq: 2000, type: 'bandpass' },
    { name: 'high', freq: 8000, type: 'bandpass' },
    { name: 'air', freq: 14000, type: 'highpass' },
  ];
  const results = {};
  for (const band of bandDefs) {
    const offCtx = new OfflineAudioContext(1, audioBuffer.length, audioBuffer.sampleRate);
    const src = offCtx.createBufferSource();
    src.buffer = audioBuffer;
    const filter = offCtx.createBiquadFilter();
    filter.type = band.type;
    filter.frequency.value = band.freq;
    filter.Q.value = 1;
    src.connect(filter);
    filter.connect(offCtx.destination);
    src.start();
    const rendered = await offCtx.startRendering();
    const ch = rendered.getChannelData(0);
    let sum = 0;
    for (let i = 0; i < ch.length; i++) sum += ch[i] * ch[i];
    results[band.name] = Math.sqrt(sum / ch.length);
  }
  return results;
}

async function analyzeTrack(audioBuffer) {
  const bpm = detectBPM(audioBuffer);
  const key = detectKey(audioBuffer);
  const energy = analyzeEnergy(audioBuffer);
  const spectrum = await analyzeSpectrumFast(audioBuffer);
  return { bpm, key, energy, spectrum, duration: audioBuffer.duration };
}

// --- Analysis Orchestration ---
function updateDnaProgress(current, total, label) {
  const pct = Math.round((current / total) * 100);
  document.getElementById('dna-progress-label').textContent = label;
  document.getElementById('dna-progress-pct').textContent = pct + '%';
  document.getElementById('dna-progress-bar').style.width = pct + '%';
}

async function analyzeDnaTracks() {
  const ready = dnaFiles.filter(d => d.status === 'ready' && d.buffer);
  if (ready.length < 2) { showToast('Upload at least 2 tracks'); return; }

  document.getElementById('dna-analysis-section').classList.remove('hidden');
  document.getElementById('dna-profile-section').classList.add('hidden');
  document.getElementById('dna-results-section').classList.add('hidden');
  const btn = document.getElementById('dna-analyze-btn');
  btn.disabled = true;
  btn.classList.add('opacity-50');

  for (let i = 0; i < ready.length; i++) {
    updateDnaProgress(i, ready.length, `Analyzing "${ready[i].name}"...`);
    try {
      ready[i].analysis = await analyzeTrack(ready[i].buffer);
      ready[i].status = 'analyzed';
    } catch (e) {
      console.error('Analysis failed:', ready[i].name, e);
      ready[i].status = 'error';
    }
    renderDnaTrackList();
    // Yield to UI
    await new Promise(r => setTimeout(r, 50));
  }

  updateDnaProgress(ready.length, ready.length, 'Building profile...');

  const analyzed = dnaFiles.filter(d => d.analysis);
  if (analyzed.length > 0) {
    dnaProfile = buildSoundProfile(analyzed.map(d => d.analysis));
    renderDnaProfile();
    saveDnaProfile();
    // Free memory from buffers
    dnaFiles.forEach(d => { d.buffer = null; });
  }

  btn.disabled = false;
  btn.classList.remove('opacity-50');
  document.getElementById('dna-analysis-section').classList.add('hidden');
  document.getElementById('dna-progress-container').classList.remove('dna-analyzing');
}

// --- Sound Profile ---
function buildSoundProfile(analyses) {
  const bpms = analyses.map(a => ({ bpm: a.bpm.bpm, confidence: a.bpm.confidence }));
  const weighted = bpms.filter(b => b.confidence > 0.2);
  const avgBpm = weighted.length > 0
    ? Math.round(weighted.reduce((s, b) => s + b.bpm * b.confidence, 0) / weighted.reduce((s, b) => s + b.confidence, 0))
    : 120;
  const bpmRange = { low: Math.min(...bpms.map(b => b.bpm)), high: Math.max(...bpms.map(b => b.bpm)), center: avgBpm };

  const keyCounts = {};
  analyses.forEach(a => { keyCounts[a.key.key] = (keyCounts[a.key.key] || 0) + a.key.confidence; });
  const dominantKey = Object.entries(keyCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || 'C';

  const avgChroma = new Float32Array(12);
  analyses.forEach(a => { for (let i = 0; i < 12; i++) avgChroma[i] += a.key.chroma[i]; });
  for (let i = 0; i < 12; i++) avgChroma[i] /= analyses.length;

  const avgEnergy = analyses.reduce((s, a) => s + a.energy.energyNorm, 0) / analyses.length;
  const avgDynamic = analyses.reduce((s, a) => s + a.energy.dynamicRange, 0) / analyses.length;

  const bandNames = Object.keys(analyses[0].spectrum);
  const avgSpectrum = {};
  bandNames.forEach(name => {
    avgSpectrum[name] = analyses.reduce((s, a) => s + a.spectrum[name], 0) / analyses.length;
  });
  const totalSpectrum = Object.values(avgSpectrum).reduce((s, v) => s + v, 0) || 1;
  const normSpectrum = {};
  bandNames.forEach(name => { normSpectrum[name] = avgSpectrum[name] / totalSpectrum; });

  const brightness = (normSpectrum.high + normSpectrum.air) / (normSpectrum.sub + normSpectrum.bass + 0.001);
  const warmth = (normSpectrum.sub + normSpectrum.bass + normSpectrum.lowMid) / (normSpectrum.mid + normSpectrum.high + 0.001);
  const brightnessNorm = Math.min(1, brightness / 2);
  const warmthNorm = Math.min(1, warmth / 3);

  const descriptors = [];
  if (avgBpm <= 80) descriptors.push('Slow');
  else if (avgBpm <= 110) descriptors.push('Mid-Tempo');
  else if (avgBpm <= 135) descriptors.push('Upbeat');
  else descriptors.push('High-Energy');

  if (avgEnergy > 0.7) { descriptors.push('Loud'); descriptors.push('Intense'); }
  else if (avgEnergy > 0.4) descriptors.push('Punchy');
  else { descriptors.push('Soft'); descriptors.push('Subtle'); }

  if (brightnessNorm > 0.6) { descriptors.push('Bright'); descriptors.push('Crispy'); }
  else if (brightnessNorm < 0.3) { descriptors.push('Dark'); descriptors.push('Heavy'); }
  if (warmthNorm > 0.6) { descriptors.push('Warm'); descriptors.push('Full'); }
  else if (warmthNorm < 0.3) { descriptors.push('Thin'); descriptors.push('Airy'); }

  if (normSpectrum.sub > 0.15) descriptors.push('Sub-Heavy');
  if (avgDynamic > 15) descriptors.push('Dynamic');
  else if (avgDynamic < 6) descriptors.push('Compressed');
  if (dominantKey.endsWith('m')) descriptors.push('Minor');
  else descriptors.push('Major');

  const tempoWord = avgBpm <= 90 ? 'Laid-Back' : avgBpm <= 120 ? 'Groovy' : avgBpm <= 140 ? 'Driving' : 'Fast';
  const toneWord = brightnessNorm > 0.5 ? 'Bright' : warmthNorm > 0.5 ? 'Warm' : 'Balanced';
  const energyWord = avgEnergy > 0.6 ? 'Powerful' : avgEnergy > 0.3 ? 'Smooth' : 'Delicate';

  return {
    bpmRange, dominantKey,
    avgChroma: Array.from(avgChroma),
    energy: avgEnergy,
    energyLabel: avgEnergy > 0.7 ? 'High' : avgEnergy > 0.4 ? 'Medium' : 'Low',
    brightness: brightnessNorm,
    warmth: warmthNorm,
    spectrum: normSpectrum,
    dynamicRange: avgDynamic,
    descriptors: [...new Set(descriptors)],
    title: `${tempoWord} ${toneWord} ${energyWord}`,
    subtitle: `${avgBpm} BPM / ${dominantKey} / ${analyses.length} tracks analyzed`,
    characteristics: {
      'Brightness': brightnessNorm,
      'Warmth': warmthNorm,
      'Energy': avgEnergy,
      'Low End': Math.min(1, (normSpectrum.sub + normSpectrum.bass) * 3),
      'Dynamics': Math.min(1, avgDynamic / 20),
    },
    trackCount: analyses.length,
    createdAt: Date.now(),
  };
}

function saveDnaProfile() {
  if (!dnaProfile || !currentProjectId) return;
  localStorage.setItem('fiire_dna_' + currentProjectId, JSON.stringify(dnaProfile));
}

function loadDnaProfile() {
  if (!currentProjectId) return null;
  try { return JSON.parse(localStorage.getItem('fiire_dna_' + currentProjectId)); } catch(e) { return null; }
}

// --- Profile Rendering ---
function renderDnaProfile() {
  if (!dnaProfile) return;
  document.getElementById('dna-profile-section').classList.remove('hidden');
  document.getElementById('dna-profile-title').textContent = dnaProfile.title;
  document.getElementById('dna-profile-subtitle').textContent = dnaProfile.subtitle;
  document.getElementById('dna-bpm').textContent = `${dnaProfile.bpmRange.low}â€“${dnaProfile.bpmRange.high} BPM (center: ${dnaProfile.bpmRange.center})`;
  document.getElementById('dna-key').textContent = dnaProfile.dominantKey;
  document.getElementById('dna-energy').textContent = dnaProfile.energyLabel;
  document.getElementById('dna-texture').textContent = dnaProfile.brightness > 0.5 ? 'Bright' : dnaProfile.warmth > 0.5 ? 'Warm' : 'Balanced';

  document.getElementById('dna-characteristics').innerHTML = Object.entries(dnaProfile.characteristics).map(([name, value]) => `
    <div>
      <div class="flex justify-between text-xs mb-1">
        <span class="text-txt-muted font-medium">${name}</span>
        <span class="text-txt-dim">${Math.round(value * 100)}%</span>
      </div>
      <div class="dna-bar"><div class="dna-bar-fill" style="width:${value * 100}%"></div></div>
    </div>`).join('');

  document.getElementById('dna-tags').innerHTML = dnaProfile.descriptors.map(d =>
    `<span class="px-2.5 py-1 bg-brand/10 border border-brand/20 rounded-lg text-xs text-brand font-medium">${d}</span>`
  ).join('');
}

function renderSoundDna() {
  const existing = loadDnaProfile();
  if (existing && !dnaProfile) {
    dnaProfile = existing;
    renderDnaProfile();
  }
  initDnaDropZone();
}

// --- Prompt Construction ---
function buildDnaPrompt(profile, category, templateIndex) {
  const template = category.templates[templateIndex];
  const parts = [template];
  if (category.type === 'loop') parts.push(profile.bpmRange.center + ' BPM');
  parts.push('in ' + profile.dominantKey);

  if (profile.brightness > 0.6) parts.push('bright and airy sound');
  else if (profile.brightness < 0.3) parts.push('dark and heavy sound');
  else if (profile.warmth > 0.6) parts.push('warm and full sound');
  else parts.push('balanced tone');

  if (profile.energy > 0.7) parts.push('high energy loud punchy');
  else if (profile.energy > 0.4) parts.push('moderate energy controlled');
  else parts.push('soft and subtle understated');

  const relevant = profile.descriptors
    .filter(d => !['Major','Minor'].includes(d))
    .slice(0, 3);
  if (relevant.length) parts.push(relevant.join(' ').toLowerCase());
  if (profile.spectrum && profile.spectrum.sub > 0.12) parts.push('deep sub bass presence');

  return parts.join(', ');
}

function calcDnaDuration(profile, category) {
  if (category.type === 'loop') {
    const bpm = profile.bpmRange.center;
    return Math.min(22, Math.max(2, 4 * (60 / bpm) * 4));
  }
  return 3;
}

// --- Pack Generation ---
async function generateDnaPack() {
  if (!dnaProfile) { showToast('Analyze tracks first'); return; }
  if (state.generating) return;
  if (!ELEVENLABS_API_KEY) { showToast('Set your ElevenLabs API key in Settings first'); return; }

  state.generating = true;
  document.getElementById('dna-results-section').classList.remove('hidden');
  document.getElementById('dna-gen-loading').classList.remove('hidden');
  document.getElementById('dna-results-grid').innerHTML = '';
  document.getElementById('dna-results-actions').classList.add('hidden');
  document.getElementById('dna-generate-btn').disabled = true;
  document.getElementById('dna-generate-btn').classList.add('opacity-50');

  const sessionId = uid('ses');
  const allIds = [];
  dnaCategoryResults = [];

  const totalSamples = DNA_PACK_CATEGORIES.reduce((s, c) => s + c.count, 0);
  let completed = 0, failed = 0;

  for (const category of DNA_PACK_CATEGORIES) {
    const catIds = [];
    for (let i = 0; i < category.count; i++) {
      const id = uid('smp');
      const prompt = buildDnaPrompt(dnaProfile, category, i);
      const duration = calcDnaDuration(dnaProfile, category);
      const isLoop = category.type === 'loop';

      samples[id] = {
        id, type: category.type,
        name: `DNA ${category.name} ${i + 1}`,
        status: 'pending',
        duration: Math.round(duration * 100) / 100,
        bpm: isLoop ? dnaProfile.bpmRange.center : null,
        key: dnaProfile.dominantKey,
        bars: isLoop ? 4 : null,
        tuning: null, attack: null, timbre: null,
        style: dnaProfile.descriptors.slice(0, 3),
        tags: ['Sound DNA', category.name, ...dnaProfile.descriptors.slice(0, 2)],
        notes: 'Generated from Sound DNA profile: ' + dnaProfile.title,
        effects: {},
        generationSessionId: sessionId,
        variationIndex: i,
        parentSampleId: null,
        modelVersion: 'ElevenLabs SFX v2',
        createdAt: Date.now() - (category.count - i) * 100,
        acceptedAt: null, favoritedAt: null,
        isFavorite: false, isInLibrary: false,
        rejectionFeedback: null,
        waveformData: placeholderWaveform(80),
        projectId: currentProjectId,
        dnaCategory: category.name,
        dnaPrompt: prompt,
      };
      catIds.push(id);
      allIds.push(id);
    }
    dnaCategoryResults.push({ category, ids: catIds });
  }

  sessions[sessionId] = {
    id: sessionId, type: 'dna-pack',
    params: { type: 'dna-pack', profile: dnaProfile.title, bpm: dnaProfile.bpmRange.center, key: dnaProfile.dominantKey, styles: dnaProfile.descriptors },
    variationIds: allIds,
    acceptedCount: 0, rejectedCount: 0,
    createdAt: Date.now(), projectId: currentProjectId,
  };

  currentVariations = allIds;
  saveData();

  // Build queue
  const queue = [];
  for (const { category, ids } of dnaCategoryResults) {
    for (let i = 0; i < ids.length; i++) {
      const s = samples[ids[i]];
      queue.push({ id: ids[i], prompt: s.dnaPrompt, duration: s.duration, isLoop: category.type === 'loop' });
    }
  }

  let queueIdx = 0;
  function processNext() {
    if (queueIdx >= queue.length) return Promise.resolve();
    const item = queue[queueIdx++];
    return callElevenLabsSfx(item.prompt, item.duration, item.isLoop)
      .then(pcmData => {
        ensureAudioContext();
        const buf = pcmToAudioBuffer(pcmData, 44100);
        samples[item.id].duration = buf.duration;
        cacheAndPersistBuffer(item.id, buf);
        saveData();
      })
      .catch(err => {
        console.error('DNA generation failed for ' + item.id + ':', err);
        failed++;
        ensureAudioContext();
        getAudioBuffer(item.id);
      })
      .finally(() => {
        completed++;
        document.getElementById('dna-gen-progress').textContent = completed + ' of ' + totalSamples + ' samples';
        if (completed === totalSamples) finishDnaGeneration(failed);
        return processNext();
      });
  }

  const workers = [];
  for (let w = 0; w < 2; w++) workers.push(processNext());
  await Promise.all(workers);
}

function finishDnaGeneration(failed) {
  state.generating = false;
  document.getElementById('dna-gen-loading').classList.add('hidden');
  document.getElementById('dna-results-actions').classList.remove('hidden');
  document.getElementById('dna-generate-btn').disabled = false;
  document.getElementById('dna-generate-btn').classList.remove('opacity-50');
  renderDnaResults();
  const total = dnaCategoryResults.reduce((s, c) => s + c.ids.length, 0);
  showToast(failed > 0 ? `Generated ${total - failed} samples (${failed} fell back to synthetic)` : 'Your Sound DNA pack is ready!');
}

function renderDnaResults() {
  const container = document.getElementById('dna-results-grid');
  container.innerHTML = dnaCategoryResults.map(({ category, ids }) => {
    const cards = ids.map(id => {
      const s = samples[id];
      if (!s) return '';
      const statusClass = s.status === 'accepted' ? 'accepted' : s.status === 'rejected' ? 'rejected' : '';
      const isPlaying = state.currentSample === id && state.isPlaying;
      return `<div class="variation-card border border-border rounded-xl p-3 flex items-center gap-3 ${statusClass} ${isPlaying ? 'playing' : ''}" data-id="${id}">
        <button class="w-8 h-8 rounded-lg bg-surface flex items-center justify-center flex-shrink-0 hover:bg-dk-gray transition-colors" onclick="previewSample('${id}')">
          <span class="material-symbols-outlined text-[18px] ${isPlaying ? 'text-brand fill-1' : 'text-txt-muted'}">${isPlaying ? 'pause' : 'play_arrow'}</span>
        </button>
        <canvas class="var-waveform flex-1 h-8 rounded" data-id="${id}" width="200" height="32"></canvas>
        <div class="flex items-center gap-1.5 flex-shrink-0">
          <span class="text-xs text-txt-muted font-medium">${s.name}</span>
          <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${s.type === 'loop' ? 'badge-loop' : 'badge-oneshot'}">${s.type}</span>
        </div>
        <div class="flex items-center gap-1 flex-shrink-0">
          <button class="p-1 rounded hover:bg-surface transition-colors" title="Accept" onclick="acceptDnaSample('${id}')">
            <span class="material-symbols-outlined text-[16px] ${s.status === 'accepted' ? 'text-emerald-400 fill-1' : 'text-txt-dim'}">check_circle</span>
          </button>
          <button class="p-1 rounded hover:bg-surface transition-colors" title="Download" onclick="downloadSample('${id}')">
            <span class="material-symbols-outlined text-[16px] text-txt-dim">download</span>
          </button>
        </div>
      </div>`;
    }).join('');
    return `<div>
      <div class="flex items-center gap-2 mb-2">
        <span class="material-symbols-outlined text-brand text-[18px]">${category.icon}</span>
        <h4 class="text-sm font-bold">${category.name}</h4>
        <span class="text-[10px] text-txt-dim">${ids.length} samples</span>
      </div>
      <div class="space-y-1.5">${cards}</div>
    </div>`;
  }).join('');

  requestAnimationFrame(() => {
    document.querySelectorAll('#dna-results-grid .var-waveform').forEach(canvas => {
      const id = canvas.dataset.id;
      const s = samples[id];
      if (s) drawWaveform(canvas, s.waveformData, s.status === 'rejected' ? '#444' : '#E85002');
    });
  });
}

function acceptDnaSample(id) {
  const s = samples[id];
  if (!s || s.status === 'accepted') return;
  s.status = 'accepted';
  s.acceptedAt = Date.now();
  s.isInLibrary = true;
  const session = sessions[s.generationSessionId];
  if (session) session.acceptedCount++;
  decisions.push({ sampleId: id, action: 'accept', timestamp: Date.now() });
  saveData();
  renderDnaResults();
  showToast(s.name + ' accepted & added to library!');
}

function acceptAllDnaSamples() {
  let count = 0;
  currentVariations.forEach(id => {
    const s = samples[id];
    if (s && s.status !== 'accepted') {
      s.status = 'accepted';
      s.acceptedAt = Date.now();
      s.isInLibrary = true;
      const session = sessions[s.generationSessionId];
      if (session) session.acceptedCount++;
      decisions.push({ sampleId: id, action: 'accept', timestamp: Date.now() });
      count++;
    }
  });
  saveData();
  renderDnaResults();
  showToast(count + ' samples accepted & added to library!');
}

// ==================== INIT ====================
loadData();
seedDemoData();
migrateToProjects();
renderProjectSwitcher();
navigateTo('home');

// Pre-generate audio + real waveforms on first user interaction
document.addEventListener('click', function initAudioOnGesture() {
  document.removeEventListener('click', initAudioOnGesture);
  ensureAudioContext();
  // Generate buffers + real waveforms for all existing samples in background
  Object.keys(samples).forEach((sid, i) => {
    setTimeout(() => getAudioBuffer(sid), i * 50); // stagger to avoid blocking
  });
}, { once: true });
</script>
</body>
</html>
