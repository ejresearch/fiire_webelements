<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>FIIRE Studio - AI Sample & Loop Generator</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "brand": "#E85002",
        "brand-hover": "#F16001",
        "bg": "#1A1A1A",
        "panel": "#232323",
        "surface": "#2D2D2D",
        "surface-hi": "#3D3D3D",
        "border": "#3D3D3D",
        "border-light": "#4A4A4A",
        "txt": "#D4D4D4",
        "txt-muted": "#999999",
        "txt-dim": "#666666",
        "dk-gray": "#3D3D3D",
      },
      fontFamily: {
        "display": ["Space Grotesk", "system-ui", "sans-serif"],
        "mono": ["'SF Mono'", "'Consolas'", "monospace"],
      },
      fontSize: {
        "xxs": ["10px", { lineHeight: "14px" }],
        "micro": ["9px", { lineHeight: "12px" }],
      },
    },
  },
}
</script>
<link rel="stylesheet" href="css/shared.css"/>
</head>
<body class="antialiased">
<div class="flex h-screen overflow-hidden">

<!-- ==================== SIDEBAR ==================== -->
<aside class="w-[200px] flex-shrink-0 border-r border-border flex flex-col bg-panel z-10">
  <a href="home.html" class="px-3 py-2 flex items-center cursor-pointer">
    <img src="logo.png" alt="FIIRE" class="h-12 w-auto" />
  </a>

  <!-- Project Switcher -->
  <div class="px-2 pb-2 relative">
    <button id="project-switcher" class="w-full flex items-center gap-2 px-2 py-1.5 bg-surface border border-border hover:border-border-light transition-colors text-left" onclick="toggleProjectDropdown()">
      <div class="w-5 h-5 bg-brand/10 flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-brand text-[12px]">folder</span>
      </div>
      <div class="flex-1 min-w-0">
        <p id="project-name" class="text-[11px] font-bold truncate">My Project</p>
        <p id="project-count" class="text-[9px] text-txt-dim">0 samples</p>
      </div>
      <span class="material-symbols-outlined text-txt-dim text-[14px] flex-shrink-0" id="project-chevron">expand_more</span>
    </button>

    <!-- Project dropdown -->
    <div id="project-dropdown" class="hidden absolute left-2 right-2 top-full mt-1 bg-panel border border-border z-50 overflow-hidden">
      <div class="max-h-64 overflow-y-auto py-1" id="project-list"></div>
      <div class="border-t border-border p-1.5">
        <div id="new-project-row" class="flex items-center gap-1">
          <button class="flex-1 flex items-center gap-1.5 px-2 py-1 text-[11px] text-brand hover:bg-surface transition-colors font-medium" onclick="showNewProjectInput()">
            <span class="material-symbols-outlined text-[14px]">add</span> New Project
          </button>
        </div>
        <div id="new-project-input-row" class="hidden flex items-center gap-1">
          <input id="new-project-input" class="flex-1 bg-bg border border-border px-2 py-1 text-[11px] text-txt placeholder:text-txt-dim" placeholder="Project name..." onkeydown="if(event.key==='Enter')confirmNewProject(); if(event.key==='Escape')cancelNewProject();" />
          <button class="p-1 text-emerald-400 hover:bg-surface" onclick="confirmNewProject()">
            <span class="material-symbols-outlined text-[14px]">check</span>
          </button>
          <button class="p-1 text-txt-dim hover:bg-surface" onclick="cancelNewProject()">
            <span class="material-symbols-outlined text-[14px]">close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <nav class="flex-1 px-2 py-1 flex flex-col gap-0">
    <a href="home.html" class="nav-link flex items-center gap-2 px-2 py-1" data-page="home">
      <span class="material-symbols-outlined text-[16px]">home</span>
      <span class="text-[11px] font-medium uppercase tracking-wide">Home</span>
    </a>
    <a href="sounddna.html" class="nav-link flex items-center gap-2 px-2 py-1" data-page="sounddna">
      <span class="material-symbols-outlined text-[16px]">fingerprint</span>
      <span class="text-[11px] font-medium uppercase tracking-wide">Sound DNA</span>
    </a>
    <a href="studio.html" class="nav-link flex items-center gap-2 px-2 py-1" data-page="studio">
      <span class="material-symbols-outlined text-[16px]">music_note</span>
      <span class="text-[11px] font-medium uppercase tracking-wide">Studio</span>
    </a>
  </nav>
  <div class="p-2 border-t border-border space-y-1">
    <button onclick="showStudioView('generate')" class="w-full flex items-center justify-center gap-1 py-1.5 bg-brand hover:bg-brand-hover text-txt font-bold text-[11px] uppercase transition-all">
      <span class="material-symbols-outlined text-[14px]">add</span>
      New Session
    </button>
    <button onclick="openSettingsModal()" class="w-full flex items-center gap-2 px-2 py-1 text-txt-muted hover:text-txt hover:bg-surface transition-colors">
      <span class="material-symbols-outlined text-[14px]">settings</span>
      <span class="text-[11px]">Settings</span>
    </button>
  </div>
</aside>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="flex-1 flex flex-col min-w-0 overflow-hidden">

<!-- Tab bar -->
<div class="flex border-b border-border bg-panel px-3 flex-shrink-0">
  <button id="tab-generate" class="px-4 py-1.5 text-[11px] font-bold uppercase tracking-wider border-b-2 text-brand border-brand transition-colors" onclick="showStudioView('generate')">Generate</button>
  <button id="tab-library" class="px-4 py-1.5 text-[11px] font-bold uppercase tracking-wider border-b-2 text-txt-dim border-transparent hover:text-txt-muted transition-colors" onclick="showStudioView('library')">Project Library</button>
</div>

<!-- ========== GENERATE VIEW ========== -->
<div id="page-generate" class="flex flex-col flex-1 overflow-hidden">

  <!-- ===== TOP: Dense Generation Bar ===== -->
  <div class="bg-panel border-b border-border flex-shrink-0 px-3 py-1.5">
    <!-- API key warning -->
    <div id="api-key-warning" class="hidden flex items-center gap-1.5 mb-1 px-2 py-1 bg-amber-500/8 border border-amber-500/15 text-[10px]">
      <span class="material-symbols-outlined text-amber-400 text-[12px]">warning</span>
      <span class="text-amber-300">No API key — synthetic placeholders.</span>
      <button class="text-amber-400 hover:text-amber-300 underline font-medium" onclick="openSettingsModal()">Set key</button>
    </div>
    <!-- Row 1: Prompt + Generate -->
    <div class="flex items-center gap-1.5">
      <button id="ref-upload-btn" class="flex-shrink-0 w-7 h-7 bg-bg border border-border hover:border-brand text-txt-dim hover:text-brand flex items-center justify-center transition-colors" onclick="document.getElementById('ref-file-input').click()" title="Upload reference audio">
        <span class="material-symbols-outlined text-[14px]">upload_file</span>
      </button>
      <input id="ref-file-input" type="file" accept="audio/*" class="hidden" onchange="handleRefUpload(this)"/>
      <div class="flex-1 relative h-7">
        <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-txt-dim text-[14px]">bolt</span>
        <input id="gen-prompt" class="w-full h-full bg-bg border border-border pl-7 pr-2 text-[11px] text-txt placeholder:text-txt-dim focus:border-brand focus:outline-none transition-colors" placeholder="Describe your sound..." type="text" onkeydown="if(event.key==='Enter' && (event.ctrlKey||event.metaKey)){event.preventDefault();refinePrompt()} else if(event.key==='Enter') generateSamples()"/>
      </div>
      <button id="refine-btn" class="bg-surface border border-border hover:border-brand text-txt-muted hover:text-brand font-bold px-3 h-7 flex items-center gap-1 text-[11px] transition-all whitespace-nowrap flex-shrink-0" onclick="refinePrompt()" title="Refine with AI (Ctrl+Enter)">
        <span class="material-symbols-outlined text-[14px]">auto_fix_high</span>
        <span id="refine-btn-text">REFINE</span>
      </button>
      <button id="gen-btn" class="bg-brand hover:bg-brand-hover text-txt font-bold px-4 h-7 flex items-center gap-1 text-[11px] transition-all whitespace-nowrap flex-shrink-0" onclick="generateSamples()">
        <span class="material-symbols-outlined text-[14px]">bolt</span>
        <span id="gen-btn-text">GENERATE</span>
      </button>
    </div>

    <!-- Reference file indicator -->
    <div id="ref-indicator" class="hidden flex items-center gap-1 mt-1">
      <div class="flex items-center gap-1.5 bg-brand/8 border border-brand/15 px-2 py-0.5">
        <span class="material-symbols-outlined text-brand text-[11px]">audio_file</span>
        <span id="ref-filename" class="text-[10px] text-txt font-medium truncate max-w-[160px]"></span>
        <span id="ref-duration" class="text-[10px] text-txt-muted"></span>
        <button class="text-txt-muted hover:text-txt flex items-center" onclick="playReference()" id="ref-play-btn">
          <span class="material-symbols-outlined text-[12px]">play_arrow</span>
        </button>
        <button class="text-txt-muted hover:text-red-400 flex items-center" onclick="removeReference()">
          <span class="material-symbols-outlined text-[11px]">close</span>
        </button>
      </div>
    </div>

    <!-- Row 2: Mode | Params | Instrument | Energy | Vars -->
    <div class="flex items-center gap-0 mt-1 border-t border-border pt-1">
      <!-- Mode toggle -->
      <div class="flex h-6 items-center bg-bg border border-border flex-shrink-0">
        <label class="flex cursor-pointer h-full items-center justify-center px-2 has-[:checked]:bg-surface has-[:checked]:text-txt text-txt-dim text-[10px] font-bold uppercase tracking-wider transition-all">
          <span>LOOP</span>
          <input checked name="gen-mode" type="radio" value="loop" class="hidden" onchange="setGenerateMode('loop')"/>
        </label>
        <label class="flex cursor-pointer h-full items-center justify-center px-2 has-[:checked]:bg-surface has-[:checked]:text-txt text-txt-dim text-[10px] font-bold uppercase tracking-wider transition-all border-l border-border">
          <span>ONE-SHOT</span>
          <input name="gen-mode" type="radio" value="oneshot" class="hidden" onchange="setGenerateMode('oneshot')"/>
        </label>
      </div>

      <div class="w-px h-5 bg-border mx-1.5 flex-shrink-0"></div>

      <!-- Instrument selector -->
      <span class="section-label flex-shrink-0">INST</span>
      <div id="instrument-chips" class="flex gap-0 ml-1 flex-shrink-0">
        <button class="param-chip active" onclick="toggleChip(this, 'instrument-chips')">DRUMS</button>
        <button class="param-chip" onclick="toggleChip(this, 'instrument-chips')">BASS</button>
        <button class="param-chip" onclick="toggleChip(this, 'instrument-chips')">MELODIC</button>
        <button class="param-chip" onclick="toggleChip(this, 'instrument-chips')">PAD</button>
        <button class="param-chip" onclick="toggleChip(this, 'instrument-chips')">FX</button>
        <button class="param-chip" onclick="toggleChip(this, 'instrument-chips')">VOCAL</button>
      </div>

      <div class="w-px h-5 bg-border mx-1.5 flex-shrink-0"></div>

      <!-- Loop params -->
      <div id="loop-params" class="flex items-center gap-2 flex-shrink-0">
        <span class="section-label">BPM</span>
        <select id="bpm-input" class="ab-select h-5">
          <option value="" selected>—</option>
          <option>80</option><option>90</option><option>100</option><option>110</option>
          <option>120</option><option>130</option><option>140</option><option>150</option>
          <option>160</option><option>170</option><option>180</option><option>200</option>
        </select>
        <span class="section-label ml-1">KEY</span>
        <select id="key-select" class="ab-select h-5">
          <option value="auto" selected>—</option>
          <option>C</option><option>Cm</option><option>C#</option><option>C#m</option>
          <option>D</option><option>Dm</option><option>D#</option><option>D#m</option>
          <option>E</option><option>Em</option>
          <option>F</option><option>Fm</option><option>F#</option><option>F#m</option>
          <option>G</option><option>Gm</option><option>G#</option><option>G#m</option>
          <option>A</option><option>Am</option><option>A#</option><option>A#m</option>
          <option>B</option><option>Bm</option>
        </select>
        <span class="section-label ml-1">BARS</span>
        <div id="length-chips" class="flex gap-0">
          <button class="param-chip" onclick="setLength(2, this)">2</button>
          <button class="param-chip active" onclick="setLength(4, this)">4</button>
          <button class="param-chip" onclick="setLength(8, this)">8</button>
          <button class="param-chip" onclick="setLength(16, this)">16</button>
        </div>
      </div>

      <!-- One-shot params -->
      <div id="oneshot-params" class="hidden items-center gap-2 flex-shrink-0">
        <span class="section-label">TUNING</span>
        <select id="tuning-select" class="ab-select h-5">
          <option>C2</option><option>C3</option><option>C4</option><option>C5</option>
          <option>D3</option><option>D4</option><option>E3</option><option>E4</option>
          <option>F3</option><option>F4</option><option>G3</option><option>G4</option>
          <option>A3</option><option>A4</option><option>B3</option><option>B4</option>
        </select>
        <span class="section-label ml-1">ATTACK</span>
        <div id="attack-chips" class="flex gap-0">
          <button class="param-chip active" onclick="toggleChip(this, 'attack-chips')">SNP</button>
          <button class="param-chip" onclick="toggleChip(this, 'attack-chips')">SFT</button>
          <button class="param-chip" onclick="toggleChip(this, 'attack-chips')">TRN</button>
          <button class="param-chip" onclick="toggleChip(this, 'attack-chips')">PUN</button>
        </div>
        <span class="section-label ml-1">TIMBRE</span>
        <div id="timbre-chips" class="flex gap-0">
          <button class="param-chip active" onclick="toggleChip(this, 'timbre-chips')">WRM</button>
          <button class="param-chip" onclick="toggleChip(this, 'timbre-chips')">BRT</button>
          <button class="param-chip" onclick="toggleChip(this, 'timbre-chips')">DRK</button>
          <button class="param-chip" onclick="toggleChip(this, 'timbre-chips')">MTL</button>
        </div>
      </div>

      <div class="w-px h-5 bg-border mx-1.5 flex-shrink-0"></div>

      <!-- Energy -->
      <span class="section-label flex-shrink-0">NRG</span>
      <div id="energy-chips" class="flex gap-0 ml-1 flex-shrink-0">
        <button class="param-chip" onclick="toggleChip(this, 'energy-chips')">LOW</button>
        <button class="param-chip active" onclick="toggleChip(this, 'energy-chips')">MID</button>
        <button class="param-chip" onclick="toggleChip(this, 'energy-chips')">HIGH</button>
      </div>

      <div class="w-px h-5 bg-border mx-1.5 flex-shrink-0"></div>

      <!-- Variation count -->
      <span class="section-label flex-shrink-0">VARS</span>
      <div id="varcount-chips" class="flex gap-0 ml-1 flex-shrink-0">
        <button class="param-chip" onclick="setVarCount(1, this)">1</button>
        <button class="param-chip" onclick="setVarCount(2, this)">2</button>
        <button class="param-chip active" onclick="setVarCount(4, this)">4</button>
        <button class="param-chip" onclick="setVarCount(8, this)">8</button>
      </div>
    </div>

    <!-- Row 3: Genre tags -->
    <div class="flex items-center gap-0 mt-1 border-t border-border pt-1">
      <span class="section-label flex-shrink-0">GENRE</span>
      <div id="style-chips" class="flex gap-0 ml-1 flex-1 overflow-x-auto no-scrollbar">
        <button class="param-chip" onclick="toggleMultiChip(this)">TRAP</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">BOOMBAP</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">HOUSE</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">TECHNO</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">DNB</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">AMBIENT</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">R&amp;B</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">LOFI</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">FUNK</button>
        <button class="param-chip" onclick="toggleMultiChip(this)">AFRO</button>
      </div>
    </div>
  </div>

  <!-- ===== MIDDLE: Pad Grid + Inspector ===== -->
  <div class="flex flex-1 min-h-0 overflow-hidden">
    <main id="gen-center" class="flex-1 bg-bg flex flex-col min-w-0 overflow-hidden">

      <!-- Bank bar + transport -->
      <div class="flex items-center justify-between px-3 py-1 border-b border-border">
        <div class="flex items-center gap-1">
          <button class="bank-tab active" onclick="switchBank('A')">A</button>
          <button class="bank-tab" onclick="switchBank('B')">B</button>
          <button class="bank-tab" onclick="switchBank('C')">C</button>
          <button class="bank-tab" onclick="switchBank('D')">D</button>
        </div>
        <div class="flex items-center gap-2">
          <span id="pad-info" class="text-[9px] text-txt-dim font-mono"></span>
          <div class="flex items-center gap-1">
            <button class="transport-btn w-6 h-6 flex items-center justify-center" onclick="transportStop()">
              <span class="material-symbols-outlined text-txt-muted text-[14px]">stop</span>
            </button>
            <button class="transport-btn w-6 h-6 flex items-center justify-center" onclick="transportPlay()">
              <span class="material-symbols-outlined text-brand text-[14px]">play_arrow</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Pad grid container -->
      <div class="flex-1 p-4 overflow-auto flex items-start justify-center">
        <div id="pad-grid" class="grid grid-cols-8 gap-2 w-full"></div>
      </div>

      <!-- Loading state -->
      <div id="gen-loading" class="hidden flex items-center gap-2 px-3 py-2 border-t border-border">
        <div class="flex items-end gap-[1px]">
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
        </div>
        <span class="text-txt-muted text-[10px]">Generating variations...</span>
      </div>

      <!-- Variations drawer -->
      <div id="variations-drawer" class="variations-drawer collapsed flex-shrink-0">
        <div class="flex items-center justify-between px-3 py-1 border-b border-border">
          <div class="flex items-center gap-2">
            <span class="section-label">VARIATIONS</span>
            <span id="gen-var-count" class="text-[9px] text-txt-dim font-mono"></span>
          </div>
          <div class="flex items-center gap-2">
            <span id="gen-target-pad" class="text-[9px] text-brand font-mono font-bold"></span>
            <button class="text-[9px] text-txt-dim hover:text-txt" onclick="toggleDrawer()">
              <span class="material-symbols-outlined text-[12px]">expand_more</span>
            </button>
          </div>
        </div>
        <!-- Chat refinement area (hidden) -->
        <div id="chat-area" class="hidden">
          <div class="flex items-center justify-between px-3 py-1 border-b border-border">
            <span class="section-label">REFINEMENT</span>
            <button class="text-[9px] text-txt-dim hover:text-txt uppercase font-bold tracking-wider" onclick="clearChat()">CLEAR</button>
          </div>
          <div id="chat-messages" class="divide-y divide-border"></div>
          <div id="chat-loading" class="hidden flex items-center gap-2 px-3 py-2">
            <div class="flex items-end gap-[1px]">
              <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
            </div>
            <span class="text-txt-muted text-[10px]">Refining...</span>
          </div>
        </div>
        <div id="var-grid"></div>
        <div id="gen-summary" class="hidden flex items-center justify-between px-3 py-1.5 border-t border-border"></div>
      </div>

      <!-- Empty state (starter prompts) -->
      <div id="gen-empty" class="px-3 py-4 border-t border-border">
        <p class="text-txt-dim text-[11px] mb-2">Select a pad and enter a prompt, or try:</p>
        <div class="flex flex-col gap-0">
          <button class="starter-prompt text-left px-2 py-1.5 border-b border-border text-[11px] text-txt-muted hover:bg-surface hover:text-txt transition-colors" onclick="useStarterPrompt(this)">Dusty lo-fi drum loop, 90 BPM</button>
          <button class="starter-prompt text-left px-2 py-1.5 border-b border-border text-[11px] text-txt-muted hover:bg-surface hover:text-txt transition-colors" onclick="useStarterPrompt(this)">Crispy digital hi-hats, 128 BPM</button>
          <button class="starter-prompt text-left px-2 py-1.5 text-[11px] text-txt-muted hover:bg-surface hover:text-txt transition-colors" onclick="useStarterPrompt(this)">Warm analog kick with punchy attack</button>
        </div>
      </div>

    </main>

    <!-- Right panel: Sample Inspector -->
    <aside id="inspector-panel" class="w-[280px] bg-panel border-l border-border flex-col h-full overflow-y-auto flex-shrink-0" style="display:none;">
      <div class="relative">
        <button class="absolute top-1 right-1 z-10 w-5 h-5 bg-bg hover:bg-surface flex items-center justify-center text-txt-dim hover:text-txt transition-colors" onclick="closeInspector()">
          <span class="material-symbols-outlined text-[12px]">close</span>
        </button>
        <div class="p-2 bg-bg">
          <canvas id="inspector-waveform" class="w-full h-20"></canvas>
        </div>
      </div>
      <div class="p-3 space-y-3">
        <div>
          <h3 id="inspector-title" class="text-[11px] font-bold">Variation 1</h3>
          <div class="flex items-center gap-1.5 mt-0.5">
            <span id="inspector-type-badge" class="px-1 py-0 text-[9px] font-bold uppercase badge-loop">Loop</span>
            <span id="inspector-meta" class="text-[10px] text-txt-muted font-mono">120 BPM / Cm / 4 bars</span>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <button class="flex items-center gap-1 bg-surface border border-border px-2 py-1 text-[10px] hover:bg-dk-gray transition-colors" onclick="playSampleFromInspector()">
            <span class="material-symbols-outlined text-[12px] fill-1" id="inspector-play-icon">play_arrow</span> Play
          </button>
          <button id="inspector-loop-btn" class="flex items-center gap-1 bg-surface border border-border px-2 py-1 text-[10px] hover:bg-dk-gray transition-colors text-txt-muted" onclick="toggleLoopPlayback()">
            <span class="material-symbols-outlined text-[12px]">loop</span>
          </button>
          <button class="bg-surface border border-border px-2 py-1 text-[10px] hover:bg-dk-gray transition-colors" onclick="downloadSample(state.inspectedSample)">
            <span class="material-symbols-outlined text-[12px]">download</span>
          </button>
          <button class="bg-surface border border-border px-2 py-1 text-[10px] hover:bg-dk-gray transition-colors" onclick="toggleSampleFavorite(state.inspectedSample)">
            <span class="material-symbols-outlined text-[12px]" id="inspector-fav-icon">favorite</span>
          </button>
        </div>
        <div>
          <h4 class="section-label mb-1">NOTES</h4>
          <textarea id="inspector-notes" class="w-full h-12 bg-bg border border-border focus:border-brand p-1.5 text-txt text-[10px] resize-none placeholder:text-txt-dim" placeholder="Add notes..." oninput="updateSampleNotes()"></textarea>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- ========== LIBRARY VIEW ========== -->
<div id="page-library" class="hidden flex flex-col flex-1 overflow-hidden">
  <!-- Library toolbar -->
  <div class="flex items-center gap-3 px-4 py-2 border-b border-border bg-panel">
    <div class="relative">
      <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-txt-dim text-[16px]">search</span>
      <input id="lib-search" class="ab-input pl-8 pr-3 py-1 text-[11px] w-[160px]" placeholder="Search..." type="text" oninput="renderLibrary()"/>
    </div>
    <div class="flex gap-1" id="lib-type-chips">
      <button class="param-chip active text-[10px]" onclick="setLibType('all', this)">ALL</button>
      <button class="param-chip text-[10px]" onclick="setLibType('loop', this)">LOOPS</button>
      <button class="param-chip text-[10px]" onclick="setLibType('oneshot', this)">1-SHOT</button>
      <button class="param-chip text-[10px]" onclick="setLibType('favorites', this)">FAV</button>
    </div>
    <select id="lib-key-filter" class="ab-select text-[10px] py-1 px-2" onchange="renderLibrary()">
      <option value="all">All Keys</option>
      <option>C</option><option>Cm</option><option>D</option><option>Dm</option><option>E</option><option>Em</option>
      <option>F</option><option>Fm</option><option>G</option><option>Gm</option><option>A</option><option>Am</option><option>B</option><option>Bm</option>
    </select>
    <select id="lib-sort" class="ab-select text-[10px] py-1 px-2" onchange="renderLibrary()">
      <option value="recent">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="name">Name A-Z</option>
      <option value="bpm">BPM</option>
    </select>
    <div class="flex gap-1 ml-auto">
      <button id="lib-grid-btn" class="p-1 bg-surface border border-border text-brand" onclick="setLibView('grid')">
        <span class="material-symbols-outlined text-[16px]">grid_view</span>
      </button>
      <button id="lib-list-btn" class="p-1 text-txt-muted hover:text-txt hover:bg-surface transition-colors" onclick="setLibView('list')">
        <span class="material-symbols-outlined text-[16px]">view_list</span>
      </button>
    </div>
    <button class="flex items-center gap-1 bg-surface text-txt px-3 py-1 text-[10px] font-bold border border-border hover:bg-dk-gray transition-colors" onclick="openImportModal()">
      <span class="material-symbols-outlined text-[14px]">upload</span> IMPORT
    </button>
    <button class="flex items-center gap-1 bg-brand hover:bg-brand-hover text-txt px-3 py-1 text-[10px] font-bold transition-all" onclick="showStudioView('generate')">
      <span class="material-symbols-outlined text-[14px]">magic_button</span> GENERATE
    </button>
  </div>
  <!-- Content -->
  <div class="flex-1 overflow-auto px-4 py-3 pb-32">
    <div id="lib-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="lib-list" class="hidden bg-panel rounded border border-border overflow-hidden">
      <table class="w-full text-left border-collapse">
        <thead><tr class="bg-surface">
          <th class="px-4 py-3 w-10"><input type="checkbox" class="rounded border-border" onchange="toggleSelectAll(this)"/></th>
          <th class="px-4 py-3 text-xs font-semibold">Sample</th>
          <th class="px-4 py-3 text-xs font-semibold">Type</th>
          <th class="px-4 py-3 text-xs font-semibold">Key</th>
          <th class="px-4 py-3 text-xs font-semibold">BPM</th>
          <th class="px-4 py-3 text-xs font-semibold">Duration</th>
          <th class="px-4 py-3 text-xs font-semibold text-right">Actions</th>
        </tr></thead>
        <tbody id="lib-tbody" class="divide-y divide-border"></tbody>
      </table>
    </div>
    <div id="lib-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded mt-4">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">library_music</span>
      <p class="text-txt-muted font-medium">Your library is empty</p>
      <p class="text-txt-dim text-sm">Accept generated samples to add them here.</p>
    </div>
  </div>
  <!-- Batch bar -->
  <div id="lib-batch-bar" class="hidden batch-bar fixed left-[200px] right-0 z-40 flex items-center justify-between px-3 py-2 bg-panel border-t border-border" style="bottom: 36px;">
    <span class="text-sm font-bold"><span id="batch-count">0</span> samples selected</span>
    <div class="flex items-center gap-3">
      <button class="flex items-center gap-2 bg-surface border border-border text-txt px-4 py-2 rounded text-sm font-bold hover:bg-dk-gray transition-colors" onclick="favoriteSelected()">
        <span class="material-symbols-outlined text-[18px]">favorite</span> Favorite
      </button>
      <button class="flex items-center gap-2 text-red-400 px-4 py-2 rounded text-sm font-bold hover:bg-red-500/10 transition-colors" onclick="deleteSelected()">
        <span class="material-symbols-outlined text-[18px]">delete</span> Delete
      </button>
    </div>
  </div>
</div>

<!-- ==================== PLAYER BAR ==================== -->
<footer id="player-bar" class="fixed bottom-0 left-0 right-0 z-50 glass-effect border-t border-border px-3 py-1" style="display:none;">
  <div class="flex items-center gap-3">
    <div class="flex items-center gap-2 w-36 flex-shrink-0">
      <div class="w-7 h-7 bg-surface overflow-hidden flex-shrink-0">
        <canvas id="player-mini-waveform" width="28" height="28"></canvas>
      </div>
      <div class="min-w-0">
        <p id="player-title" class="font-bold text-[10px] truncate">Sample</p>
        <p id="player-meta" class="text-[9px] text-txt-muted truncate">120 BPM / Cm</p>
      </div>
    </div>
    <div class="flex-1 flex items-center gap-2">
      <button id="btn-play" class="w-7 h-7 bg-brand text-txt flex items-center justify-center hover:bg-brand-hover transition-all flex-shrink-0" onclick="togglePlayPause()">
        <span class="material-symbols-outlined text-[18px] fill-1">play_arrow</span>
      </button>
      <button id="btn-loop" class="text-txt-muted hover:text-txt transition-colors flex-shrink-0" onclick="toggleLoopPlayback()">
        <span class="material-symbols-outlined text-[14px]">loop</span>
      </button>
      <span id="player-current-time" class="text-[9px] font-mono text-txt-dim w-7 text-right flex-shrink-0">0:00</span>
      <div class="flex-1 h-6 relative cursor-pointer" onclick="seekSample(event)">
        <canvas id="player-waveform" class="w-full h-full"></canvas>
      </div>
      <span id="player-total-time" class="text-[9px] font-mono text-txt-dim w-7 flex-shrink-0">0:00</span>
    </div>
    <div class="flex items-center gap-2 flex-shrink-0">
      <button id="player-fav-btn" class="text-txt-muted hover:text-brand transition-colors" onclick="togglePlayerFav()">
        <span class="material-symbols-outlined text-[14px]">favorite</span>
      </button>
      <button class="text-txt-muted hover:text-txt transition-colors" onclick="downloadSample(state.currentSample)">
        <span class="material-symbols-outlined text-[14px]">download</span>
      </button>
      <div class="flex items-center gap-1">
        <button onclick="toggleMute()" class="text-txt-muted hover:text-txt"><span id="volume-icon" class="material-symbols-outlined text-[14px]">volume_up</span></button>
        <input id="volume-slider" type="range" min="0" max="100" value="66" class="w-12 range-slider" oninput="setVolume(this.value)"/>
      </div>
    </div>
  </div>
</footer>

</div>

<div id="toast" class="toast"></div>

<!-- Confirm modal -->
<div id="confirm-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border p-4 w-full max-w-sm animate-fadeIn">
    <h3 id="confirm-title" class="text-[13px] font-bold mb-1.5"></h3>
    <p id="confirm-msg" class="text-[11px] text-txt-muted mb-4"></p>
    <div class="flex gap-2">
      <button class="flex-1 py-1.5 bg-surface border border-border text-[11px] font-bold hover:bg-dk-gray transition-colors" onclick="closeModal()">Cancel</button>
      <button id="confirm-action" class="flex-1 py-1.5 bg-red-600 hover:bg-red-500 text-[11px] font-bold text-txt transition-colors">Confirm</button>
    </div>
  </div>
</div>

<!-- Import from Project modal -->
<div id="import-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border w-full max-w-lg animate-fadeIn flex flex-col max-h-[80vh]">
    <div class="p-4 pb-3 border-b border-border">
      <h3 class="text-[13px] font-bold mb-2">Import from Project</h3>
      <select id="import-project-select" class="w-full ab-select px-2 py-1.5 text-[11px]" onchange="renderImportList()">
        <option value="">Select a project...</option>
      </select>
    </div>
    <div class="flex-1 overflow-y-auto p-3" id="import-sample-list">
      <p class="text-[11px] text-txt-dim text-center py-6">Select a project to see its samples</p>
    </div>
    <div class="p-3 border-t border-border flex items-center justify-between">
      <span class="text-[11px] text-txt-muted"><span id="import-selected-count">0</span> selected</span>
      <div class="flex gap-2">
        <button class="px-3 py-1.5 bg-surface border border-border text-[11px] font-bold hover:bg-dk-gray transition-colors" onclick="closeModal()">Cancel</button>
        <button id="import-btn" class="px-3 py-1.5 bg-brand hover:bg-brand-hover text-[11px] font-bold text-txt transition-colors" onclick="importSelectedSamples()">Import Selected</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div id="settings-modal" class="modal-overlay" onclick="if(event.target===this)closeSettingsModal()">
  <div class="bg-panel border border-border w-full max-w-md animate-fadeIn">
    <div class="p-4 pb-3 border-b border-border flex items-center justify-between">
      <h3 class="text-[13px] font-bold">Settings</h3>
      <button class="w-5 h-5 bg-surface hover:bg-dk-gray flex items-center justify-center text-txt-muted hover:text-txt transition-colors" onclick="closeSettingsModal()">
        <span class="material-symbols-outlined text-[12px]">close</span>
      </button>
    </div>
    <div class="p-4 space-y-4">
      <div>
        <label class="section-label block mb-1.5">ELEVENLABS API KEY</label>
        <p class="text-[10px] text-txt-muted mb-2">Required for AI samples. Get a key at <a href="https://elevenlabs.io/developers" target="_blank" class="text-brand hover:underline">elevenlabs.io</a></p>
        <div class="flex gap-1.5">
          <div class="relative flex-1">
            <input id="settings-api-key" type="password" class="w-full ab-input px-3 py-1.5 pr-8 font-mono" placeholder="xi_..." />
            <button class="absolute right-1.5 top-1/2 -translate-y-1/2 text-txt-dim hover:text-txt p-0.5" onclick="toggleApiKeyVisibility()">
              <span class="material-symbols-outlined text-[14px]" id="api-key-eye">visibility_off</span>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-1.5 mt-2">
          <button id="api-test-btn" class="flex items-center gap-1 bg-surface border border-border text-txt px-3 py-1 text-[10px] font-bold hover:bg-dk-gray transition-colors" onclick="testApiKey()">
            <span class="material-symbols-outlined text-[12px]">bolt</span>
            <span id="api-test-label">Test</span>
          </button>
          <button class="flex items-center gap-1 bg-brand hover:bg-brand-hover text-txt px-3 py-1 text-[10px] font-bold transition-colors" onclick="saveApiKey()">
            <span class="material-symbols-outlined text-[12px]">save</span> Save
          </button>
          <div id="api-status" class="flex items-center gap-1 ml-auto"></div>
        </div>
      </div>
      <div class="border-t border-border"></div>
      <div>
        <label class="section-label block mb-1.5">CLAUDE API KEY</label>
        <p class="text-[10px] text-txt-muted mb-2">Optional — enables AI prompt refinement. Get a key at <a href="https://console.anthropic.com/" target="_blank" class="text-brand hover:underline">console.anthropic.com</a></p>
        <div class="flex gap-1.5">
          <div class="relative flex-1">
            <input id="settings-claude-key" type="password" class="w-full ab-input px-3 py-1.5 pr-8 font-mono" placeholder="sk-ant-..." />
            <button class="absolute right-1.5 top-1/2 -translate-y-1/2 text-txt-dim hover:text-txt p-0.5" onclick="toggleClaudeKeyVisibility()">
              <span class="material-symbols-outlined text-[14px]" id="claude-key-eye">visibility_off</span>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-1.5 mt-2">
          <button class="flex items-center gap-1 bg-brand hover:bg-brand-hover text-txt px-3 py-1 text-[10px] font-bold transition-colors" onclick="saveClaudeKey()">
            <span class="material-symbols-outlined text-[12px]">save</span> Save
          </button>
          <div id="claude-key-status" class="flex items-center gap-1 ml-auto"></div>
        </div>
      </div>
      <div class="border-t border-border"></div>
      <div>
        <label class="section-label block mb-1">DATA</label>
        <p class="text-[10px] text-txt-muted mb-2">Clear all local data including samples, projects, and audio.</p>
        <button class="flex items-center gap-1 text-red-400 border border-red-500/30 px-3 py-1 text-[10px] font-bold hover:bg-red-500/10 transition-colors" onclick="clearAllDataConfirm()">
          <span class="material-symbols-outlined text-[12px]">delete_forever</span> Clear All Data
        </button>
      </div>
    </div>
  </div>
</div>
</div>
</div>

<script src="js/shared.js"></script>
<script src="js/studio.js"></script>
<script src="js/blaise.js"></script>
</body>
</html>
