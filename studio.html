<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>FIIRE Studio - AI Sample & Loop Generator</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        "brand": "#E85002",
        "brand-hover": "#F16001",
        "bg": "#000000",
        "panel": "#111111",
        "surface": "#1A1A1A",
        "border": "#333333",
        "border-light": "#444444",
        "txt": "#F9F9F9",
        "txt-muted": "#A7A7A7",
        "txt-dim": "#646464",
        "dk-gray": "#333333",
      },
      fontFamily: {
        "display": ["Space Grotesk", "sans-serif"]
      },
    },
  },
}
</script>
<style>
body { font-family: 'Space Grotesk', sans-serif; background: #000; color: #F9F9F9; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: #444; }
.glass-effect { backdrop-filter: blur(16px); background-color: rgba(0, 0, 0, 0.88); }
.page { display: none; }
.page.active { display: flex; }
.fill-1 { font-variation-settings: 'FILL' 1; }
.nav-link { transition: all 0.15s; }
.nav-link:hover { background: #1A1A1A; }
.nav-link.active { background: rgba(232, 80, 2, 0.1); color: #E85002; }
.toast {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  background: linear-gradient(135deg, #E85002, #F16001); color: #F9F9F9;
  padding: 10px 24px; border-radius: 12px;
  font-size: 14px; font-weight: 600; z-index: 100; opacity: 0;
  transition: opacity 0.3s; pointer-events: none;
}
.toast.show { opacity: 1; }
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 60; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.animate-fadeIn { animation: fadeIn 0.25s ease-out; }

/* Parameter chips */
.param-chip {
  padding: 5px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
  border: 1px solid #333; background: #1A1A1A; color: #A7A7A7;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.param-chip:hover { border-color: #E85002; color: #F9F9F9; }
.param-chip.active { background: rgba(232, 80, 2, 0.15); border-color: #E85002; color: #E85002; }

/* Variation cards */
.variation-card { transition: all 0.2s ease; }
.variation-card:hover { border-color: #444; }
.variation-card.accepted { border-color: rgba(16, 185, 129, 0.5); background: rgba(16, 185, 129, 0.03); }
.variation-card.rejected { opacity: 0.4; border-color: rgba(239, 68, 68, 0.3); }
.variation-card.rejected canvas { filter: grayscale(0.8); }
.variation-card.playing { border-color: #E85002; box-shadow: 0 0 0 1px #E85002, 0 0 16px rgba(232, 80, 2, 0.15); }

/* Sample cards */
.sample-card { transition: all 0.2s ease; }
.sample-card:hover { transform: translateY(-2px); border-color: #444; }
.sample-card.selected { border-color: #E85002; background: rgba(232, 80, 2, 0.04); }

/* Effects sliders */
.effect-slider { -webkit-appearance: none; appearance: none; height: 4px; background: #333; border-radius: 4px; outline: none; width: 100%; }
.effect-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #E85002; border-radius: 50%; cursor: pointer; border: 2px solid #000; }

/* Type badges */
.badge-loop { background: rgba(232, 80, 2, 0.12); color: #E85002; }
.badge-oneshot { background: rgba(59, 130, 246, 0.12); color: #3B82F6; }

/* Batch bar */
.batch-bar { animation: slideUp 0.2s ease-out; }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Generation loading */
@keyframes waveformPulse {
  0%, 100% { opacity: 0.3; transform: scaleY(0.4); }
  50% { opacity: 1; transform: scaleY(1); }
}
.gen-loading-bar {
  width: 3px; height: 24px; border-radius: 2px; background: #E85002;
  display: inline-block; margin: 0 2px;
  animation: waveformPulse 1.2s ease-in-out infinite;
}
.gen-loading-bar:nth-child(2) { animation-delay: 0.1s; }
.gen-loading-bar:nth-child(3) { animation-delay: 0.2s; }
.gen-loading-bar:nth-child(4) { animation-delay: 0.3s; }
.gen-loading-bar:nth-child(5) { animation-delay: 0.4s; }
.gen-loading-bar:nth-child(6) { animation-delay: 0.5s; }
.gen-loading-bar:nth-child(7) { animation-delay: 0.6s; }
.gen-loading-bar:nth-child(8) { animation-delay: 0.7s; }

/* History timeline */
.history-item { position: relative; padding-left: 32px; }
.history-item::before { content: ''; position: absolute; left: 11px; top: 32px; bottom: -16px; width: 2px; background: #333; }
.history-item:last-child::before { display: none; }
.history-dot { position: absolute; left: 4px; top: 8px; width: 16px; height: 16px; border-radius: 50%; border: 2px solid #333; background: #111; }
.history-dot.loop { border-color: #E85002; }
.history-dot.oneshot { border-color: #3B82F6; }

/* Drag */
[draggable="true"] { cursor: grab; }
[draggable="true"]:active { cursor: grabbing; opacity: 0.7; }

/* BPM input */
input[type="number"]::-webkit-inner-spin-button { opacity: 1; }
</style>
</head>
<body class="antialiased">
<div class="flex h-screen overflow-hidden">

<!-- ==================== SIDEBAR ==================== -->
<aside class="w-64 flex-shrink-0 border-r border-border flex flex-col bg-panel z-10">
  <div class="p-6 pb-3 flex items-center cursor-pointer" onclick="navigateTo('dashboard')">
    <img src="logo.png" alt="FIIRE" class="h-16 w-auto" />
  </div>

  <!-- Project Switcher -->
  <div class="px-4 pb-3 relative">
    <button id="project-switcher" class="w-full flex items-center gap-2.5 px-3 py-2.5 rounded-xl bg-surface border border-border hover:border-border-light transition-colors text-left" onclick="toggleProjectDropdown()">
      <div class="w-7 h-7 rounded-lg bg-brand/15 flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-brand text-[16px]">folder</span>
      </div>
      <div class="flex-1 min-w-0">
        <p id="project-name" class="text-sm font-bold truncate">My Project</p>
        <p id="project-count" class="text-[10px] text-txt-dim">0 samples</p>
      </div>
      <span class="material-symbols-outlined text-txt-dim text-[18px] flex-shrink-0" id="project-chevron">expand_more</span>
    </button>

    <!-- Project dropdown -->
    <div id="project-dropdown" class="hidden absolute left-4 right-4 top-full mt-1 bg-panel border border-border rounded-xl shadow-2xl shadow-black/50 z-50 overflow-hidden">
      <div class="max-h-64 overflow-y-auto py-1" id="project-list">
        <!-- rendered by JS -->
      </div>
      <div class="border-t border-border p-2">
        <div id="new-project-row" class="flex items-center gap-2">
          <button class="flex-1 flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-brand hover:bg-surface transition-colors font-medium" onclick="showNewProjectInput()">
            <span class="material-symbols-outlined text-[16px]">add</span> New Project
          </button>
        </div>
        <div id="new-project-input-row" class="hidden flex items-center gap-2">
          <input id="new-project-input" class="flex-1 bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-txt placeholder:text-txt-dim" placeholder="Project name..." onkeydown="if(event.key==='Enter')confirmNewProject(); if(event.key==='Escape')cancelNewProject();" />
          <button class="p-1.5 text-emerald-400 hover:bg-surface rounded-lg" onclick="confirmNewProject()">
            <span class="material-symbols-outlined text-[16px]">check</span>
          </button>
          <button class="p-1.5 text-txt-dim hover:bg-surface rounded-lg" onclick="cancelNewProject()">
            <span class="material-symbols-outlined text-[16px]">close</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <nav class="flex-1 px-4 py-2 flex flex-col gap-1">
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="dashboard" onclick="navigateTo('dashboard')">
      <span class="material-symbols-outlined">home</span>
      <span class="text-sm font-medium">Home</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="generate" onclick="navigateTo('generate')">
      <span class="material-symbols-outlined">music_note</span>
      <span class="text-sm font-medium">Studio</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="library" onclick="navigateTo('library')">
      <span class="material-symbols-outlined">library_music</span>
      <span class="text-sm font-medium">Library</span>
    </a>
    <div class="mt-6 mb-3">
      <p class="px-3 text-[10px] uppercase tracking-widest text-txt-dim font-bold">Collections</p>
    </div>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="favorites" onclick="navigateTo('favorites')">
      <span class="material-symbols-outlined">favorite</span>
      <span class="text-sm font-medium">Favorites</span>
    </a>
    <a class="nav-link flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer" data-page="history" onclick="navigateTo('history')">
      <span class="material-symbols-outlined">history</span>
      <span class="text-sm font-medium">Generation History</span>
    </a>
  </nav>
  <div class="p-4 border-t border-border">
    <button onclick="navigateTo('generate')" class="w-full flex items-center justify-center gap-2 py-3 bg-brand hover:bg-brand-hover text-txt rounded-xl font-bold text-sm shadow-lg shadow-brand/20 transition-all">
      <span class="material-symbols-outlined text-[18px]">add</span>
      New Generation
    </button>
  </div>
</aside>

<!-- ==================== MAIN CONTENT ==================== -->
<div class="flex-1 flex flex-col min-w-0 overflow-hidden">

<!-- ========== PAGE: DASHBOARD ========== -->
<div id="page-dashboard" class="page flex-col flex-1 overflow-hidden">
  <header class="sticky top-0 z-30 flex items-center justify-between px-8 py-4 glass-effect border-b border-border">
    <div class="flex-1">
      <div class="relative w-full">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-muted">search</span>
        <input id="dash-search" class="w-full bg-surface border border-border rounded-xl pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search samples, loops, one-shots..." type="text" oninput="filterDashboard()"/>
      </div>
    </div>
    <div class="flex items-center gap-3 ml-6">
      <button class="w-9 h-9 rounded-lg bg-surface border border-border text-txt-muted hover:text-txt hover:bg-dk-gray transition-colors flex items-center justify-center" onclick="showToast('No new notifications')">
        <span class="material-symbols-outlined text-[18px]">notifications</span>
      </button>
      <button class="w-9 h-9 rounded-lg bg-surface border border-border text-txt-muted hover:text-txt hover:bg-dk-gray transition-colors flex items-center justify-center" onclick="openSettingsModal()">
        <span class="material-symbols-outlined text-[18px]">settings</span>
      </button>
      <div class="w-9 h-9 rounded-full bg-brand flex items-center justify-center text-xs font-bold text-txt cursor-pointer ml-1" onclick="showToast('Profile')">U</div>
    </div>
  </header>
  <main class="flex-1 overflow-y-auto pb-28">
    <div class="px-8 py-6 space-y-8">
      <!-- Quick Generate -->
      <section class="bg-panel rounded-2xl p-6 border border-border">
        <div class="flex gap-4">
          <div class="w-12 h-12 rounded-full bg-brand/15 flex items-center justify-center flex-shrink-0">
            <span class="material-symbols-outlined text-brand font-bold">bolt</span>
          </div>
          <div class="flex-1">
            <h2 class="text-lg font-bold mb-1">What are you creating?</h2>
            <p class="text-sm text-txt-muted mb-4">Generate AI-powered samples and loops for your productions.</p>
            <div class="flex gap-3 flex-wrap">
              <button class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-txt px-5 py-2.5 rounded-xl text-sm font-bold transition-all" onclick="navigateTo('generate'); setGenerateMode('loop')">
                <span class="material-symbols-outlined text-[18px]">loop</span>
                Generate Loop
              </button>
              <button class="flex items-center gap-2 bg-surface border border-border text-txt px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-dk-gray transition-colors" onclick="navigateTo('generate'); setGenerateMode('oneshot')">
                <span class="material-symbols-outlined text-[18px]">radio_button_checked</span>
                Generate One-Shot
              </button>
            </div>
            <!-- Recent presets -->
            <div id="dash-presets" class="flex gap-2 mt-4 flex-wrap"></div>
          </div>
        </div>
      </section>

      <!-- Type filter chips -->
      <div id="dash-type-chips" class="flex gap-2 overflow-x-auto pb-2">
        <button class="param-chip active" onclick="setDashTypeFilter('all', this)" data-type="all">All</button>
        <button class="param-chip" onclick="setDashTypeFilter('loop', this)" data-type="loop">Loops</button>
        <button class="param-chip" onclick="setDashTypeFilter('oneshot', this)" data-type="oneshot">One-Shots</button>
      </div>

      <!-- Recent Generations -->
      <section>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">Recent Generations</h3>
          <a class="text-sm font-medium text-brand hover:underline cursor-pointer" onclick="navigateTo('library')">View All</a>
        </div>
        <div id="dash-recent-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          <!-- rendered by JS -->
        </div>
        <div id="dash-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl">
          <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">library_music</span>
          <p class="text-txt-muted font-medium">No samples yet</p>
          <p class="text-txt-dim text-sm">Generate your first loop or one-shot to get started.</p>
        </div>
      </section>

      <!-- Recommendations -->
      <section id="dash-recommendations" class="hidden">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-xl font-bold">Recommended For You</h3>
            <p class="text-sm text-txt-muted">Based on your accept/reject history</p>
          </div>
        </div>
        <div id="dash-rec-list" class="space-y-2"></div>
      </section>
      <section id="dash-rec-locked" class="">
        <div class="bg-panel rounded-2xl p-6 border border-border text-center">
          <span class="material-symbols-outlined text-3xl text-txt-dim mb-2 block">auto_awesome</span>
          <p class="text-txt-muted font-medium text-sm">Personalized recommendations unlock after 50+ sample decisions</p>
          <p class="text-txt-dim text-xs mt-1"><span id="dash-decision-count">0</span> / 50 decisions made</p>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- ========== PAGE: STUDIO ========== -->
<div id="page-generate" class="page flex-col flex-1 overflow-hidden">

  <!-- ===== TOP: Compact Generation Bar ===== -->
  <div class="bg-panel border-b border-border flex-shrink-0">
    <!-- Row 1: Mode toggle + core params + generate button -->
    <div class="flex items-center gap-5 px-8 py-4">
      <!-- Mode toggle -->
      <div class="flex h-10 items-center rounded-xl bg-bg p-0.5 border border-border flex-shrink-0">
        <label class="flex cursor-pointer h-full items-center justify-center rounded-lg px-4 has-[:checked]:bg-surface has-[:checked]:text-txt text-txt-dim text-sm font-medium transition-all">
          <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[16px]">loop</span> Loop</span>
          <input checked name="gen-mode" type="radio" value="loop" class="hidden" onchange="setGenerateMode('loop')"/>
        </label>
        <label class="flex cursor-pointer h-full items-center justify-center rounded-lg px-4 has-[:checked]:bg-surface has-[:checked]:text-txt text-txt-dim text-sm font-medium transition-all">
          <span class="flex items-center gap-1.5"><span class="material-symbols-outlined text-[16px]">radio_button_checked</span> One-Shot</span>
          <input name="gen-mode" type="radio" value="oneshot" class="hidden" onchange="setGenerateMode('oneshot')"/>
        </label>
      </div>

      <div class="w-px h-8 bg-border flex-shrink-0"></div>

      <!-- Loop params (inline) -->
      <div id="loop-params" class="flex items-center gap-4 flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-shrink-0">
          <span class="text-xs text-txt-dim uppercase font-bold tracking-wide">BPM</span>
          <input type="number" id="bpm-input" min="60" max="200" value="120" class="w-16 bg-bg border border-border rounded-lg px-2.5 py-2 text-sm text-center text-txt" oninput="document.getElementById('bpm-slider').value=this.value"/>
          <input type="range" id="bpm-slider" min="60" max="200" value="120" class="w-28 effect-slider" oninput="document.getElementById('bpm-input').value=this.value"/>
        </div>

        <div class="flex items-center gap-2 flex-shrink-0">
          <span class="text-xs text-txt-dim uppercase font-bold tracking-wide">Key</span>
          <select id="key-select" class="bg-bg border border-border rounded-lg px-3 py-2 text-sm text-txt">
            <option>C</option><option>Cm</option><option>C#</option><option>C#m</option>
            <option>D</option><option>Dm</option><option>D#</option><option>D#m</option>
            <option>E</option><option>Em</option>
            <option>F</option><option>Fm</option><option>F#</option><option>F#m</option>
            <option>G</option><option>Gm</option><option>G#</option><option>G#m</option>
            <option>A</option><option>Am</option><option>A#</option><option>A#m</option>
            <option>B</option><option>Bm</option>
          </select>
        </div>

        <div id="length-chips" class="flex gap-1.5 flex-shrink-0">
          <button class="param-chip text-xs" onclick="setLength(2, this)">2 bars</button>
          <button class="param-chip active text-xs" onclick="setLength(4, this)">4 bars</button>
          <button class="param-chip text-xs" onclick="setLength(8, this)">8 bars</button>
          <button class="param-chip text-xs" onclick="setLength(16, this)">16 bars</button>
        </div>
      </div>

      <!-- One-shot params (inline, hidden by default) -->
      <div id="oneshot-params" class="hidden items-center gap-4 flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-shrink-0">
          <span class="text-xs text-txt-dim uppercase font-bold tracking-wide">Tuning</span>
          <select id="tuning-select" class="bg-bg border border-border rounded-lg px-3 py-2 text-sm text-txt">
            <option>C2</option><option>C3</option><option>C4</option><option>C5</option>
            <option>D3</option><option>D4</option><option>E3</option><option>E4</option>
            <option>F3</option><option>F4</option><option>G3</option><option>G4</option>
            <option>A3</option><option>A4</option><option>B3</option><option>B4</option>
          </select>
        </div>
        <div id="attack-chips" class="flex gap-1.5 flex-shrink-0">
          <button class="param-chip active text-xs" onclick="toggleChip(this, 'attack-chips')">Snappy</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'attack-chips')">Soft</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'attack-chips')">Transient</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'attack-chips')">Punchy</button>
        </div>
        <div id="timbre-chips" class="flex gap-1.5 flex-shrink-0">
          <button class="param-chip active text-xs" onclick="toggleChip(this, 'timbre-chips')">Warm</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'timbre-chips')">Bright</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'timbre-chips')">Dark</button>
          <button class="param-chip text-xs" onclick="toggleChip(this, 'timbre-chips')">Metallic</button>
        </div>
      </div>

      <div class="w-px h-8 bg-border flex-shrink-0"></div>

      <!-- Variations + Generate -->
      <div class="flex items-center gap-3 flex-shrink-0 ml-auto">
        <span class="text-xs text-txt-dim uppercase font-bold tracking-wide whitespace-nowrap">Vars</span>
        <select id="var-slider" class="bg-bg border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="updateGenBtnText()">
          <option value="4">4</option><option value="6" selected>6</option><option value="8">8</option>
        </select>
        <select id="model-select" class="bg-bg border border-border rounded-lg px-3 py-2 text-sm text-txt whitespace-nowrap">
          <option value="eleven_text_to_sound_v2">ElevenLabs SFX v2</option><option value="eleven_text_to_sound_v1">ElevenLabs SFX v1</option>
        </select>
        <button id="gen-btn" class="bg-brand hover:bg-brand-hover text-txt font-bold px-6 py-2.5 rounded-xl flex items-center gap-2 text-sm transition-all shadow-lg shadow-brand/20 whitespace-nowrap" onclick="generateSamples()">
          <span class="material-symbols-outlined text-[18px]">bolt</span>
          <span id="gen-btn-text">Generate</span>
        </button>
      </div>
    </div>

    <!-- Row 2: Style chips + optional prompt -->
    <div class="flex items-center gap-4 px-8 pb-4">
      <div id="style-chips" class="flex gap-2 flex-wrap flex-1">
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Dusty</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Clean</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Analog</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Digital</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Lo-fi</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Punchy</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Atmospheric</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Vintage</button>
        <button class="param-chip text-xs" onclick="toggleMultiChip(this)">Crispy</button>
      </div>
      <div class="w-px h-7 bg-border flex-shrink-0"></div>
      <div class="relative flex-shrink-0 w-80">
        <input id="gen-prompt" class="w-full bg-bg border border-border rounded-lg px-4 py-2 text-sm text-txt placeholder:text-txt-dim" placeholder="Describe your sound (optional)..." type="text"/>
      </div>
    </div>
  </div>

  <!-- ===== BOTTOM: Workspace grid + Inspector ===== -->
  <div class="flex flex-1 min-h-0 overflow-hidden">
    <!-- Main workspace area -->
    <main id="gen-center" class="flex-1 bg-bg flex flex-col min-w-0 overflow-hidden">
      <!-- Workspace toolbar -->
      <div class="flex items-center justify-between px-8 py-4">
        <div class="flex items-center gap-4">
          <h3 class="text-base font-bold text-txt">Workspace</h3>
          <div class="flex gap-2">
            <button class="param-chip active text-xs" onclick="setWsFilter('all', this)" id="ws-filter-all">All</button>
            <button class="param-chip text-xs" onclick="setWsFilter('pending', this)">Pending</button>
            <button class="param-chip text-xs" onclick="setWsFilter('accepted', this)">Accepted</button>
            <button class="param-chip text-xs" onclick="setWsFilter('rejected', this)">Rejected</button>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="relative">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[18px]">search</span>
            <input id="ws-search" class="bg-surface border border-border rounded-lg pl-9 pr-4 py-2 text-sm text-txt placeholder-txt-dim w-52" placeholder="Search workspace..." oninput="renderVariations()"/>
          </div>
          <select id="ws-sort" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderVariations()">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="name">Name</option>
          </select>
          <button class="flex items-center gap-1.5 bg-emerald-600 hover:bg-emerald-500 text-txt px-4 py-2 rounded-lg text-sm font-bold transition-colors" onclick="acceptAllPending()">
            <span class="material-symbols-outlined text-[16px]">check</span> Accept All
          </button>
        </div>
      </div>

      <!-- Loading state -->
      <div id="gen-loading" class="hidden flex flex-col items-center justify-center py-16">
        <div class="flex items-end gap-[2px] mb-4">
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
          <span class="gen-loading-bar"></span><span class="gen-loading-bar"></span>
        </div>
        <p class="text-txt-muted font-medium text-sm">Generating variations...</p>
        <p class="text-txt-dim text-xs mt-1">This usually takes 5-10 seconds</p>
      </div>

      <!-- Workspace grid / stack -->
      <div class="flex-1 overflow-y-auto px-6 pb-28">
        <div id="var-grid"></div>

        <!-- Empty state -->
        <div id="gen-empty" class="text-center py-16">
          <span class="material-symbols-outlined text-5xl text-txt-dim mb-4 block">music_note</span>
          <h5 class="text-txt-muted font-medium">Your studio workspace</h5>
          <p class="text-txt-dim text-sm mt-1">Set parameters above and hit Generate to fill this space.</p>
        </div>

        <!-- Footer -->
        <div id="gen-footer" class="hidden flex items-center justify-between pt-4 pb-2">
          <span id="gen-var-count" class="text-xs text-txt-dim">6 samples</span>
        </div>
      </div>
    </main>

    <!-- Right panel: Sample Inspector -->
    <aside id="inspector-panel" class="w-[320px] bg-panel border-l border-border flex-col h-full overflow-y-auto flex-shrink-0" style="display:none;">
      <div class="relative">
        <button class="absolute top-3 right-3 z-10 w-7 h-7 rounded-full bg-black/60 hover:bg-black/80 flex items-center justify-center text-txt transition-colors" onclick="closeInspector()">
          <span class="material-symbols-outlined text-[16px]">close</span>
        </button>
        <div class="p-3 bg-bg">
          <canvas id="inspector-waveform" class="w-full h-28 rounded-lg"></canvas>
        </div>
      </div>
      <div class="p-4 space-y-4">
        <!-- Sample info -->
        <div>
          <h3 id="inspector-title" class="text-base font-bold">Variation 1</h3>
          <div class="flex items-center gap-2 mt-1">
            <span id="inspector-type-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase badge-loop">Loop</span>
            <span id="inspector-meta" class="text-xs text-txt-muted">120 BPM / Cm / 4 bars</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-1.5">
          <button class="flex items-center gap-1 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="playSampleFromInspector()">
            <span class="material-symbols-outlined text-[16px] fill-1" id="inspector-play-icon">play_arrow</span> Play
          </button>
          <button id="inspector-loop-btn" class="flex items-center gap-1 bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors text-txt-muted" onclick="toggleLoopPlayback()">
            <span class="material-symbols-outlined text-[16px]">loop</span>
          </button>
          <button class="bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="downloadSample(state.inspectedSample)">
            <span class="material-symbols-outlined text-[16px]">download</span>
          </button>
          <button class="bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="toggleSampleFavorite(state.inspectedSample)">
            <span class="material-symbols-outlined text-[16px]" id="inspector-fav-icon">favorite</span>
          </button>
          <button class="ml-auto bg-surface border border-border rounded-lg px-2.5 py-1.5 text-xs hover:bg-dk-gray transition-colors" onclick="batchFromSample()">
            <span class="material-symbols-outlined text-[16px]">auto_awesome</span>
          </button>
        </div>

        <!-- Effects -->
        <div>
          <h4 class="text-[10px] font-semibold text-txt-muted uppercase tracking-wider mb-2">Effects</h4>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-txt-muted w-16">Distortion</span>
              <input type="range" min="0" max="100" value="0" class="flex-1 effect-slider" data-fx="distortion" oninput="updateEffect(this)"/>
              <span class="text-[10px] text-txt-dim w-7 text-right fx-val">0%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-txt-muted w-16">Reverb</span>
              <input type="range" min="0" max="100" value="0" class="flex-1 effect-slider" data-fx="reverb" oninput="updateEffect(this)"/>
              <span class="text-[10px] text-txt-dim w-7 text-right fx-val">0%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-txt-muted w-16">Delay</span>
              <input type="range" min="0" max="100" value="0" class="flex-1 effect-slider" data-fx="delay" oninput="updateEffect(this)"/>
              <span class="text-[10px] text-txt-dim w-7 text-right fx-val">0%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-txt-muted w-16">Filter LP</span>
              <input type="range" min="0" max="100" value="100" class="flex-1 effect-slider" data-fx="filterLP" oninput="updateEffect(this)"/>
              <span class="text-[10px] text-txt-dim w-7 text-right fx-val">100%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-txt-muted w-16">Bitcrush</span>
              <input type="range" min="0" max="100" value="0" class="flex-1 effect-slider" data-fx="bitcrush" oninput="updateEffect(this)"/>
              <span class="text-[10px] text-txt-dim w-7 text-right fx-val">0%</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[10px] text-txt-muted w-16">Saturation</span>
              <input type="range" min="0" max="100" value="0" class="flex-1 effect-slider" data-fx="saturation" oninput="updateEffect(this)"/>
              <span class="text-[10px] text-txt-dim w-7 text-right fx-val">0%</span>
            </div>
          </div>
          <div class="flex gap-2 mt-2">
            <button class="flex-1 text-[10px] text-txt-muted hover:text-txt border border-border rounded-lg py-1.5 hover:bg-surface transition-colors" onclick="resetEffects()">Reset</button>
            <button class="flex-1 text-[10px] text-txt font-bold bg-brand hover:bg-brand-hover rounded-lg py-1.5 transition-colors" onclick="applyEffects()">Apply & Save</button>
          </div>
        </div>

        <!-- Tags -->
        <div>
          <h4 class="text-[10px] font-semibold text-txt-muted uppercase tracking-wider mb-1.5">Tags</h4>
          <div id="inspector-tags" class="flex flex-wrap gap-1"></div>
        </div>

        <!-- Notes -->
        <div>
          <h4 class="text-[10px] font-semibold text-txt-muted uppercase tracking-wider mb-1.5">Notes</h4>
          <textarea id="inspector-notes" class="w-full h-14 rounded-lg bg-bg border border-border focus:border-brand focus:ring-1 focus:ring-brand p-2 text-txt text-[11px] resize-none placeholder:text-txt-dim" placeholder="Add notes..." oninput="updateSampleNotes()"></textarea>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- ========== PAGE: LIBRARY ========== -->
<div id="page-library" class="page flex-col flex-1 overflow-hidden">
  <header class="flex flex-wrap items-center justify-between gap-4 px-8 pt-6 pb-4">
    <div>
      <h2 class="text-3xl font-black tracking-tight">Sample Library</h2>
      <p class="text-txt-muted text-sm">Your accepted samples and loops.</p>
    </div>
    <div class="flex items-center gap-3">
      <button class="flex items-center gap-2 bg-surface text-txt px-4 py-2 rounded-lg text-sm font-bold border border-border hover:bg-dk-gray transition-colors" onclick="openImportModal()">
        <span class="material-symbols-outlined text-[18px]">upload</span> Import
      </button>
      <button class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-txt px-4 py-2 rounded-lg text-sm font-bold transition-all" onclick="navigateTo('generate')">
        <span class="material-symbols-outlined text-[18px]">magic_button</span> Generate New
      </button>
    </div>
  </header>
  <!-- Filters -->
  <div class="px-8 pb-4 flex flex-wrap items-center gap-3">
    <div class="relative flex-1 max-w-xs">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[20px]">search</span>
      <input id="lib-search" class="w-full bg-surface border border-border rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search library..." type="text" oninput="renderLibrary()"/>
    </div>
    <div class="flex gap-2">
      <button class="param-chip active text-[11px]" onclick="setLibType('all', this)">All</button>
      <button class="param-chip text-[11px]" onclick="setLibType('loop', this)">Loops</button>
      <button class="param-chip text-[11px]" onclick="setLibType('oneshot', this)">One-Shots</button>
    </div>
    <select id="lib-key-filter" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderLibrary()">
      <option value="all">All Keys</option>
      <option>C</option><option>Cm</option><option>D</option><option>Dm</option><option>E</option><option>Em</option>
      <option>F</option><option>Fm</option><option>G</option><option>Gm</option><option>A</option><option>Am</option><option>B</option><option>Bm</option>
    </select>
    <select id="lib-sort" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderLibrary()">
      <option value="recent">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="name">Name A-Z</option>
      <option value="bpm">BPM</option>
    </select>
    <div class="flex gap-1 ml-auto">
      <button id="lib-grid-btn" class="p-2 rounded-lg bg-surface border border-border text-brand" onclick="setLibView('grid')">
        <span class="material-symbols-outlined text-[18px]">grid_view</span>
      </button>
      <button id="lib-list-btn" class="p-2 rounded-lg text-txt-muted hover:text-txt hover:bg-surface transition-colors" onclick="setLibView('list')">
        <span class="material-symbols-outlined text-[18px]">view_list</span>
      </button>
    </div>
  </div>
  <!-- Content -->
  <div class="flex-1 overflow-auto px-8 pb-32">
    <div id="lib-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="lib-list" class="hidden bg-panel rounded-xl border border-border overflow-hidden">
      <table class="w-full text-left border-collapse">
        <thead><tr class="bg-surface">
          <th class="px-4 py-3 w-10"><input type="checkbox" class="rounded border-border" onchange="toggleSelectAll(this)"/></th>
          <th class="px-4 py-3 text-xs font-semibold">Sample</th>
          <th class="px-4 py-3 text-xs font-semibold">Type</th>
          <th class="px-4 py-3 text-xs font-semibold">Key</th>
          <th class="px-4 py-3 text-xs font-semibold">BPM</th>
          <th class="px-4 py-3 text-xs font-semibold">Duration</th>
          <th class="px-4 py-3 text-xs font-semibold text-right">Actions</th>
        </tr></thead>
        <tbody id="lib-tbody" class="divide-y divide-border"></tbody>
      </table>
    </div>
    <div id="lib-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl mt-4">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">library_music</span>
      <p class="text-txt-muted font-medium">Your library is empty</p>
      <p class="text-txt-dim text-sm">Accept generated samples to add them here.</p>
    </div>
  </div>
  <!-- Batch bar -->
  <div id="lib-batch-bar" class="hidden batch-bar fixed left-64 right-0 z-40 flex items-center justify-between px-8 py-3 bg-panel border-t border-border" style="bottom: 64px;">
    <span class="text-sm font-bold"><span id="batch-count">0</span> samples selected</span>
    <div class="flex items-center gap-3">
      <button class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-txt px-4 py-2 rounded-lg text-sm font-bold transition-colors" onclick="downloadSelectedAsZip()">
        <span class="material-symbols-outlined text-[18px]">download</span> Download ZIP
      </button>
      <button class="flex items-center gap-2 bg-surface border border-border text-txt px-4 py-2 rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="favoriteSelected()">
        <span class="material-symbols-outlined text-[18px]">favorite</span> Favorite
      </button>
      <button class="flex items-center gap-2 text-red-400 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500/10 transition-colors" onclick="deleteSelected()">
        <span class="material-symbols-outlined text-[18px]">delete</span> Delete
      </button>
    </div>
  </div>
</div>

<!-- ========== PAGE: FAVORITES ========== -->
<div id="page-favorites" class="page flex-col flex-1 overflow-hidden">
  <header class="flex flex-wrap items-center justify-between gap-4 px-8 pt-6 pb-4">
    <div class="flex items-center gap-3">
      <span class="material-symbols-outlined text-brand text-3xl fill-1">favorite</span>
      <div>
        <h2 class="text-3xl font-black tracking-tight">Favorites</h2>
        <p class="text-txt-muted text-sm"><span id="fav-count">0</span> favorited samples</p>
      </div>
    </div>
  </header>
  <div class="px-8 pb-4 flex flex-wrap items-center gap-3">
    <div class="relative flex-1 max-w-xs">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[20px]">search</span>
      <input id="fav-search" class="w-full bg-surface border border-border rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search favorites..." type="text" oninput="renderFavorites()"/>
    </div>
    <select id="fav-sort" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderFavorites()">
      <option value="fav-recent">Recently Favorited</option>
      <option value="recent">Newest Created</option>
      <option value="name">Name A-Z</option>
      <option value="bpm">BPM</option>
    </select>
  </div>
  <div class="flex-1 overflow-auto px-8 pb-28">
    <div id="fav-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
    <div id="fav-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block fill-1">favorite</span>
      <p class="text-txt-muted font-medium">No favorites yet</p>
      <p class="text-txt-dim text-sm">Click the heart icon on any sample to add it here.</p>
    </div>
  </div>
</div>

<!-- ========== PAGE: HISTORY ========== -->
<div id="page-history" class="page flex-col flex-1 overflow-hidden">
  <header class="px-8 pt-6 pb-4">
    <h2 class="text-3xl font-black tracking-tight">Generation History</h2>
    <p class="text-txt-muted text-sm">Review your previous generation sessions.</p>
  </header>
  <div class="px-8 pb-4 flex items-center gap-3">
    <div class="relative flex-1 max-w-xs">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-txt-dim text-[20px]">search</span>
      <input id="hist-search" class="w-full bg-surface border border-border rounded-lg pl-10 pr-4 py-2 text-sm focus:ring-2 focus:ring-brand/50 focus:border-brand text-txt placeholder-txt-dim" placeholder="Search history..." type="text" oninput="renderHistory()"/>
    </div>
    <select id="hist-type-filter" class="bg-surface border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderHistory()">
      <option value="all">All Types</option>
      <option value="loop">Loops</option>
      <option value="oneshot">One-Shots</option>
    </select>
  </div>
  <div class="flex-1 overflow-auto px-8 pb-28">
    <div id="hist-timeline" class="space-y-4"></div>
    <div id="hist-empty" class="hidden text-center py-16 border-2 border-dashed border-border rounded-2xl">
      <span class="material-symbols-outlined text-4xl text-txt-dim mb-3 block">history</span>
      <p class="text-txt-muted font-medium">No generation history yet</p>
      <p class="text-txt-dim text-sm">Your generation sessions will appear here.</p>
    </div>
  </div>
</div>

</div>

<!-- ==================== PLAYER BAR ==================== -->
<footer id="player-bar" class="fixed bottom-0 left-0 right-0 z-50 glass-effect border-t border-border px-6 py-3" style="display:none;">
  <div class="flex items-center gap-6">
    <div class="flex items-center gap-3 w-48 flex-shrink-0">
      <div class="w-10 h-10 rounded-lg bg-surface overflow-hidden flex-shrink-0">
        <canvas id="player-mini-waveform" width="40" height="40"></canvas>
      </div>
      <div class="min-w-0">
        <p id="player-title" class="font-bold text-xs truncate">Sample</p>
        <p id="player-meta" class="text-[10px] text-txt-muted truncate">120 BPM / Cm</p>
      </div>
    </div>
    <div class="flex-1 flex items-center gap-3">
      <button id="btn-play" class="w-10 h-10 rounded-full bg-brand text-txt flex items-center justify-center hover:bg-brand-hover transition-all flex-shrink-0" onclick="togglePlayPause()">
        <span class="material-symbols-outlined text-[24px] fill-1">play_arrow</span>
      </button>
      <button id="btn-loop" class="text-txt-muted hover:text-txt transition-colors flex-shrink-0" onclick="toggleLoopPlayback()">
        <span class="material-symbols-outlined text-[20px]">loop</span>
      </button>
      <span id="player-current-time" class="text-[10px] font-mono text-txt-dim w-8 text-right flex-shrink-0">0:00</span>
      <div class="flex-1 h-10 relative cursor-pointer" onclick="seekSample(event)">
        <canvas id="player-waveform" class="w-full h-full"></canvas>
      </div>
      <span id="player-total-time" class="text-[10px] font-mono text-txt-dim w-8 flex-shrink-0">0:00</span>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <button id="player-fav-btn" class="text-txt-muted hover:text-brand transition-colors" onclick="togglePlayerFav()">
        <span class="material-symbols-outlined text-[20px]">favorite</span>
      </button>
      <button class="text-txt-muted hover:text-txt transition-colors" onclick="downloadSample(state.currentSample)">
        <span class="material-symbols-outlined text-[20px]">download</span>
      </button>
      <div class="flex items-center gap-2">
        <button onclick="toggleMute()" class="text-txt-muted hover:text-txt"><span id="volume-icon" class="material-symbols-outlined text-[20px]">volume_up</span></button>
        <input id="volume-slider" type="range" min="0" max="100" value="66" class="w-16 effect-slider" oninput="setVolume(this.value)"/>
      </div>
    </div>
  </div>
</footer>

</div>

<div id="toast" class="toast"></div>

<!-- Reject feedback modal -->
<div id="reject-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border rounded-2xl p-6 w-full max-w-sm animate-fadeIn">
    <h3 class="text-lg font-bold mb-3">Why reject this sample?</h3>
    <div class="space-y-2 mb-4">
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('too_muddy')">Too muddy</button>
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('wrong_feel')">Wrong feel</button>
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('too_busy')">Too busy</button>
      <button class="w-full text-left px-4 py-2.5 bg-surface border border-border rounded-lg text-sm hover:bg-dk-gray transition-colors" onclick="submitReject('low_quality')">Low quality</button>
    </div>
    <button class="text-txt-dim text-sm hover:text-txt" onclick="submitReject('skip')">Skip feedback</button>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirm-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border rounded-2xl p-6 w-full max-w-sm animate-fadeIn">
    <h3 id="confirm-title" class="text-lg font-bold mb-2"></h3>
    <p id="confirm-msg" class="text-sm text-txt-muted mb-5"></p>
    <div class="flex gap-3">
      <button class="flex-1 py-2 bg-surface border border-border rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="closeModal()">Cancel</button>
      <button id="confirm-action" class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-bold text-txt transition-colors">Confirm</button>
    </div>
  </div>
</div>

<!-- Import from Project modal -->
<div id="import-modal" class="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="bg-panel border border-border rounded-2xl w-full max-w-lg animate-fadeIn flex flex-col max-h-[80vh]">
    <div class="p-6 pb-4 border-b border-border">
      <h3 class="text-lg font-bold mb-3">Import from Project</h3>
      <select id="import-project-select" class="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-txt" onchange="renderImportList()">
        <option value="">Select a project...</option>
      </select>
    </div>
    <div class="flex-1 overflow-y-auto p-4" id="import-sample-list">
      <p class="text-sm text-txt-dim text-center py-8">Select a project to see its samples</p>
    </div>
    <div class="p-4 border-t border-border flex items-center justify-between">
      <span class="text-sm text-txt-muted"><span id="import-selected-count">0</span> selected</span>
      <div class="flex gap-3">
        <button class="px-4 py-2 bg-surface border border-border rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="closeModal()">Cancel</button>
        <button id="import-btn" class="px-4 py-2 bg-brand hover:bg-brand-hover rounded-lg text-sm font-bold text-txt transition-colors" onclick="importSelectedSamples()">Import Selected</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div id="settings-modal" class="modal-overlay" onclick="if(event.target===this)closeSettingsModal()">
  <div class="bg-panel border border-border rounded-2xl w-full max-w-md animate-fadeIn">
    <div class="p-6 pb-4 border-b border-border flex items-center justify-between">
      <h3 class="text-lg font-bold">Settings</h3>
      <button class="w-7 h-7 rounded-full bg-surface hover:bg-dk-gray flex items-center justify-center text-txt-muted hover:text-txt transition-colors" onclick="closeSettingsModal()">
        <span class="material-symbols-outlined text-[16px]">close</span>
      </button>
    </div>
    <div class="p-6 space-y-5">
      <!-- API Key Section -->
      <div>
        <label class="block text-sm font-bold mb-2">ElevenLabs API Key</label>
        <p class="text-xs text-txt-muted mb-3">Required for AI-generated samples. Get a key at <a href="https://elevenlabs.io/developers" target="_blank" class="text-brand hover:underline">elevenlabs.io/developers</a></p>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <input id="settings-api-key" type="password" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-sm text-txt placeholder:text-txt-dim pr-10 font-mono" placeholder="xi_..." />
            <button class="absolute right-2 top-1/2 -translate-y-1/2 text-txt-dim hover:text-txt p-1" onclick="toggleApiKeyVisibility()">
              <span class="material-symbols-outlined text-[18px]" id="api-key-eye">visibility_off</span>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-2 mt-3">
          <button id="api-test-btn" class="flex items-center gap-2 bg-surface border border-border text-txt px-4 py-2 rounded-lg text-sm font-bold hover:bg-dk-gray transition-colors" onclick="testApiKey()">
            <span class="material-symbols-outlined text-[16px]">bolt</span>
            <span id="api-test-label">Test Connection</span>
          </button>
          <button class="flex items-center gap-2 bg-brand hover:bg-brand-hover text-txt px-4 py-2 rounded-lg text-sm font-bold transition-colors" onclick="saveApiKey()">
            <span class="material-symbols-outlined text-[16px]">save</span> Save
          </button>
          <div id="api-status" class="flex items-center gap-1.5 ml-auto"></div>
        </div>
      </div>
      <!-- Divider -->
      <div class="border-t border-border"></div>
      <!-- Clear Data -->
      <div>
        <label class="block text-sm font-bold mb-1">Data</label>
        <p class="text-xs text-txt-muted mb-3">Clear all local data including samples, projects, and audio.</p>
        <button class="flex items-center gap-2 text-red-400 border border-red-500/30 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500/10 transition-colors" onclick="clearAllDataConfirm()">
          <span class="material-symbols-outlined text-[16px]">delete_forever</span> Clear All Data
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== API CONFIG ====================
let ELEVENLABS_API_KEY = localStorage.getItem('fiire_api_key') || '';

// ==================== STATE ====================
const state = {
  currentPage: 'dashboard',
  generateMode: 'loop',
  isPlaying: false,
  currentSample: null,
  inspectedSample: null,
  currentTime: 0,
  totalTime: 0,
  volume: 66,
  isMuted: false,
  loopPlayback: false,
  progressInterval: null,
  generating: false,
  selectedSamples: new Set(),
  libraryView: 'grid',
  libraryType: 'all',
  wsView: 'stack',
  rejectingSampleId: null,
  confirmCallback: null,
  selectedBars: 4,
};

let samples = {};
let sessions = {};
let decisions = [];
let currentVariations = [];
let varIdCounter = 0;
let projects = {};
let currentProjectId = null;

// ==================== PERSISTENCE ====================
function saveData() {
  try {
    localStorage.setItem('fiire_samples', JSON.stringify(samples));
    localStorage.setItem('fiire_sessions', JSON.stringify(sessions));
    localStorage.setItem('fiire_decisions', JSON.stringify(decisions));
    localStorage.setItem('fiire_counters', JSON.stringify({ varIdCounter }));
    localStorage.setItem('fiire_projects', JSON.stringify(projects));
    localStorage.setItem('fiire_current_project', currentProjectId);
  } catch(e) {}
}
function loadData() {
  try {
    const s = localStorage.getItem('fiire_samples'); if (s) samples = JSON.parse(s);
    const ss = localStorage.getItem('fiire_sessions'); if (ss) sessions = JSON.parse(ss);
    const d = localStorage.getItem('fiire_decisions'); if (d) decisions = JSON.parse(d);
    const c = localStorage.getItem('fiire_counters'); if (c) { const p = JSON.parse(c); varIdCounter = p.varIdCounter || 0; }
    const pr = localStorage.getItem('fiire_projects'); if (pr) projects = JSON.parse(pr);
    const cp = localStorage.getItem('fiire_current_project'); if (cp) currentProjectId = cp;
  } catch(e) {}
}

function migrateToProjects() {
  if (Object.keys(projects).length > 0) return; // already migrated
  const id = 'proj_default';
  projects[id] = { id, name: 'My Project', createdAt: Date.now(), updatedAt: Date.now() };
  currentProjectId = id;
  // Stamp all existing samples and sessions
  Object.values(samples).forEach(s => { if (!s.projectId) s.projectId = id; });
  Object.values(sessions).forEach(s => { if (!s.projectId) s.projectId = id; });
  saveData();
}

function getProjectSampleCount(projectId) {
  return Object.values(samples).filter(s => s.projectId === projectId).length;
}

// ==================== INDEXEDDB AUDIO STORAGE ====================
let audioDB = null;
const AUDIO_DB_NAME = 'fiire_audio';
const AUDIO_STORE = 'buffers';

function openAudioDB() {
  if (audioDB) return Promise.resolve(audioDB);
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(AUDIO_DB_NAME, 1);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(AUDIO_STORE)) {
        db.createObjectStore(AUDIO_STORE);
      }
    };
    req.onsuccess = (e) => { audioDB = e.target.result; resolve(audioDB); };
    req.onerror = () => reject(req.error);
  });
}

function saveAudioBlob(sampleId, arrayBuffer) {
  return openAudioDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(AUDIO_STORE, 'readwrite');
      tx.objectStore(AUDIO_STORE).put(arrayBuffer, sampleId);
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  }).catch(() => {}); // fail silently
}

function loadAudioBlob(sampleId) {
  return openAudioDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(AUDIO_STORE, 'readonly');
      const req = tx.objectStore(AUDIO_STORE).get(sampleId);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    });
  }).catch(() => null);
}

function deleteAudioBlob(sampleId) {
  return openAudioDB().then(db => {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(AUDIO_STORE, 'readwrite');
      tx.objectStore(AUDIO_STORE).delete(sampleId);
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  }).catch(() => {});
}

function deleteAudioBlobsForProject(projectId) {
  const ids = Object.values(samples).filter(s => s.projectId === projectId).map(s => s.id);
  return Promise.all(ids.map(id => deleteAudioBlob(id)));
}

// ==================== UTILITIES ====================
function uid(prefix) { return prefix + '_' + (++varIdCounter) + '_' + Date.now().toString(36); }
function formatTime(s) { const m = Math.floor(s/60); const sec = Math.floor(s%60); return m+':'+(sec<10?'0':'')+sec; }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); state.rejectingSampleId = null; }

// ==================== AUDIO ENGINE ====================
let audioCtx = null;
let masterGain = null;
let currentSource = null;
let audioBuffers = {}; // sampleId -> AudioBuffer
let playbackStartTime = 0;
let playbackOffset = 0;

function initAudioContext() {
  if (audioCtx) return audioCtx;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = state.volume / 100;
  masterGain.connect(audioCtx.destination);
  return audioCtx;
}

function ensureAudioContext() {
  initAudioContext();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function generateSyntheticAudio(sample) {
  ensureAudioContext();
  const dur = sample.duration || 2;
  const sr = audioCtx.sampleRate;
  const len = Math.ceil(dur * sr);
  const buf = audioCtx.createBuffer(2, len, sr);
  const bpm = sample.bpm || 120;

  for (let ch = 0; ch < 2; ch++) {
    const d = buf.getChannelData(ch);
    if (sample.type === 'loop') {
      const beatLen = Math.floor(60 / bpm * sr);
      for (let i = 0; i < len; i++) {
        const posInBeat = i % beatLen;
        const beatFrac = posInBeat / beatLen;
        let val = 0;
        // Kick on downbeats
        if (beatFrac < 0.06) {
          const env = 1 - beatFrac / 0.06;
          const freq = 55 + 180 * env * env;
          val += Math.sin(2 * Math.PI * freq * i / sr) * env * env * 0.7;
        }
        // Snare on beats 2 and 4
        const halfBeat = i % (beatLen * 2);
        const halfFrac = halfBeat / (beatLen * 2);
        if (halfFrac > 0.49 && halfFrac < 0.54) {
          const t = (halfFrac - 0.49) / 0.05;
          const env = Math.max(0, 1 - t * 1.5);
          val += (Math.random() * 2 - 1) * env * 0.35;
          val += Math.sin(2 * Math.PI * 200 * i / sr) * env * 0.2;
        }
        // Hi-hat on 8ths
        const eighthLen = Math.floor(beatLen / 2);
        const eighthPos = i % eighthLen;
        const eighthFrac = eighthPos / eighthLen;
        if (eighthFrac < 0.015) {
          const env = 1 - eighthFrac / 0.015;
          val += (Math.random() * 2 - 1) * env * 0.12;
        }
        d[i] = val;
      }
    } else {
      // One-shot: percussive hit
      for (let i = 0; i < len; i++) {
        const t = i / sr;
        const env = Math.exp(-t * 20);
        const pitch = 180 + 600 * Math.exp(-t * 40);
        d[i] = Math.sin(2 * Math.PI * pitch * t) * env * 0.55
             + (Math.random() * 2 - 1) * env * 0.35;
      }
    }
    // Slight stereo variation on right channel
    if (ch === 1) {
      for (let i = 0; i < len; i++) d[i] *= 0.95 + Math.random() * 0.1;
    }
  }
  return buf;
}

function cacheAndPersistBuffer(sampleId, buf) {
  audioBuffers[sampleId] = buf;
  updateSampleWaveform(sampleId, buf);
  // Persist to IndexedDB as WAV
  const wav = audioBufferToWav(buf);
  saveAudioBlob(sampleId, wav);
  return buf;
}

function getAudioBuffer(sampleId) {
  if (audioBuffers[sampleId]) return Promise.resolve(audioBuffers[sampleId]);
  const s = samples[sampleId];
  if (!s) return Promise.resolve(null);
  ensureAudioContext();

  // Try IndexedDB first
  return loadAudioBlob(sampleId).then(stored => {
    if (stored) {
      return audioCtx.decodeAudioData(stored).then(buf => {
        audioBuffers[sampleId] = buf;
        updateSampleWaveform(sampleId, buf);
        return buf;
      });
    }
    // If sample has a real audio URL, fetch and decode
    if (s.audioUrl) {
      return fetch(s.audioUrl)
        .then(r => r.arrayBuffer())
        .then(ab => audioCtx.decodeAudioData(ab))
        .then(buf => cacheAndPersistBuffer(sampleId, buf))
        .catch(() => cacheAndPersistBuffer(sampleId, generateSyntheticAudio(s)));
    }
    // Generate synthetic placeholder
    return cacheAndPersistBuffer(sampleId, generateSyntheticAudio(s));
  }).catch(() => {
    // IndexedDB failed, fall back to generation
    return cacheAndPersistBuffer(sampleId, generateSyntheticAudio(s));
  });
}

function stopCurrentSource() {
  if (currentSource) {
    try { currentSource.onended = null; currentSource.stop(); } catch(e) {}
    try { currentSource.disconnect(); } catch(e) {}
    currentSource = null;
  }
}

function playAudioBuffer(sampleId, offset) {
  offset = offset || 0;
  ensureAudioContext();
  stopCurrentSource();
  return getAudioBuffer(sampleId).then(buf => {
    if (!buf) return;
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.loop = state.loopPlayback;
    // Route through effects chain if inspector is open for this sample
    if (state.inspectedSample === sampleId) {
      buildFxChain();
      src.connect(fxDistortion);
      const vals = getEffectValues();
      Object.entries(vals).forEach(([fx, v]) => applyFxValue(fx, v));
    } else {
      src.connect(masterGain);
    }
    playbackStartTime = audioCtx.currentTime;
    playbackOffset = offset;
    state.totalTime = buf.duration;
    src.start(0, offset);
    src.onended = () => {
      if (currentSource === src && !state.loopPlayback) {
        state.isPlaying = false;
        state.currentTime = state.totalTime;
        updatePlayButton();
        stopProgress();
        document.getElementById('player-current-time').textContent = formatTime(state.totalTime);
        drawPlayerWaveform(1);
      }
    };
    currentSource = src;
  });
}

function extractPeaks(audioBuffer, barCount) {
  barCount = barCount || 100;
  const chan = audioBuffer.getChannelData(0);
  const len = chan.length;
  const chunkSize = Math.floor(len / barCount);
  const peaks = [];
  let maxPeak = 0;
  for (let i = 0; i < barCount; i++) {
    const start = i * chunkSize;
    const end = Math.min(start + chunkSize, len);
    let peak = 0;
    for (let j = start; j < end; j++) {
      const abs = Math.abs(chan[j]);
      if (abs > peak) peak = abs;
    }
    peaks.push(peak);
    if (peak > maxPeak) maxPeak = peak;
  }
  if (maxPeak > 0) {
    for (let i = 0; i < peaks.length; i++) peaks[i] = peaks[i] / maxPeak;
  }
  return peaks;
}

function updateSampleWaveform(sampleId, audioBuffer) {
  const s = samples[sampleId];
  if (!s) return;
  s.waveformData = extractPeaks(audioBuffer, 80 + Math.floor(Math.random() * 40));
  // Re-render any visible waveform canvases for this sample
  document.querySelectorAll(`canvas[data-id="${sampleId}"]`).forEach(canvas => {
    if (canvas.classList.contains('var-waveform') || canvas.classList.contains('lib-waveform')) {
      drawWaveform(canvas, s.waveformData, s.status === 'rejected' ? '#444' : '#E85002');
    } else if (canvas.classList.contains('lib-waveform-row')) {
      drawMiniWaveform(canvas, s.waveformData, '#E85002');
    }
  });
}

function getPlaybackTime() {
  if (!audioCtx || !state.isPlaying) return state.currentTime;
  const t = playbackOffset + (audioCtx.currentTime - playbackStartTime);
  if (state.loopPlayback && state.totalTime > 0) return t % state.totalTime;
  return Math.min(t, state.totalTime);
}

// ==================== PROJECTS ====================
let projectDropdownOpen = false;

function toggleProjectDropdown() {
  projectDropdownOpen = !projectDropdownOpen;
  const dd = document.getElementById('project-dropdown');
  const chevron = document.getElementById('project-chevron');
  dd.classList.toggle('hidden', !projectDropdownOpen);
  chevron.textContent = projectDropdownOpen ? 'expand_less' : 'expand_more';
  if (projectDropdownOpen) renderProjectList();
}

function closeProjectDropdown() {
  projectDropdownOpen = false;
  document.getElementById('project-dropdown').classList.add('hidden');
  document.getElementById('project-chevron').textContent = 'expand_more';
  cancelNewProject();
}

function renderProjectSwitcher() {
  const proj = projects[currentProjectId];
  if (!proj) return;
  document.getElementById('project-name').textContent = proj.name;
  const count = getProjectSampleCount(currentProjectId);
  document.getElementById('project-count').textContent = count + ' sample' + (count !== 1 ? 's' : '');
}

function renderProjectList() {
  const list = document.getElementById('project-list');
  const sorted = Object.values(projects).sort((a, b) => b.updatedAt - a.updatedAt);
  list.innerHTML = sorted.map(p => {
    const count = getProjectSampleCount(p.id);
    const isActive = p.id === currentProjectId;
    return `
      <div class="flex items-center gap-2 px-3 py-2 hover:bg-surface transition-colors cursor-pointer group ${isActive ? 'bg-surface' : ''}" onclick="switchProject('${p.id}')">
        <div class="w-6 h-6 rounded-md ${isActive ? 'bg-brand/20' : 'bg-bg'} flex items-center justify-center flex-shrink-0">
          ${isActive ? '<span class="material-symbols-outlined text-brand text-[14px]">check</span>' : '<span class="material-symbols-outlined text-txt-dim text-[14px]">folder</span>'}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate ${isActive ? 'text-brand' : ''}">${p.name}</p>
          <p class="text-[10px] text-txt-dim">${count} sample${count !== 1 ? 's' : ''}</p>
        </div>
        <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
          <button class="p-1 rounded hover:bg-dk-gray text-txt-dim hover:text-txt" onclick="event.stopPropagation(); renameProjectPrompt('${p.id}')">
            <span class="material-symbols-outlined text-[14px]">edit</span>
          </button>
          ${Object.keys(projects).length > 1 ? `<button class="p-1 rounded hover:bg-dk-gray text-txt-dim hover:text-red-400" onclick="event.stopPropagation(); deleteProjectConfirm('${p.id}')">
            <span class="material-symbols-outlined text-[14px]">delete</span>
          </button>` : ''}
        </div>
      </div>`;
  }).join('');
}

function switchProject(id) {
  if (id === currentProjectId) { closeProjectDropdown(); return; }
  currentProjectId = id;
  projects[id].updatedAt = Date.now();
  currentVariations = [];
  state.currentSample = null;
  state.inspectedSample = null;
  document.getElementById('player-bar').style.display = 'none';
  closeProjectDropdown();
  saveData();
  renderProjectSwitcher();
  navigateTo(state.currentPage);
  showToast('Switched to ' + projects[id].name);
}

function createProject(name) {
  const id = uid('proj');
  projects[id] = { id, name: name || 'Untitled Project', createdAt: Date.now(), updatedAt: Date.now() };
  saveData();
  switchProject(id);
}

function showNewProjectInput() {
  document.getElementById('new-project-row').classList.add('hidden');
  document.getElementById('new-project-input-row').classList.remove('hidden');
  const input = document.getElementById('new-project-input');
  input.value = '';
  input.focus();
}

function confirmNewProject() {
  const input = document.getElementById('new-project-input');
  const name = input.value.trim();
  if (!name) return;
  createProject(name);
  cancelNewProject();
}

function cancelNewProject() {
  document.getElementById('new-project-row').classList.remove('hidden');
  document.getElementById('new-project-input-row').classList.add('hidden');
}

function renameProjectPrompt(id) {
  const p = projects[id];
  if (!p) return;
  const name = prompt('Rename project:', p.name);
  if (name && name.trim()) {
    p.name = name.trim();
    p.updatedAt = Date.now();
    saveData();
    renderProjectSwitcher();
    renderProjectList();
    showToast('Project renamed');
  }
}

function deleteProjectConfirm(id) {
  const p = projects[id];
  if (!p || Object.keys(projects).length <= 1) return;
  document.getElementById('confirm-title').textContent = 'Delete Project';
  document.getElementById('confirm-msg').textContent = `Delete "${p.name}" and all its samples? This can't be undone.`;
  document.getElementById('confirm-action').onclick = () => {
    // Delete all samples, sessions, and audio blobs for this project
    Object.keys(samples).forEach(sid => { if (samples[sid].projectId === id) { deleteAudioBlob(sid); delete audioBuffers[sid]; delete samples[sid]; } });
    Object.keys(sessions).forEach(sid => { if (sessions[sid].projectId === id) delete sessions[sid]; });
    decisions = decisions.filter(d => samples[d.sampleId]); // clean up orphaned decisions
    delete projects[id];
    if (currentProjectId === id) {
      currentProjectId = Object.keys(projects)[0];
    }
    saveData();
    closeModal();
    closeProjectDropdown();
    renderProjectSwitcher();
    navigateTo(state.currentPage);
    showToast('Project deleted');
  };
  document.getElementById('confirm-modal').classList.add('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (projectDropdownOpen && !e.target.closest('#project-switcher') && !e.target.closest('#project-dropdown')) {
    closeProjectDropdown();
  }
});

// ==================== NAVIGATION ====================
function navigateTo(page) {
  state.currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const target = document.getElementById('page-' + page);
  if (target) { target.classList.add('active', 'animate-fadeIn'); setTimeout(() => target.classList.remove('animate-fadeIn'), 300); }
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active'); link.classList.add('text-txt-muted');
    if (link.dataset.page === page) { link.classList.add('active'); link.classList.remove('text-txt-muted'); }
  });
  if (page === 'generate') renderVariations();
  if (page === 'library') renderLibrary();
  if (page === 'favorites') renderFavorites();
  if (page === 'history') renderHistory();
  if (page === 'dashboard') renderDashboard();
  renderProjectSwitcher();
}

// ==================== WAVEFORM RENDERING ====================
function placeholderWaveform(length) {
  const data = [];
  for (let i = 0; i < (length || 80); i++) data.push(0.3);
  return data;
}

function drawWaveform(canvas, data, color, progress) {
  if (!canvas || !data) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.offsetWidth * 2;
  const h = canvas.height = canvas.offsetHeight * 2;
  ctx.clearRect(0, 0, w, h);
  const barW = Math.max(2, w / data.length - 1);
  const gap = 1;
  const mid = h / 2;
  for (let i = 0; i < data.length; i++) {
    const x = i * (barW + gap);
    const barH = data[i] * mid * 0.85;
    const pct = x / w;
    if (progress !== undefined && pct <= progress) {
      ctx.fillStyle = color || '#E85002';
    } else {
      ctx.fillStyle = progress !== undefined ? '#333' : (color || '#E85002');
    }
    ctx.fillRect(x, mid - barH, barW, barH * 2);
  }
}

function drawMiniWaveform(canvas, data, color) {
  if (!canvas || !data) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width; const h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  const barW = 2; const gap = 1;
  const mid = h / 2;
  const count = Math.floor(w / (barW + gap));
  const step = Math.max(1, Math.floor(data.length / count));
  ctx.fillStyle = color || '#E85002';
  for (let i = 0; i < count; i++) {
    const val = data[Math.min(i * step, data.length - 1)] || 0.5;
    const barH = val * mid * 0.8;
    ctx.fillRect(i * (barW + gap), mid - barH, barW, barH * 2);
  }
}

// ==================== GENERATE MODE ====================
let wsStatusFilter = 'all';

function setGenerateMode(mode) {
  state.generateMode = mode;
  const loopEl = document.getElementById('loop-params');
  const osEl = document.getElementById('oneshot-params');
  if (mode === 'loop') {
    loopEl.style.display = 'flex';
    osEl.style.display = 'none';
  } else {
    loopEl.style.display = 'none';
    osEl.style.display = 'flex';
  }
  document.querySelectorAll('input[name="gen-mode"]').forEach(r => { r.checked = r.value === mode; });
  updateGenBtnText();
}

function updateGenBtnText() {
  const count = document.getElementById('var-slider').value;
  document.getElementById('gen-btn-text').textContent = `Generate (${count})`;
}

function setWsFilter(status, btn) {
  wsStatusFilter = status;
  btn.closest('.flex').querySelectorAll('.param-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderVariations();
}

function setWsView(view) {
  state.wsView = view;
  const gridBtn = document.getElementById('ws-grid-btn');
  const stackBtn = document.getElementById('ws-stack-btn');
  gridBtn.classList.toggle('bg-bg', view === 'grid');
  gridBtn.classList.toggle('text-brand', view === 'grid');
  gridBtn.classList.toggle('text-txt-muted', view !== 'grid');
  stackBtn.classList.toggle('bg-bg', view === 'stack');
  stackBtn.classList.toggle('text-brand', view === 'stack');
  stackBtn.classList.toggle('text-txt-muted', view !== 'stack');
  renderVariations();
}

function setLength(bars, el) {
  state.selectedBars = bars;
  document.querySelectorAll('#length-chips .param-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function toggleChip(el, containerId) {
  document.querySelectorAll('#' + containerId + ' .param-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
}

function toggleMultiChip(el) {
  el.classList.toggle('active');
}

// ==================== SAMPLE GENERATION ====================
function getGenParams() {
  const mode = state.generateMode;
  const styles = [...document.querySelectorAll('#style-chips .param-chip.active')].map(c => c.textContent.trim());
  const prompt = document.getElementById('gen-prompt').value;
  const model = document.getElementById('model-select').value;
  const varCount = parseInt(document.getElementById('var-slider').value);

  if (mode === 'loop') {
    return {
      type: 'loop', bpm: parseInt(document.getElementById('bpm-input').value),
      key: document.getElementById('key-select').value,
      bars: state.selectedBars,
      styles, prompt, model, varCount
    };
  } else {
    const attack = document.querySelector('#attack-chips .param-chip.active')?.textContent.trim() || 'Snappy';
    const timbre = document.querySelector('#timbre-chips .param-chip.active')?.textContent.trim() || 'Warm';
    return {
      type: 'oneshot', tuning: document.getElementById('tuning-select').value,
      attack, timbre, styles, prompt, model, varCount
    };
  }
}

function buildSfxPrompt(params) {
  const parts = [];
  if (params.type === 'loop') {
    parts.push(`${params.bpm} BPM`);
    if (params.key) parts.push(`${params.key}`);
    if (params.styles?.length) parts.push(params.styles.join(', '));
    parts.push('drum loop');
    if (params.bars) parts.push(`${params.bars} bars`);
  } else {
    if (params.attack) parts.push(params.attack.toLowerCase());
    if (params.timbre) parts.push(params.timbre.toLowerCase());
    if (params.styles?.length) parts.push(params.styles.join(', '));
    parts.push('one-shot percussion hit');
    if (params.tuning) parts.push(`tuned to ${params.tuning}`);
  }
  if (params.prompt) parts.push(params.prompt);
  return parts.join(', ');
}

function calcDuration(params) {
  if (params.type === 'loop') {
    const secsPerBeat = 60 / (params.bpm || 120);
    return Math.min(30, Math.max(0.5, params.bars * secsPerBeat * (params.bpm < 100 ? 2 : 1)));
  }
  return 1.5; // one-shot default
}

function callElevenLabsSfx(prompt, duration, isLoop, modelId) {
  return fetch('https://api.elevenlabs.io/v1/sound-generation?output_format=pcm_44100', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'xi-api-key': ELEVENLABS_API_KEY,
    },
    body: JSON.stringify({
      text: prompt,
      duration_seconds: Math.round(duration * 10) / 10,
      prompt_influence: 0.3,
      loop: isLoop,
      model_id: modelId || 'eleven_text_to_sound_v2',
    }),
  }).then(res => {
    if (!res.ok) return res.text().then(t => { throw new Error(`API ${res.status}: ${t}`); });
    return res.arrayBuffer();
  });
}

function pcmToAudioBuffer(pcmData, sampleRate) {
  ensureAudioContext();
  const int16 = new Int16Array(pcmData);
  const numSamples = int16.length;
  const buf = audioCtx.createBuffer(1, numSamples, sampleRate || 44100);
  const chan = buf.getChannelData(0);
  for (let i = 0; i < numSamples; i++) {
    chan[i] = int16[i] / 32768;
  }
  return buf;
}

function generateSamples() {
  if (state.generating) return;
  state.generating = true;
  const params = getGenParams();
  const useAPI = ELEVENLABS_API_KEY && ELEVENLABS_API_KEY.length > 0;

  document.getElementById('gen-loading').classList.remove('hidden');
  document.getElementById('gen-empty').classList.add('hidden');
  document.getElementById('gen-footer').classList.add('hidden');
  document.getElementById('var-grid').innerHTML = '';

  const sessionId = uid('ses');
  const variationIds = [];
  const duration = calcDuration(params);
  const sfxPrompt = buildSfxPrompt(params);
  const isLoop = params.type === 'loop';

  // Create sample shells
  for (let i = 0; i < params.varCount; i++) {
    const id = uid('smp');
    samples[id] = {
      id, type: params.type,
      name: params.type === 'loop' ? `Loop ${Object.keys(samples).length + 1}` : `One-Shot ${Object.keys(samples).length + 1}`,
      status: 'pending',
      duration: Math.round(duration * 100) / 100,
      bpm: params.bpm || null,
      key: params.key || null,
      bars: params.bars || null,
      tuning: params.tuning || null,
      attack: params.attack || null,
      timbre: params.timbre || null,
      style: params.styles || [],
      tags: params.styles ? [...params.styles] : [],
      notes: '',
      effects: { distortion: 0, reverb: 0, delay: 0, filterLP: 100, bitcrush: 0, saturation: 0 },
      generationSessionId: sessionId,
      variationIndex: i,
      parentSampleId: null,
      modelVersion: useAPI ? 'ElevenLabs SFX v2' : 'Synthetic',
      createdAt: Date.now() - (params.varCount - i) * 100,
      acceptedAt: null,
      favoritedAt: null,
      isFavorite: false,
      isInLibrary: false,
      rejectionFeedback: null,
      waveformData: placeholderWaveform(80),
      projectId: currentProjectId,
    };
    variationIds.push(id);
  }

  sessions[sessionId] = {
    id: sessionId, type: params.type, params,
    variationIds, acceptedCount: 0, rejectedCount: 0,
    createdAt: Date.now(),
    projectId: currentProjectId,
  };

  currentVariations = variationIds;
  saveData();

  if (!useAPI) {
    // No API key  fall back to synthetic audio
    state.generating = false;
    renderVariations();
    document.getElementById('gen-loading').classList.add('hidden');
    document.getElementById('gen-footer').classList.remove('hidden');
    document.getElementById('gen-var-count').textContent = variationIds.length + ' variations';
    showToast('No API key  generated synthetic placeholders');
    ensureAudioContext();
    variationIds.forEach(vid => getAudioBuffer(vid));
    return;
  }

  // Call ElevenLabs SFX API for each variation
  let completed = 0;
  let failed = 0;

  variationIds.forEach((vid, i) => {
    // Stagger requests slightly to avoid rate limits
    setTimeout(() => {
      callElevenLabsSfx(sfxPrompt, duration, isLoop, params.model)
        .then(pcmData => {
          ensureAudioContext();
          const buf = pcmToAudioBuffer(pcmData, 44100);
          samples[vid].duration = buf.duration;
          cacheAndPersistBuffer(vid, buf);
          saveData();
        })
        .catch(err => {
          console.error(`Generation failed for ${vid}:`, err);
          failed++;
          // Fall back to synthetic for this variation
          ensureAudioContext();
          getAudioBuffer(vid);
        })
        .finally(() => {
          completed++;
          if (completed === variationIds.length) {
            state.generating = false;
            renderVariations();
            document.getElementById('gen-loading').classList.add('hidden');
            document.getElementById('gen-footer').classList.remove('hidden');
            document.getElementById('gen-var-count').textContent = variationIds.length + ' variations';
            if (failed > 0) {
              showToast(`Generated ${completed - failed} samples (${failed} fell back to synthetic)`);
            } else {
              showToast(`Generated ${completed} samples from ElevenLabs!`);
            }
          }
        });
    }, i * 500); // 500ms stagger between requests
  });
}

function renderVariations() {
  const container = document.getElementById('var-grid');
  const emptyEl = document.getElementById('gen-empty');
  const footerEl = document.getElementById('gen-footer');
  const search = (document.getElementById('ws-search')?.value || '').toLowerCase();
  const sort = document.getElementById('ws-sort')?.value || 'newest';

  // Show samples for current project
  let list = Object.values(samples).filter(s => s.projectId === currentProjectId);

  // Filter by status
  if (wsStatusFilter !== 'all') list = list.filter(s => s.status === wsStatusFilter);

  // Search
  if (search) list = list.filter(s => s.name.toLowerCase().includes(search) || (s.key || '').toLowerCase().includes(search) || s.tags.some(t => t.toLowerCase().includes(search)) || (s.style || []).some(t => t.toLowerCase().includes(search)));

  // Sort
  if (sort === 'newest') list.sort((a, b) => b.createdAt - a.createdAt);
  else if (sort === 'oldest') list.sort((a, b) => a.createdAt - b.createdAt);
  else if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));

  if (!list.length) {
    container.innerHTML = '';
    emptyEl.classList.remove('hidden');
    footerEl.classList.add('hidden');
    return;
  }
  emptyEl.classList.add('hidden');
  footerEl.classList.remove('hidden');
  document.getElementById('gen-var-count').textContent = list.length + ' sample' + (list.length !== 1 ? 's' : '');

  if (state.wsView === 'stack') {
    container.className = 'space-y-1.5';
    container.innerHTML = list.map(s => renderStackRow(s)).join('');
  } else {
    container.className = 'grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3';
    container.innerHTML = list.map(s => renderGridCard(s)).join('');
  }

  requestAnimationFrame(() => {
    document.querySelectorAll('.var-waveform').forEach(canvas => {
      const id = canvas.dataset.id;
      const s = samples[id];
      if (s) drawWaveform(canvas, s.waveformData, s.status === 'rejected' ? '#444' : '#E85002');
    });
  });
}

function renderGridCard(s) {
  const id = s.id;
  const statusClass = s.status === 'accepted' ? 'accepted' : s.status === 'rejected' ? 'rejected' : '';
  const playingClass = state.currentSample === id ? 'playing' : '';
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack} / ${s.timbre}`;
  const typeBadge = s.type === 'loop' ? 'badge-loop' : 'badge-oneshot';
  return `
    <div class="variation-card ${statusClass} ${playingClass} relative bg-surface rounded-xl border border-border overflow-hidden"
         data-id="${id}" draggable="true" ondragstart="handleDragStart(event,'${id}')">
      <div class="relative h-24 bg-bg p-2 cursor-pointer" onclick="previewSample('${id}')">
        <canvas class="var-waveform w-full h-full" data-id="${id}"></canvas>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
          <div class="w-9 h-9 bg-brand/90 rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-[22px] fill-1 text-txt">${state.currentSample === id && state.isPlaying ? 'pause' : 'play_arrow'}</span>
          </div>
        </div>
        <span class="absolute bottom-1.5 right-1.5 px-1.5 py-0.5 bg-black/75 text-[9px] font-mono text-txt rounded">${formatTime(s.duration)}</span>
        <span class="absolute top-1.5 left-1.5 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${typeBadge}">${s.type}</span>
        ${s.status === 'accepted' ? '<span class="absolute top-1.5 right-1.5 w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center"><span class="material-symbols-outlined text-[12px] text-txt">check</span></span>' : ''}
      </div>
      <div class="p-2.5">
        <p class="text-[11px] font-bold truncate mb-0.5">${s.name}</p>
        <p class="text-[10px] text-txt-dim truncate mb-2">${meta}</p>
        ${s.status === 'pending' ? `
        <div class="flex items-center gap-1">
          <button class="flex-1 flex items-center justify-center gap-0.5 py-1 bg-emerald-500/15 text-emerald-400 rounded-md text-[10px] font-bold hover:bg-emerald-500/25 transition-colors" onclick="event.stopPropagation(); acceptVariation('${id}')">
            <span class="material-symbols-outlined text-[14px]">check</span> Accept
          </button>
          <button class="flex-1 flex items-center justify-center gap-0.5 py-1 bg-red-500/10 text-red-400 rounded-md text-[10px] font-bold hover:bg-red-500/20 transition-colors" onclick="event.stopPropagation(); rejectVariation('${id}')">
            <span class="material-symbols-outlined text-[14px]">close</span> Reject
          </button>
          <button class="p-1 text-txt-muted hover:text-brand rounded-md hover:bg-bg transition-colors" onclick="event.stopPropagation(); toggleSampleFavorite('${id}')">
            <span class="material-symbols-outlined text-[14px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span>
          </button>
        </div>` : s.status === 'accepted' ? `
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-emerald-400 font-bold">Accepted</span>
          <button class="p-1 text-txt-muted hover:text-brand rounded-md" onclick="event.stopPropagation(); toggleSampleFavorite('${id}')">
            <span class="material-symbols-outlined text-[14px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span>
          </button>
        </div>` : `
        <div class="text-[10px] text-red-400 font-bold">${s.rejectionFeedback && s.rejectionFeedback !== 'skip' ? 'Rejected: ' + s.rejectionFeedback.replace('_', ' ') : 'Rejected'}</div>`}
      </div>
    </div>`;
}

function renderStackRow(s) {
  const id = s.id;
  const statusClass = s.status === 'accepted' ? 'accepted' : s.status === 'rejected' ? 'rejected' : '';
  const playingClass = state.currentSample === id ? 'playing' : '';
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack} / ${s.timbre}`;
  const typeBadge = s.type === 'loop' ? 'badge-loop' : 'badge-oneshot';
  const favClass = s.isFavorite ? 'fill-1 text-brand' : '';
  return `
    <div class="variation-card ${statusClass} ${playingClass} bg-surface rounded-lg border border-border flex items-center gap-3 pr-3 group cursor-pointer"
         data-id="${id}" draggable="true" ondragstart="handleDragStart(event,'${id}')" onclick="previewSample('${id}')">
      <div class="relative w-28 h-14 flex-shrink-0 bg-bg rounded-l-lg overflow-hidden">
        <canvas class="var-waveform w-full h-full" data-id="${id}"></canvas>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="w-7 h-7 bg-brand/90 rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-[16px] fill-1 text-txt">${state.currentSample === id && state.isPlaying ? 'pause' : 'play_arrow'}</span>
          </div>
        </div>
        <span class="absolute top-1 left-1 px-1 py-0.5 rounded text-[8px] font-bold uppercase ${typeBadge}">${s.type}</span>
      </div>
      <div class="flex-1 min-w-0 py-2">
        <p class="text-xs font-bold truncate">${s.name}</p>
        <p class="text-[10px] text-txt-dim truncate">${meta}</p>
      </div>
      <span class="text-[10px] font-mono text-txt-dim flex-shrink-0">${formatTime(s.duration)}</span>
      ${s.status === 'accepted' ? `
      <span class="text-[10px] text-emerald-400 font-bold flex-shrink-0 w-16 text-center">Accepted</span>` : s.status === 'rejected' ? `
      <span class="text-[10px] text-red-400 font-bold flex-shrink-0 w-16 text-center">Rejected</span>` : `
      <div class="flex items-center gap-1 flex-shrink-0">
        <button class="flex items-center gap-0.5 px-2 py-1 bg-emerald-500/15 text-emerald-400 rounded-md text-[10px] font-bold hover:bg-emerald-500/25 transition-colors" onclick="event.stopPropagation(); acceptVariation('${id}')">
          <span class="material-symbols-outlined text-[12px]">check</span> Accept
        </button>
        <button class="flex items-center gap-0.5 px-2 py-1 bg-red-500/10 text-red-400 rounded-md text-[10px] font-bold hover:bg-red-500/20 transition-colors" onclick="event.stopPropagation(); rejectVariation('${id}')">
          <span class="material-symbols-outlined text-[12px]">close</span> Reject
        </button>
      </div>`}
      <button class="p-1.5 text-txt-muted hover:text-brand rounded-md flex-shrink-0 transition-colors" onclick="event.stopPropagation(); toggleSampleFavorite('${id}')">
        <span class="material-symbols-outlined text-[16px] ${favClass}">favorite</span>
      </button>
      ${s.status === 'accepted' ? '<span class="material-symbols-outlined text-[14px] text-emerald-500 flex-shrink-0">check_circle</span>' : ''}
    </div>`;
}

// ==================== ACCEPT / REJECT ====================
function acceptVariation(id) {
  const s = samples[id];
  if (!s || s.status !== 'pending') return;
  s.status = 'accepted';
  s.acceptedAt = Date.now();
  s.isInLibrary = true;
  const session = sessions[s.generationSessionId];
  if (session) session.acceptedCount++;
  decisions.push({ sampleId: id, action: 'accept', timestamp: Date.now() });
  saveData();
  renderVariations();
  showToast('Sample accepted & added to library!');
}

function rejectVariation(id) {
  state.rejectingSampleId = id;
  document.getElementById('reject-modal').classList.add('open');
}

function submitReject(feedback) {
  const id = state.rejectingSampleId;
  if (!id) return;
  const s = samples[id];
  if (s) {
    s.status = 'rejected';
    s.rejectionFeedback = feedback;
    const session = sessions[s.generationSessionId];
    if (session) session.rejectedCount++;
    decisions.push({ sampleId: id, action: 'reject', feedback, timestamp: Date.now() });
  }
  closeModal();
  saveData();
  renderVariations();
  showToast('Sample rejected' + (feedback !== 'skip' ? '  feedback recorded' : ''));
}

function acceptAllPending() {
  let count = 0;
  Object.keys(samples).forEach(id => {
    const s = samples[id];
    if (s && s.status === 'pending' && s.projectId === currentProjectId) {
      s.status = 'accepted'; s.acceptedAt = Date.now(); s.isInLibrary = true;
      const session = sessions[s.generationSessionId];
      if (session) session.acceptedCount++;
      decisions.push({ sampleId: id, action: 'accept', timestamp: Date.now() });
      count++;
    }
  });
  if (count) { saveData(); renderVariations(); showToast(`${count} samples accepted!`); }
  else showToast('No pending samples to accept');
}

// ==================== FAVORITES ====================
function toggleSampleFavorite(id) {
  const s = samples[id];
  if (!s) return;
  s.isFavorite = !s.isFavorite;
  s.favoritedAt = s.isFavorite ? Date.now() : null;
  saveData();
  showToast(s.isFavorite ? 'Added to favorites' : 'Removed from favorites');
  if (state.currentPage === 'favorites') renderFavorites();
  if (state.currentPage === 'generate') renderVariations();
  if (state.currentPage === 'library') renderLibrary();
  if (state.currentPage === 'dashboard') renderDashboard();
  updateInspectorFav();
  updatePlayerFav();
}

function updateInspectorFav() {
  const s = samples[state.inspectedSample];
  if (s) {
    const icon = document.getElementById('inspector-fav-icon');
    icon.classList.toggle('fill-1', s.isFavorite);
    icon.classList.toggle('text-brand', s.isFavorite);
  }
}

function updatePlayerFav() {
  const s = samples[state.currentSample];
  if (s) {
    const btn = document.getElementById('player-fav-btn');
    const icon = btn.querySelector('.material-symbols-outlined');
    icon.classList.toggle('fill-1', s.isFavorite);
    btn.classList.toggle('text-brand', s.isFavorite);
    btn.classList.toggle('text-txt-muted', !s.isFavorite);
  }
}

function togglePlayerFav() {
  if (state.currentSample) toggleSampleFavorite(state.currentSample);
}

// ==================== PLAYBACK ====================
function previewSample(id) {
  const s = samples[id];
  if (!s) return;

  if (state.currentSample === id) { togglePlayPause(); return; }

  state.currentSample = id;
  state.currentTime = 0;
  state.totalTime = s.duration;
  state.isPlaying = true;

  document.getElementById('player-bar').style.display = 'block';
  document.getElementById('player-title').textContent = s.name;
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack}`;
  document.getElementById('player-meta').textContent = meta;
  document.getElementById('player-total-time').textContent = formatTime(s.duration);
  document.getElementById('player-current-time').textContent = '0:00';
  updatePlayButton();
  updatePlayerFav();

  // Real audio playback
  playAudioBuffer(id, 0).then(() => {
    startProgress();
    drawMiniWaveform(document.getElementById('player-mini-waveform'), s.waveformData, '#E85002');
    drawPlayerWaveform();
  });

  // Open inspector
  openInspector(id);

  // Update variation card highlights
  document.querySelectorAll('.variation-card').forEach(card => {
    card.classList.toggle('playing', card.dataset.id === id);
  });
}

function playSampleFromInspector() {
  if (state.inspectedSample) previewSample(state.inspectedSample);
}

function togglePlayPause() {
  if (!state.currentSample) return;
  state.isPlaying = !state.isPlaying;
  updatePlayButton();
  if (state.isPlaying) {
    playAudioBuffer(state.currentSample, state.currentTime);
    startProgress();
  } else {
    state.currentTime = getPlaybackTime();
    stopCurrentSource();
    stopProgress();
  }
}

function updatePlayButton() {
  document.querySelector('#btn-play .material-symbols-outlined').textContent = state.isPlaying ? 'pause' : 'play_arrow';
  const inspIcon = document.getElementById('inspector-play-icon');
  if (inspIcon) inspIcon.textContent = state.isPlaying ? 'pause' : 'play_arrow';
}

function startProgress() {
  stopProgress();
  state.progressInterval = setInterval(() => {
    if (!state.isPlaying) return;
    const t = getPlaybackTime();
    state.currentTime = t;
    if (t < state.totalTime || state.loopPlayback) {
      const displayTime = state.loopPlayback ? t % state.totalTime : t;
      const pct = displayTime / state.totalTime;
      document.getElementById('player-current-time').textContent = formatTime(displayTime);
      drawPlayerWaveform(pct);
    } else {
      state.isPlaying = false;
      updatePlayButton();
      stopProgress();
      document.getElementById('player-current-time').textContent = formatTime(state.totalTime);
      drawPlayerWaveform(1);
    }
  }, 50);
}

function stopProgress() { if (state.progressInterval) { clearInterval(state.progressInterval); state.progressInterval = null; } }

function drawPlayerWaveform(progress) {
  const s = samples[state.currentSample];
  if (!s) return;
  drawWaveform(document.getElementById('player-waveform'), s.waveformData, '#E85002', progress || 0);
}

function seekSample(e) {
  if (!state.currentSample) return;
  const r = e.currentTarget.getBoundingClientRect();
  const p = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
  state.currentTime = p * state.totalTime;
  document.getElementById('player-current-time').textContent = formatTime(state.currentTime);
  drawPlayerWaveform(p);
  if (state.isPlaying) {
    playAudioBuffer(state.currentSample, state.currentTime);
  }
}

function toggleLoopPlayback() {
  state.loopPlayback = !state.loopPlayback;
  if (currentSource) currentSource.loop = state.loopPlayback;
  document.getElementById('btn-loop').classList.toggle('text-brand', state.loopPlayback);
  document.getElementById('btn-loop').classList.toggle('text-txt-muted', !state.loopPlayback);
  const inspBtn = document.getElementById('inspector-loop-btn');
  if (inspBtn) {
    inspBtn.classList.toggle('text-brand', state.loopPlayback);
    inspBtn.classList.toggle('text-txt-muted', !state.loopPlayback);
  }
  showToast(state.loopPlayback ? 'Loop on' : 'Loop off');
}

function setVolume(v) { state.volume = parseInt(v); state.isMuted = false; if (masterGain) masterGain.gain.value = state.volume / 100; updateVolumeIcon(); }
function toggleMute() { state.isMuted = !state.isMuted; document.getElementById('volume-slider').value = state.isMuted ? 0 : state.volume; if (masterGain) masterGain.gain.value = state.isMuted ? 0 : state.volume / 100; updateVolumeIcon(); }
function updateVolumeIcon() { const i = document.getElementById('volume-icon'); const v = state.isMuted ? 0 : state.volume; i.textContent = v === 0 ? 'volume_off' : v < 40 ? 'volume_down' : 'volume_up'; }

// ==================== INSPECTOR ====================
function openInspector(id) {
  const s = samples[id];
  if (!s) return;
  state.inspectedSample = id;
  document.getElementById('inspector-panel').style.display = 'flex';
  document.getElementById('inspector-title').textContent = s.name;
  const badge = document.getElementById('inspector-type-badge');
  badge.textContent = s.type === 'loop' ? 'Loop' : 'One-Shot';
  badge.className = 'px-2 py-0.5 rounded text-[10px] font-bold uppercase ' + (s.type === 'loop' ? 'badge-loop' : 'badge-oneshot');
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars / ${formatTime(s.duration)}` : `${s.tuning} / ${s.attack} / ${s.timbre} / ${formatTime(s.duration)}`;
  document.getElementById('inspector-meta').textContent = meta;

  // Draw waveform
  requestAnimationFrame(() => {
    drawWaveform(document.getElementById('inspector-waveform'), s.waveformData, '#E85002');
  });

  // Effects sliders
  document.querySelectorAll('#inspector-panel .effect-slider').forEach(slider => {
    const fx = slider.dataset.fx;
    if (fx && s.effects[fx] !== undefined) {
      slider.value = s.effects[fx];
      slider.nextElementSibling.textContent = s.effects[fx] + '%';
    }
  });

  // Tags
  const tagsEl = document.getElementById('inspector-tags');
  tagsEl.innerHTML = s.tags.map(t => `<span class="px-2 py-1 bg-surface border border-border rounded text-[10px] text-txt-muted">${t}</span>`).join('') +
    `<button class="px-2 py-1 bg-bg border border-border rounded text-[10px] text-brand hover:bg-surface transition-colors" onclick="addTagPrompt()">+ Add</button>`;

  // Notes
  document.getElementById('inspector-notes').value = s.notes || '';

  // Favorite icon
  updateInspectorFav();
}

function closeInspector() {
  document.getElementById('inspector-panel').style.display = 'none';
  state.inspectedSample = null;
  // Tear down effects chain and reconnect source direct to master
  if (fxChainConnected && currentSource) {
    try { currentSource.disconnect(); } catch(e) {}
    teardownFxChain();
    try { currentSource.connect(masterGain); } catch(e) {}
  } else {
    teardownFxChain();
  }
}

// Effects chain nodes (live preview)
let fxDistortion = null;
let fxReverb = null;
let fxDelay = null;
let fxDelayGain = null;
let fxFilter = null;
let fxBitcrush = null;
let fxSaturation = null;
let fxChainConnected = false;

function teardownFxChain() {
  if (!fxChainConnected) return;
  try {
    [fxDistortion, fxSaturation, fxBitcrush, fxFilter, fxDelay, fxDelayGain].forEach(n => { if (n) n.disconnect(); });
    if (fxReverb) { fxReverb.disconnect(); if (fxReverb._wetGain) fxReverb._wetGain.disconnect(); if (fxReverb._dryGain) fxReverb._dryGain.disconnect(); }
  } catch(e) {}
  fxDistortion = fxSaturation = fxBitcrush = fxFilter = fxDelay = fxDelayGain = fxReverb = null;
  fxChainConnected = false;
}

function buildFxChain() {
  if (fxChainConnected) return;
  ensureAudioContext();
  const ctx = audioCtx;

  // Distortion (waveshaper)
  fxDistortion = ctx.createWaveShaper();
  fxDistortion.oversample = '4x';
  setDistortionCurve(0);

  // Saturation (softer waveshaper)
  fxSaturation = ctx.createWaveShaper();
  fxSaturation.oversample = '2x';
  setSaturationCurve(0);

  // Bitcrush (via sample rate reduction trick using a script processor)
  // We'll use a simple gain as placeholder  real bitcrush needs AudioWorklet
  fxBitcrush = ctx.createGain();
  fxBitcrush.gain.value = 1;

  // LP Filter
  fxFilter = ctx.createBiquadFilter();
  fxFilter.type = 'lowpass';
  fxFilter.frequency.value = 20000;
  fxFilter.Q.value = 0.7;

  // Delay
  fxDelay = ctx.createDelay(1.0);
  fxDelay.delayTime.value = 0;
  fxDelayGain = ctx.createGain();
  fxDelayGain.gain.value = 0;

  // Reverb (convolver with generated impulse response)
  fxReverb = ctx.createConvolver();
  fxReverb.buffer = generateImpulseResponseSync(2, 2);

  // Dry/wet for reverb
  fxReverb._wetGain = ctx.createGain();
  fxReverb._wetGain.gain.value = 0;
  fxReverb._dryGain = ctx.createGain();
  fxReverb._dryGain.gain.value = 1;

  // Reconnect: source  distortion  saturation  bitcrush  filter  (dry + delay)  (dry + reverb wet)  masterGain
  // We need to disconnect masterGain from currentSource first
  // Actually, we'll insert the chain between source and masterGain
  // Chain: [source connects to fxDistortion]  saturation  bitcrush  filter  dryGain  masterGain
  //                                                                             delay  delayGain  masterGain
  //                                                                             reverb  wetGain  masterGain
  fxDistortion.connect(fxSaturation);
  fxSaturation.connect(fxBitcrush);
  fxBitcrush.connect(fxFilter);
  fxFilter.connect(fxReverb._dryGain);
  fxReverb._dryGain.connect(masterGain);

  // Delay send
  fxFilter.connect(fxDelay);
  fxDelay.connect(fxDelayGain);
  fxDelayGain.connect(masterGain);
  // Delay feedback
  fxDelayGain.connect(fxDelay);

  // Reverb send
  fxFilter.connect(fxReverb);
  fxReverb.connect(fxReverb._wetGain);
  fxReverb._wetGain.connect(masterGain);

  fxChainConnected = true;
}

function generateImpulseResponseSync(duration, decay) {
  ensureAudioContext();
  const sr = audioCtx.sampleRate;
  const len = sr * duration;
  const buf = audioCtx.createBuffer(2, len, sr);
  for (let ch = 0; ch < 2; ch++) {
    const d = buf.getChannelData(ch);
    for (let i = 0; i < len; i++) {
      d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
    }
  }
  return buf;
}

function setDistortionCurve(amount) {
  if (!fxDistortion) return;
  const k = amount * 4;
  const samples = 44100;
  const curve = new Float32Array(samples);
  for (let i = 0; i < samples; i++) {
    const x = (i * 2) / samples - 1;
    curve[i] = k > 0 ? ((3 + k) * x * 20 * (Math.PI / 180)) / (Math.PI + k * Math.abs(x)) : x;
  }
  fxDistortion.curve = k > 0 ? curve : null;
}

function setSaturationCurve(amount) {
  if (!fxSaturation) return;
  if (amount <= 0) { fxSaturation.curve = null; return; }
  const samples = 44100;
  const curve = new Float32Array(samples);
  const k = amount * 2;
  for (let i = 0; i < samples; i++) {
    const x = (i * 2) / samples - 1;
    curve[i] = Math.tanh(x * (1 + k));
  }
  fxSaturation.curve = curve;
}

function getEffectValues() {
  const vals = {};
  document.querySelectorAll('#inspector-panel .effect-slider').forEach(slider => {
    vals[slider.dataset.fx] = parseInt(slider.value);
  });
  return vals;
}

function updateEffect(slider) {
  const val = slider.value;
  slider.nextElementSibling.textContent = val + '%';

  // Live preview: update effects chain in real-time
  if (!fxChainConnected || !state.isPlaying) return;
  const fx = slider.dataset.fx;
  const v = parseInt(val);
  applyFxValue(fx, v);
}

function applyFxValue(fx, v) {
  switch (fx) {
    case 'distortion': setDistortionCurve(v / 100); break;
    case 'saturation': setSaturationCurve(v / 100); break;
    case 'reverb':
      if (fxReverb._wetGain) fxReverb._wetGain.gain.value = v / 100;
      if (fxReverb._dryGain) fxReverb._dryGain.gain.value = 1 - (v / 200);
      break;
    case 'delay':
      if (fxDelay) fxDelay.delayTime.value = v > 0 ? 0.15 + (v / 100) * 0.35 : 0;
      if (fxDelayGain) fxDelayGain.gain.value = v > 0 ? Math.min(0.55, 0.15 + (v / 100) * 0.4) : 0;
      break;
    case 'filterLP':
      if (fxFilter) fxFilter.frequency.value = 200 + (v / 100) * 19800;
      break;
    case 'bitcrush':
      // Reduce gain slightly to simulate bitcrush harshness
      if (fxBitcrush) fxBitcrush.gain.value = v > 0 ? 1 + (v / 100) * 0.3 : 1;
      break;
  }
}

function connectSourceToFxChain(source) {
  buildFxChain();
  source.disconnect();
  source.connect(fxDistortion);
  // Apply current slider values
  const vals = getEffectValues();
  Object.entries(vals).forEach(([fx, v]) => applyFxValue(fx, v));
}

function resetEffects() {
  document.querySelectorAll('#inspector-panel .effect-slider').forEach(slider => {
    const fx = slider.dataset.fx;
    const def = fx === 'filterLP' ? 100 : 0;
    slider.value = def;
    slider.nextElementSibling.textContent = def + '%';
    if (fxChainConnected) applyFxValue(fx, def);
  });
  showToast('Effects reset');
}

function applyEffects() {
  const s = samples[state.inspectedSample];
  if (!s) return;
  const vals = getEffectValues();
  // Save effect values
  Object.entries(vals).forEach(([fx, v]) => { if (fx) s.effects[fx] = v; });

  // Offline render with effects
  ensureAudioContext();
  getAudioBuffer(state.inspectedSample).then(srcBuf => {
    if (!srcBuf) { saveData(); showToast('Effects saved!'); return; }
    const hasEffects = vals.distortion > 0 || vals.reverb > 0 || vals.delay > 0 || vals.filterLP < 100 || vals.bitcrush > 0 || vals.saturation > 0;
    if (!hasEffects) { saveData(); showToast('Effects saved!'); return; }

    const offCtx = new OfflineAudioContext(srcBuf.numberOfChannels, srcBuf.length + audioCtx.sampleRate, srcBuf.sampleRate);
    const src = offCtx.createBufferSource();
    src.buffer = srcBuf;

    // Build offline effects chain
    const dist = offCtx.createWaveShaper();
    dist.oversample = '4x';
    const k = (vals.distortion / 100) * 4;
    if (k > 0) {
      const curve = new Float32Array(44100);
      for (let i = 0; i < 44100; i++) {
        const x = (i * 2) / 44100 - 1;
        curve[i] = ((3 + k) * x * 20 * (Math.PI / 180)) / (Math.PI + k * Math.abs(x));
      }
      dist.curve = curve;
    }

    const sat = offCtx.createWaveShaper();
    if (vals.saturation > 0) {
      const sCurve = new Float32Array(44100);
      const sk = (vals.saturation / 100) * 2;
      for (let i = 0; i < 44100; i++) {
        const x = (i * 2) / 44100 - 1;
        sCurve[i] = Math.tanh(x * (1 + sk));
      }
      sat.curve = sCurve;
    }

    const filt = offCtx.createBiquadFilter();
    filt.type = 'lowpass';
    filt.frequency.value = 200 + (vals.filterLP / 100) * 19800;
    filt.Q.value = 0.7;

    const del = offCtx.createDelay(1.0);
    del.delayTime.value = vals.delay > 0 ? 0.15 + (vals.delay / 100) * 0.35 : 0;
    const delGain = offCtx.createGain();
    delGain.gain.value = vals.delay > 0 ? 0.2 + (vals.delay / 100) * 0.4 : 0;

    src.connect(dist);
    dist.connect(sat);
    sat.connect(filt);
    filt.connect(offCtx.destination);

    if (vals.delay > 0) {
      filt.connect(del);
      del.connect(delGain);
      delGain.connect(offCtx.destination);
      delGain.connect(del);
    }

    src.start(0);
    offCtx.startRendering().then(renderedBuf => {
      // Trim to original length
      const trimmed = audioCtx.createBuffer(renderedBuf.numberOfChannels, srcBuf.length, srcBuf.sampleRate);
      for (let ch = 0; ch < renderedBuf.numberOfChannels; ch++) {
        trimmed.copyToChannel(renderedBuf.getChannelData(ch).slice(0, srcBuf.length), ch);
      }
      cacheAndPersistBuffer(state.inspectedSample, trimmed);
      saveData();
      showToast('Effects applied & saved!');
    });
  });
}

function updateSampleNotes() {
  const s = samples[state.inspectedSample];
  if (s) { s.notes = document.getElementById('inspector-notes').value; saveData(); }
}

function addTagPrompt() {
  const tag = prompt('Add a tag:');
  if (tag && tag.trim()) {
    const s = samples[state.inspectedSample];
    if (s) { s.tags.push(tag.trim()); saveData(); openInspector(state.inspectedSample); }
  }
}

function batchFromSample() {
  if (!state.inspectedSample) return;
  const s = samples[state.inspectedSample];
  if (!s) return;
  // Pre-fill params from this sample
  if (s.type === 'loop') {
    setGenerateMode('loop');
    document.getElementById('bpm-input').value = s.bpm || 120;
    document.getElementById('bpm-slider').value = s.bpm || 120;
    document.getElementById('key-select').value = s.key || 'C';
  } else {
    setGenerateMode('oneshot');
    document.getElementById('tuning-select').value = s.tuning || 'C4';
  }
  showToast('Generating more variations from this sample...');
  generateSamples();
}

// ==================== LIBRARY ====================
function getLibrarySamples() {
  let list = Object.values(samples).filter(s => s.isInLibrary && s.status === 'accepted' && s.projectId === currentProjectId);
  const search = (document.getElementById('lib-search')?.value || '').toLowerCase();
  const type = state.libraryType;
  const key = document.getElementById('lib-key-filter')?.value;
  const sort = document.getElementById('lib-sort')?.value;

  if (search) list = list.filter(s => s.name.toLowerCase().includes(search) || s.tags.some(t => t.toLowerCase().includes(search)) || (s.key || '').toLowerCase().includes(search));
  if (type !== 'all') list = list.filter(s => s.type === type);
  if (key && key !== 'all') list = list.filter(s => s.key === key);

  if (sort === 'recent') list.sort((a, b) => b.createdAt - a.createdAt);
  else if (sort === 'oldest') list.sort((a, b) => a.createdAt - b.createdAt);
  else if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));
  else if (sort === 'bpm') list.sort((a, b) => (a.bpm || 0) - (b.bpm || 0));
  return list;
}

function renderLibrary() {
  const list = getLibrarySamples();
  const gridEl = document.getElementById('lib-grid');
  const listEl = document.getElementById('lib-list');
  const emptyEl = document.getElementById('lib-empty');

  if (!list.length) {
    gridEl.classList.add('hidden'); listEl.classList.add('hidden'); emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');

  if (state.libraryView === 'grid') {
    gridEl.classList.remove('hidden'); listEl.classList.add('hidden');
    gridEl.innerHTML = list.map(s => renderSampleCard(s)).join('');
    requestAnimationFrame(() => {
      gridEl.querySelectorAll('.lib-waveform').forEach(canvas => {
        const s = samples[canvas.dataset.id];
        if (s) drawWaveform(canvas, s.waveformData, '#E85002');
      });
    });
  } else {
    gridEl.classList.add('hidden'); listEl.classList.remove('hidden');
    document.getElementById('lib-tbody').innerHTML = list.map(s => `
      <tr class="group hover:bg-surface/40 transition-colors cursor-pointer" onclick="previewSample('${s.id}')">
        <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="checkbox" class="rounded border-border" ${state.selectedSamples.has(s.id) ? 'checked' : ''} onchange="toggleSampleSelect('${s.id}')"/></td>
        <td class="px-4 py-3"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded bg-bg overflow-hidden"><canvas class="lib-waveform-row w-full h-full" data-id="${s.id}" width="40" height="40"></canvas></div><span class="font-bold text-sm">${s.name}</span></div></td>
        <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${s.type === 'loop' ? 'badge-loop' : 'badge-oneshot'}">${s.type}</span></td>
        <td class="px-4 py-3 text-sm text-txt-muted">${s.key || '-'}</td>
        <td class="px-4 py-3 text-sm text-txt-muted">${s.bpm || '-'}</td>
        <td class="px-4 py-3 text-sm text-txt-muted font-mono">${formatTime(s.duration)}</td>
        <td class="px-4 py-3 text-right"><div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
          <button class="p-1.5 hover:bg-dk-gray rounded-lg text-txt-muted hover:text-brand" onclick="event.stopPropagation(); toggleSampleFavorite('${s.id}')"><span class="material-symbols-outlined text-[18px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span></button>
          <button class="p-1.5 hover:bg-dk-gray rounded-lg text-txt-muted" onclick="event.stopPropagation(); downloadSample('${s.id}')"><span class="material-symbols-outlined text-[18px]">download</span></button>
          <button class="p-1.5 hover:bg-dk-gray rounded-lg text-txt-muted" onclick="event.stopPropagation(); deleteSampleConfirm('${s.id}')"><span class="material-symbols-outlined text-[18px]">delete</span></button>
        </div></td>
      </tr>`).join('');
    requestAnimationFrame(() => {
      document.querySelectorAll('.lib-waveform-row').forEach(c => {
        const s = samples[c.dataset.id];
        if (s) drawMiniWaveform(c, s.waveformData, '#E85002');
      });
    });
  }
  updateBatchBar();
}

function renderSampleCard(s) {
  const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack}`;
  return `
    <div class="sample-card group bg-panel p-3 rounded-2xl border border-border cursor-pointer ${state.selectedSamples.has(s.id) ? 'selected' : ''}"
         data-id="${s.id}" draggable="true" ondragstart="handleDragStart(event,'${s.id}')" onclick="previewSample('${s.id}')">
      <div class="relative rounded-xl overflow-hidden mb-3 bg-bg h-24">
        <canvas class="lib-waveform w-full h-full" data-id="${s.id}"></canvas>
        <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity">
          <div class="w-10 h-10 bg-brand text-txt rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-[24px] fill-1">play_arrow</span>
          </div>
        </div>
        <span class="absolute bottom-2 right-2 px-1.5 py-0.5 bg-black/75 text-[10px] font-mono text-txt rounded">${formatTime(s.duration)}</span>
        <span class="absolute top-2 left-2 px-2 py-0.5 bg-black/70 text-[10px] font-bold rounded uppercase ${s.type === 'loop' ? 'text-brand' : 'text-blue-400'}">${s.type}</span>
      </div>
      <div class="flex items-center justify-between">
        <div class="min-w-0 flex-1">
          <h4 class="font-bold text-sm truncate">${s.name}</h4>
          <p class="text-[10px] text-txt-muted">${meta}</p>
        </div>
        <button class="p-1.5 text-txt-muted hover:text-brand flex-shrink-0" onclick="event.stopPropagation(); toggleSampleFavorite('${s.id}')">
          <span class="material-symbols-outlined text-[18px] ${s.isFavorite ? 'fill-1 text-brand' : ''}">favorite</span>
        </button>
      </div>
    </div>`;
}

function setLibType(type, btn) {
  state.libraryType = type;
  btn.closest('.flex').querySelectorAll('.param-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderLibrary();
}

function setLibView(view) {
  state.libraryView = view;
  document.getElementById('lib-grid-btn').classList.toggle('text-brand', view === 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('text-txt-muted', view !== 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('bg-surface', view === 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('border', view === 'grid');
  document.getElementById('lib-grid-btn').classList.toggle('border-border', view === 'grid');
  document.getElementById('lib-list-btn').classList.toggle('text-brand', view === 'list');
  document.getElementById('lib-list-btn').classList.toggle('text-txt-muted', view !== 'list');
  document.getElementById('lib-list-btn').classList.toggle('bg-surface', view === 'list');
  document.getElementById('lib-list-btn').classList.toggle('border', view === 'list');
  document.getElementById('lib-list-btn').classList.toggle('border-border', view === 'list');
  renderLibrary();
}

function toggleSampleSelect(id) {
  if (state.selectedSamples.has(id)) state.selectedSamples.delete(id);
  else state.selectedSamples.add(id);
  updateBatchBar();
  renderLibrary();
}

function toggleSelectAll(checkbox) {
  const list = getLibrarySamples();
  if (checkbox.checked) list.forEach(s => state.selectedSamples.add(s.id));
  else state.selectedSamples.clear();
  updateBatchBar();
  renderLibrary();
}

function updateBatchBar() {
  const bar = document.getElementById('lib-batch-bar');
  if (state.selectedSamples.size > 0) {
    bar.classList.remove('hidden');
    document.getElementById('batch-count').textContent = state.selectedSamples.size;
    bar.style.bottom = state.currentSample ? '64px' : '0px';
  } else {
    bar.classList.add('hidden');
  }
}

function audioBufferToWav(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const format = 1; // PCM
  const bitDepth = 16;
  const bytesPerSample = bitDepth / 8;
  const blockAlign = numChannels * bytesPerSample;
  const dataLength = buffer.length * blockAlign;
  const headerLength = 44;
  const totalLength = headerLength + dataLength;
  const arrayBuffer = new ArrayBuffer(totalLength);
  const view = new DataView(arrayBuffer);

  function writeString(offset, str) {
    for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
  }

  writeString(0, 'RIFF');
  view.setUint32(4, totalLength - 8, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, format, true);
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * blockAlign, true);
  view.setUint16(32, blockAlign, true);
  view.setUint16(34, bitDepth, true);
  writeString(36, 'data');
  view.setUint32(40, dataLength, true);

  const channels = [];
  for (let ch = 0; ch < numChannels; ch++) channels.push(buffer.getChannelData(ch));

  let offset = 44;
  for (let i = 0; i < buffer.length; i++) {
    for (let ch = 0; ch < numChannels; ch++) {
      const sample = Math.max(-1, Math.min(1, channels[ch][i]));
      view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
      offset += 2;
    }
  }
  return arrayBuffer;
}

function sanitizeFilename(name) {
  return name.replace(/[^a-zA-Z0-9_\-\s]/g, '').replace(/\s+/g, '_');
}

function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function downloadSample(id) {
  const s = samples[id];
  if (!s) return;
  ensureAudioContext();
  showToast('Preparing download...');
  getAudioBuffer(id).then(buf => {
    if (!buf) { showToast('No audio to download'); return; }
    const wav = audioBufferToWav(buf);
    const blob = new Blob([wav], { type: 'audio/wav' });
    triggerDownload(blob, sanitizeFilename(s.name) + '.wav');
    showToast('Downloaded ' + s.name + '.wav');
  });
}

function downloadSelectedAsZip() {
  if (state.selectedSamples.size === 0) return;
  ensureAudioContext();
  showToast(`Preparing ZIP with ${state.selectedSamples.size} samples...`);
  const zip = new JSZip();
  const promises = [];
  state.selectedSamples.forEach(id => {
    const s = samples[id];
    if (!s) return;
    promises.push(
      getAudioBuffer(id).then(buf => {
        if (!buf) return;
        const wav = audioBufferToWav(buf);
        zip.file(sanitizeFilename(s.name) + '.wav', wav);
      })
    );
  });
  Promise.all(promises).then(() => {
    return zip.generateAsync({ type: 'blob' });
  }).then(blob => {
    const projName = projects[currentProjectId]?.name || 'FIIRE';
    triggerDownload(blob, sanitizeFilename(projName) + '_samples.zip');
    showToast('ZIP downloaded!');
  });
}

function favoriteSelected() {
  state.selectedSamples.forEach(id => {
    const s = samples[id]; if (s && !s.isFavorite) { s.isFavorite = true; s.favoritedAt = Date.now(); }
  });
  saveData(); renderLibrary(); showToast(`${state.selectedSamples.size} samples favorited`);
}

function deleteSampleConfirm(id) {
  const s = samples[id]; if (!s) return;
  document.getElementById('confirm-title').textContent = 'Delete Sample';
  document.getElementById('confirm-msg').textContent = `Are you sure you want to delete "${s.name}"?`;
  document.getElementById('confirm-action').onclick = () => { deleteSample(id); closeModal(); };
  document.getElementById('confirm-modal').classList.add('open');
}

function deleteSample(id) {
  delete samples[id];
  delete audioBuffers[id];
  deleteAudioBlob(id);
  state.selectedSamples.delete(id);
  saveData();
  if (state.currentSample === id) { state.currentSample = null; stopCurrentSource(); document.getElementById('player-bar').style.display = 'none'; }
  if (state.inspectedSample === id) closeInspector();
  renderLibrary();
  showToast('Sample deleted');
}

function deleteSelected() {
  if (state.selectedSamples.size === 0) return;
  document.getElementById('confirm-title').textContent = 'Delete Samples';
  document.getElementById('confirm-msg').textContent = `Delete ${state.selectedSamples.size} selected samples?`;
  document.getElementById('confirm-action').onclick = () => {
    state.selectedSamples.forEach(id => { delete samples[id]; delete audioBuffers[id]; deleteAudioBlob(id); });
    state.selectedSamples.clear();
    saveData(); closeModal(); renderLibrary(); showToast('Samples deleted');
  };
  document.getElementById('confirm-modal').classList.add('open');
}

// ==================== FAVORITES PAGE ====================
function renderFavorites() {
  let list = Object.values(samples).filter(s => s.isFavorite && s.projectId === currentProjectId);
  const search = (document.getElementById('fav-search')?.value || '').toLowerCase();
  const sort = document.getElementById('fav-sort')?.value || 'fav-recent';

  if (search) list = list.filter(s => s.name.toLowerCase().includes(search) || s.tags.some(t => t.toLowerCase().includes(search)));

  if (sort === 'fav-recent') list.sort((a, b) => (b.favoritedAt || 0) - (a.favoritedAt || 0));
  else if (sort === 'recent') list.sort((a, b) => b.createdAt - a.createdAt);
  else if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));
  else if (sort === 'bpm') list.sort((a, b) => (a.bpm || 0) - (b.bpm || 0));

  document.getElementById('fav-count').textContent = list.length;

  if (!list.length) {
    document.getElementById('fav-grid').classList.add('hidden');
    document.getElementById('fav-empty').classList.remove('hidden');
    return;
  }
  document.getElementById('fav-empty').classList.add('hidden');
  document.getElementById('fav-grid').classList.remove('hidden');
  document.getElementById('fav-grid').innerHTML = list.map(s => renderSampleCard(s)).join('');
  requestAnimationFrame(() => {
    document.getElementById('fav-grid').querySelectorAll('.lib-waveform').forEach(canvas => {
      const s = samples[canvas.dataset.id];
      if (s) drawWaveform(canvas, s.waveformData, '#E85002');
    });
  });
}

// ==================== HISTORY PAGE ====================
function renderHistory() {
  const search = (document.getElementById('hist-search')?.value || '').toLowerCase();
  const typeFilter = document.getElementById('hist-type-filter')?.value || 'all';
  let list = Object.values(sessions).filter(s => s.projectId === currentProjectId);

  if (search) list = list.filter(s => JSON.stringify(s.params).toLowerCase().includes(search));
  if (typeFilter !== 'all') list = list.filter(s => s.type === typeFilter);
  list.sort((a, b) => b.createdAt - a.createdAt);

  if (!list.length) {
    document.getElementById('hist-timeline').classList.add('hidden');
    document.getElementById('hist-empty').classList.remove('hidden');
    return;
  }
  document.getElementById('hist-empty').classList.add('hidden');
  document.getElementById('hist-timeline').classList.remove('hidden');

  // Group by date
  const groups = {};
  list.forEach(s => {
    const d = new Date(s.createdAt);
    const today = new Date();
    let label;
    if (d.toDateString() === today.toDateString()) label = 'Today';
    else {
      const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
      if (d.toDateString() === yesterday.toDateString()) label = 'Yesterday';
      else label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    if (!groups[label]) groups[label] = [];
    groups[label].push(s);
  });

  document.getElementById('hist-timeline').innerHTML = Object.entries(groups).map(([label, items]) => `
    <div class="mb-6">
      <h4 class="text-xs font-bold text-txt-dim uppercase tracking-wider mb-3">${label}</h4>
      <div class="space-y-3">
        ${items.map(s => {
          const p = s.params;
          const paramStr = s.type === 'loop'
            ? `${p.bpm} BPM / ${p.key} / ${p.bars} bars${p.styles?.length ? ' / ' + p.styles.join(', ') : ''}`
            : `${p.tuning} / ${p.attack} / ${p.timbre}${p.styles?.length ? ' / ' + p.styles.join(', ') : ''}`;
          const time = new Date(s.createdAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
          return `
          <div class="history-item">
            <div class="history-dot ${s.type}"></div>
            <div class="bg-panel border border-border rounded-xl p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${s.type === 'loop' ? 'badge-loop' : 'badge-oneshot'}">${s.type}</span>
                  <span class="text-sm font-bold">${s.variationIds.length} variations</span>
                </div>
                <span class="text-xs text-txt-dim">${time}</span>
              </div>
              <p class="text-xs text-txt-muted mb-3">${paramStr}</p>
              <div class="flex items-center gap-4 text-xs">
                <span class="text-emerald-400">Accepted: ${s.acceptedCount}</span>
                <span class="text-red-400">Rejected: ${s.rejectedCount}</span>
                <span class="text-txt-dim">Pending: ${s.variationIds.length - s.acceptedCount - s.rejectedCount}</span>
              </div>
              <div class="flex gap-2 mt-3">
                <button class="text-xs text-brand hover:underline" onclick="viewSessionVariations('${s.id}')">View Variations</button>
                <button class="text-xs text-txt-muted hover:text-txt" onclick="regenerateSession('${s.id}')">Re-generate</button>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`).join('');
}

function viewSessionVariations(sessionId) {
  const session = sessions[sessionId];
  if (!session) return;
  currentVariations = session.variationIds;
  navigateTo('generate');
  // Restore params
  const p = session.params;
  setGenerateMode(session.type);
  if (session.type === 'loop') {
    document.getElementById('bpm-input').value = p.bpm || 120;
    document.getElementById('bpm-slider').value = p.bpm || 120;
    document.getElementById('key-select').value = p.key || 'C';
  }
  document.getElementById('gen-empty').classList.add('hidden');
  document.getElementById('gen-footer').classList.remove('hidden');
  document.getElementById('gen-var-count').textContent = currentVariations.length + ' variations';
  renderVariations();
}

function regenerateSession(sessionId) {
  const session = sessions[sessionId];
  if (!session) return;
  navigateTo('generate');
  const p = session.params;
  setGenerateMode(session.type);
  if (session.type === 'loop') {
    document.getElementById('bpm-input').value = p.bpm || 120;
    document.getElementById('bpm-slider').value = p.bpm || 120;
    document.getElementById('key-select').value = p.key || 'C';
  }
  generateSamples();
}

// ==================== DASHBOARD ====================
function renderDashboard() {
  // Recent generations
  const search = (document.getElementById('dash-search')?.value || '').toLowerCase();
  let recent = Object.values(samples).filter(s => s.isInLibrary && s.projectId === currentProjectId);
  if (dashTypeFilter !== 'all') recent = recent.filter(s => s.type === dashTypeFilter);
  if (search) recent = recent.filter(s => s.name.toLowerCase().includes(search) || s.tags.some(t => t.toLowerCase().includes(search)) || (s.key || '').toLowerCase().includes(search));
  recent = recent.sort((a, b) => b.createdAt - a.createdAt).slice(0, 8);
  const grid = document.getElementById('dash-recent-grid');
  const empty = document.getElementById('dash-empty');

  if (recent.length) {
    grid.classList.remove('hidden'); empty.classList.add('hidden');
    grid.innerHTML = recent.map(s => renderSampleCard(s)).join('');
    requestAnimationFrame(() => {
      grid.querySelectorAll('.lib-waveform').forEach(canvas => {
        const s = samples[canvas.dataset.id];
        if (s) drawWaveform(canvas, s.waveformData, '#E85002');
      });
    });
  } else {
    grid.classList.add('hidden'); empty.classList.remove('hidden');
  }

  // Decision count for recommendations
  const count = decisions.length;
  document.getElementById('dash-decision-count').textContent = count;
  if (count >= 50) {
    document.getElementById('dash-recommendations').classList.remove('hidden');
    document.getElementById('dash-rec-locked').classList.add('hidden');
    renderRecommendations();
  } else {
    document.getElementById('dash-recommendations').classList.add('hidden');
    document.getElementById('dash-rec-locked').classList.remove('hidden');
  }

  // Recent presets
  const recentSessions = Object.values(sessions).filter(s => s.projectId === currentProjectId).sort((a, b) => b.createdAt - a.createdAt).slice(0, 3);
  const presetsEl = document.getElementById('dash-presets');
  presetsEl.innerHTML = recentSessions.map(s => {
    const p = s.params;
    const label = s.type === 'loop' ? `${p.bpm} BPM / ${p.key} / ${p.bars} bars` : `${p.tuning} / ${p.attack} / ${p.timbre}`;
    return `<button class="param-chip text-[11px]" onclick="regenerateSession('${s.id}')">${label}</button>`;
  }).join('');
}

function renderRecommendations() {
  // Simple recommendation based on most accepted params
  const accepted = decisions.filter(d => d.action === 'accept').map(d => samples[d.sampleId]).filter(s => s && s.projectId === currentProjectId);
  if (!accepted.length) return;

  const bpms = accepted.filter(s => s.bpm).map(s => s.bpm);
  const avgBpm = bpms.length ? Math.round(bpms.reduce((a, b) => a + b, 0) / bpms.length) : 120;
  const keys = accepted.filter(s => s.key).map(s => s.key);
  const topKey = keys.length ? (() => { const freq = {}; keys.forEach(v => freq[v] = (freq[v] || 0) + 1); return Object.entries(freq).sort((a, b) => b[1] - a[1])[0]?.[0]; })() : 'C';

  document.getElementById('dash-rec-list').innerHTML = `
    <div class="bg-panel border border-border rounded-xl p-4 flex items-center gap-4 cursor-pointer hover:border-brand transition-colors" onclick="navigateTo('generate')">
      <div class="w-10 h-10 bg-brand/15 rounded-lg flex items-center justify-center flex-shrink-0">
        <span class="material-symbols-outlined text-brand">auto_awesome</span>
      </div>
      <div>
        <p class="text-sm font-bold">Try ${avgBpm} BPM in ${topKey}</p>
        <p class="text-xs text-txt-muted">Based on your most accepted samples</p>
      </div>
    </div>`;
}

let dashTypeFilter = 'all';
function filterDashboard() { renderDashboard(); }
function setDashTypeFilter(type, btn) {
  dashTypeFilter = type;
  btn.closest('#dash-type-chips').querySelectorAll('.param-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderDashboard();
}

// ==================== DRAG & DROP ====================
function handleDragStart(event, id) {
  const s = samples[id];
  if (!s) return;
  event.dataTransfer.effectAllowed = 'copy';
  const filename = sanitizeFilename(s.name) + '.wav';
  event.dataTransfer.setData('text/plain', filename);

  // Build a real WAV blob for DAW drag-and-drop
  ensureAudioContext();
  const buf = audioBuffers[id];
  if (buf) {
    const wav = audioBufferToWav(buf);
    const blob = new Blob([wav], { type: 'audio/wav' });
    const url = URL.createObjectURL(blob);
    try {
      event.dataTransfer.setData('DownloadURL', `audio/wav:${filename}:${url}`);
    } catch(e) {}
    // Clean up object URL after drag completes
    const cleanup = () => { URL.revokeObjectURL(url); document.removeEventListener('dragend', cleanup); };
    document.addEventListener('dragend', cleanup);
  }
}

// ==================== IMPORT FROM PROJECT ====================
let importSelectedIds = new Set();

function openImportModal() {
  importSelectedIds.clear();
  const select = document.getElementById('import-project-select');
  select.innerHTML = '<option value="">Select a project...</option>';
  Object.values(projects).filter(p => p.id !== currentProjectId).forEach(p => {
    const count = Object.values(samples).filter(s => s.projectId === p.id && s.isInLibrary).length;
    select.innerHTML += `<option value="${p.id}">${p.name} (${count} samples)</option>`;
  });
  document.getElementById('import-sample-list').innerHTML = '<p class="text-sm text-txt-dim text-center py-8">Select a project to see its samples</p>';
  document.getElementById('import-selected-count').textContent = '0';
  document.getElementById('import-modal').classList.add('open');
}

function renderImportList() {
  const projectId = document.getElementById('import-project-select').value;
  const listEl = document.getElementById('import-sample-list');
  importSelectedIds.clear();
  document.getElementById('import-selected-count').textContent = '0';

  if (!projectId) {
    listEl.innerHTML = '<p class="text-sm text-txt-dim text-center py-8">Select a project to see its samples</p>';
    return;
  }

  const projectSamples = Object.values(samples).filter(s => s.projectId === projectId && s.isInLibrary);
  if (!projectSamples.length) {
    listEl.innerHTML = '<p class="text-sm text-txt-dim text-center py-8">No samples in this project</p>';
    return;
  }

  listEl.innerHTML = projectSamples.map(s => {
    const meta = s.type === 'loop' ? `${s.bpm} BPM / ${s.key} / ${s.bars} bars` : `${s.tuning} / ${s.attack}`;
    const typeBadge = s.type === 'loop' ? 'badge-loop' : 'badge-oneshot';
    return `
      <label class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-surface transition-colors cursor-pointer border border-transparent has-[:checked]:border-brand/30 has-[:checked]:bg-brand/5">
        <input type="checkbox" class="rounded border-border text-brand" value="${s.id}" onchange="toggleImportSelect(this)"/>
        <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${typeBadge}">${s.type}</span>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">${s.name}</p>
          <p class="text-[10px] text-txt-dim">${meta}</p>
        </div>
        <span class="text-[10px] font-mono text-txt-dim">${formatTime(s.duration)}</span>
      </label>`;
  }).join('');
}

function toggleImportSelect(checkbox) {
  if (checkbox.checked) importSelectedIds.add(checkbox.value);
  else importSelectedIds.delete(checkbox.value);
  document.getElementById('import-selected-count').textContent = importSelectedIds.size;
}

function importSelectedSamples() {
  if (!importSelectedIds.size) { showToast('No samples selected'); return; }
  let count = 0;
  importSelectedIds.forEach(originalId => {
    const original = samples[originalId];
    if (!original) return;
    const newId = uid('smp');
    samples[newId] = {
      ...JSON.parse(JSON.stringify(original)),
      id: newId,
      projectId: currentProjectId,
      createdAt: Date.now(),
      waveformData: [...original.waveformData],
    };
    count++;
  });
  importSelectedIds.clear();
  saveData();
  closeModal();
  renderLibrary();
  renderProjectSwitcher();
  showToast(`${count} sample${count !== 1 ? 's' : ''} imported!`);
}

// ==================== SETTINGS ====================
function openSettingsModal() {
  const input = document.getElementById('settings-api-key');
  input.value = ELEVENLABS_API_KEY;
  input.type = 'password';
  document.getElementById('api-key-eye').textContent = 'visibility_off';
  document.getElementById('api-status').innerHTML = ELEVENLABS_API_KEY
    ? '<span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span><span class="text-xs text-emerald-400 font-medium">Key saved</span>'
    : '<span class="w-2 h-2 rounded-full bg-txt-dim flex-shrink-0"></span><span class="text-xs text-txt-dim font-medium">No key set</span>';
  document.getElementById('settings-modal').classList.add('open');
}

function closeSettingsModal() {
  document.getElementById('settings-modal').classList.remove('open');
}

function toggleApiKeyVisibility() {
  const input = document.getElementById('settings-api-key');
  const eye = document.getElementById('api-key-eye');
  if (input.type === 'password') {
    input.type = 'text';
    eye.textContent = 'visibility';
  } else {
    input.type = 'password';
    eye.textContent = 'visibility_off';
  }
}

function saveApiKey() {
  const key = document.getElementById('settings-api-key').value.trim();
  ELEVENLABS_API_KEY = key;
  localStorage.setItem('fiire_api_key', key);
  document.getElementById('api-status').innerHTML = key
    ? '<span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span><span class="text-xs text-emerald-400 font-medium">Key saved</span>'
    : '<span class="w-2 h-2 rounded-full bg-txt-dim flex-shrink-0"></span><span class="text-xs text-txt-dim font-medium">Key removed</span>';
  showToast(key ? 'API key saved' : 'API key removed');
}

function testApiKey() {
  const key = document.getElementById('settings-api-key').value.trim();
  if (!key) {
    document.getElementById('api-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0"></span><span class="text-xs text-red-400 font-medium">Enter a key first</span>';
    return;
  }

  const btn = document.getElementById('api-test-btn');
  const label = document.getElementById('api-test-label');
  btn.disabled = true;
  label.textContent = 'Testing...';

  // Test with a minimal SFX generation request
  fetch('https://api.elevenlabs.io/v1/sound-generation?output_format=mp3_22050_32', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'xi-api-key': key },
    body: JSON.stringify({
      text: 'short click',
      duration_seconds: 0.5,
      prompt_influence: 0.3,
      model_id: 'eleven_text_to_sound_v2',
    }),
  }).then(res => {
    if (res.ok) {
      document.getElementById('api-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span><span class="text-xs text-emerald-400 font-medium">Connected!</span>';
      showToast('API key is valid!');
    } else {
      return res.text().then(t => {
        let msg = 'Invalid key';
        try { const j = JSON.parse(t); msg = j.detail?.message || j.detail || msg; } catch(e) {}
        document.getElementById('api-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0"></span><span class="text-xs text-red-400 font-medium">${msg}</span>`;
        showToast('API key test failed');
      });
    }
  }).catch(err => {
    document.getElementById('api-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0"></span><span class="text-xs text-red-400 font-medium">Network error</span>';
    showToast('Connection failed');
  }).finally(() => {
    btn.disabled = false;
    label.textContent = 'Test Connection';
  });
}

function clearAllDataConfirm() {
  closeSettingsModal();
  document.getElementById('confirm-title').textContent = 'Clear All Data';
  document.getElementById('confirm-msg').textContent = 'This will delete all samples, projects, and cached audio. This cannot be undone.';
  document.getElementById('confirm-action').onclick = () => {
    localStorage.removeItem('fiire_samples');
    localStorage.removeItem('fiire_sessions');
    localStorage.removeItem('fiire_decisions');
    localStorage.removeItem('fiire_counters');
    localStorage.removeItem('fiire_projects');
    localStorage.removeItem('fiire_current_project');
    // Clear IndexedDB
    try { indexedDB.deleteDatabase(AUDIO_DB_NAME); } catch(e) {}
    closeModal();
    showToast('All data cleared  reloading...');
    setTimeout(() => location.reload(), 1000);
  };
  document.getElementById('confirm-modal').classList.add('open');
}

// ==================== KEYBOARD SHORTCUTS ====================
function getNavigableSamples() {
  return Object.values(samples)
    .filter(s => s.projectId === currentProjectId)
    .sort((a, b) => b.createdAt - a.createdAt);
}

function navigateSample(direction) {
  const list = getNavigableSamples();
  if (!list.length) return;
  if (!state.currentSample) { previewSample(list[0].id); return; }
  const idx = list.findIndex(s => s.id === state.currentSample);
  const next = idx + direction;
  if (next >= 0 && next < list.length) previewSample(list[next].id);
}

let shortcutOverlayOpen = false;
function toggleShortcutOverlay() {
  shortcutOverlayOpen = !shortcutOverlayOpen;
  let overlay = document.getElementById('shortcut-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'shortcut-overlay';
    overlay.className = 'modal-overlay';
    overlay.onclick = (e) => { if (e.target === overlay) { overlay.classList.remove('open'); shortcutOverlayOpen = false; } };
    overlay.innerHTML = `
      <div class="bg-panel border border-border rounded-2xl p-6 w-full max-w-sm animate-fadeIn">
        <h3 class="text-lg font-bold mb-4">Keyboard Shortcuts</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-txt-muted">Play / Pause</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">Space</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Previous sample</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">&larr;</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Next sample</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">&rarr;</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Accept sample</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">A</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Reject sample</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">R</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Toggle favorite</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">F</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Download sample</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">D</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Toggle loop</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">L</kbd></div>
          <div class="flex justify-between"><span class="text-txt-muted">Show shortcuts</span><kbd class="px-2 py-0.5 bg-surface border border-border rounded text-xs font-mono">?</kbd></div>
        </div>
        <button class="mt-4 text-sm text-txt-dim hover:text-txt" onclick="this.closest('.modal-overlay').classList.remove('open'); shortcutOverlayOpen=false;">Close</button>
      </div>`;
    document.body.appendChild(overlay);
  }
  overlay.classList.toggle('open', shortcutOverlayOpen);
}

document.addEventListener('keydown', e => {
  if (e.code === 'Escape') { closeModal(); if (shortcutOverlayOpen) toggleShortcutOverlay(); return; }
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  switch (e.code) {
    case 'Space':
      if (state.currentSample) { e.preventDefault(); togglePlayPause(); }
      break;
    case 'ArrowRight':
      e.preventDefault(); navigateSample(1);
      break;
    case 'ArrowLeft':
      e.preventDefault(); navigateSample(-1);
      break;
    case 'KeyA':
      if (state.currentSample && samples[state.currentSample]?.status === 'pending') acceptVariation(state.currentSample);
      break;
    case 'KeyR':
      if (state.currentSample && samples[state.currentSample]?.status === 'pending') rejectVariation(state.currentSample);
      break;
    case 'KeyF':
      if (state.currentSample) toggleSampleFavorite(state.currentSample);
      break;
    case 'KeyD':
      if (state.currentSample) downloadSample(state.currentSample);
      break;
    case 'KeyL':
      toggleLoopPlayback();
      break;
    case 'Slash':
      if (e.shiftKey) { e.preventDefault(); toggleShortcutOverlay(); }
      break;
  }
});

// ==================== SEED DATA ====================
function seedDemoData() {
  if (Object.keys(samples).length > 0) return; // already has data

  const sessionId = uid('ses');
  const sessionId2 = uid('ses');
  const sessionId3 = uid('ses');

  const demoSamples = [
    { name: 'Dusty Kick 001', type: 'loop', status: 'accepted', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 002', type: 'loop', status: 'accepted', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 003', type: 'loop', status: 'rejected', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId, feedback: 'too_muddy' },
    { name: 'Dusty Kick 004', type: 'loop', status: 'pending', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 005', type: 'loop', status: 'pending', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Dusty Kick 006', type: 'loop', status: 'pending', bpm: 90, key: 'Cm', bars: 4, style: ['Dusty', 'Lo-fi'], duration: 5.33, session: sessionId },
    { name: 'Crispy Hat Loop', type: 'loop', status: 'accepted', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2 },
    { name: 'Crispy Hat Var 2', type: 'loop', status: 'accepted', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2 },
    { name: 'Crispy Hat Var 3', type: 'loop', status: 'rejected', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2, feedback: 'too_busy' },
    { name: 'Crispy Hat Var 4', type: 'loop', status: 'pending', bpm: 120, key: 'C', bars: 2, style: ['Crispy', 'Digital'], duration: 2.0, session: sessionId2 },
    { name: 'Warm Snare Hit', type: 'oneshot', status: 'accepted', tuning: 'C4', attack: 'Snappy', timbre: 'Warm', style: ['Analog', 'Punchy'], duration: 0.45, session: sessionId3 },
    { name: 'Warm Snare Var 2', type: 'oneshot', status: 'accepted', tuning: 'C4', attack: 'Snappy', timbre: 'Warm', style: ['Analog', 'Punchy'], duration: 0.52, session: sessionId3 },
    { name: 'Warm Snare Var 3', type: 'oneshot', status: 'pending', tuning: 'C4', attack: 'Punchy', timbre: 'Warm', style: ['Analog', 'Punchy'], duration: 0.38, session: sessionId3 },
    { name: 'Warm Snare Var 4', type: 'oneshot', status: 'pending', tuning: 'C4', attack: 'Soft', timbre: 'Dark', style: ['Analog'], duration: 0.61, session: sessionId3 },
    { name: 'Analog Clap 001', type: 'oneshot', status: 'accepted', tuning: 'D4', attack: 'Transient', timbre: 'Bright', style: ['Analog', 'Crispy'], duration: 0.33, session: sessionId3, fav: true },
    { name: 'Sub Bass Loop', type: 'loop', status: 'accepted', bpm: 140, key: 'F', bars: 8, style: ['Clean', 'Digital'], duration: 6.86, session: sessionId2, fav: true },
  ];

  const sessionMap = {};
  demoSamples.forEach((d, i) => {
    const id = uid('smp');
    const ts = Date.now() - (demoSamples.length - i) * 60000;
    samples[id] = {
      id, type: d.type, name: d.name, status: d.status,
      duration: d.duration,
      bpm: d.bpm || null, key: d.key || null, bars: d.bars || null,
      tuning: d.tuning || null, attack: d.attack || null, timbre: d.timbre || null,
      style: d.style || [], tags: d.style ? [...d.style] : [], notes: '',
      effects: { distortion: 0, reverb: 0, delay: 0, filterLP: 100, bitcrush: 0, saturation: 0 },
      generationSessionId: d.session,
      variationIndex: i, parentSampleId: null,
      modelVersion: 'ElevenLabs SFX v2',
      createdAt: ts,
      acceptedAt: d.status === 'accepted' ? ts + 1000 : null,
      favoritedAt: d.fav ? ts + 2000 : null,
      isFavorite: !!d.fav,
      isInLibrary: d.status === 'accepted',
      rejectionFeedback: d.feedback || null,
      waveformData: placeholderWaveform(80),
      projectId: 'proj_default',
    };
    if (!sessionMap[d.session]) sessionMap[d.session] = [];
    sessionMap[d.session].push(id);
    if (d.status === 'accepted' || d.status === 'rejected') {
      decisions.push({ sampleId: id, action: d.status === 'accepted' ? 'accept' : 'reject', feedback: d.feedback, timestamp: ts });
    }
  });

  // Create sessions
  sessions[sessionId] = {
    id: sessionId, type: 'loop',
    params: { type: 'loop', bpm: 90, key: 'Cm', bars: 4, styles: ['Dusty', 'Lo-fi'], varCount: 6, model: 'ElevenLabs SFX v2' },
    variationIds: sessionMap[sessionId] || [], acceptedCount: 2, rejectedCount: 1,
    createdAt: Date.now() - 900000, projectId: 'proj_default',
  };
  sessions[sessionId2] = {
    id: sessionId2, type: 'loop',
    params: { type: 'loop', bpm: 120, key: 'C', bars: 2, styles: ['Crispy', 'Digital'], varCount: 4, model: 'ElevenLabs SFX v2' },
    variationIds: sessionMap[sessionId2] || [], acceptedCount: 3, rejectedCount: 1,
    createdAt: Date.now() - 600000, projectId: 'proj_default',
  };
  sessions[sessionId3] = {
    id: sessionId3, type: 'oneshot',
    params: { type: 'oneshot', tuning: 'C4', attack: 'Snappy', timbre: 'Warm', styles: ['Analog', 'Punchy'], varCount: 5, model: 'ElevenLabs SFX v2' },
    variationIds: sessionMap[sessionId3] || [], acceptedCount: 3, rejectedCount: 0,
    createdAt: Date.now() - 300000, projectId: 'proj_default',
  };

  saveData();
}

// ==================== INIT ====================
loadData();
seedDemoData();
migrateToProjects();
renderProjectSwitcher();
navigateTo('dashboard');

// Pre-generate audio + real waveforms on first user interaction
document.addEventListener('click', function initAudioOnGesture() {
  document.removeEventListener('click', initAudioOnGesture);
  ensureAudioContext();
  // Generate buffers + real waveforms for all existing samples in background
  Object.keys(samples).forEach((sid, i) => {
    setTimeout(() => getAudioBuffer(sid), i * 50); // stagger to avoid blocking
  });
}, { once: true });
</script>
</body>
</html>
